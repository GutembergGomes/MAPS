<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HarvestManager - Gestão de Transporte Agrícola</title>
    <meta name="description" content="Sistema de gestão para transporte agrícola, frentes de colheita e motoristas">
    <meta name="theme-color" content="#5D5CDE">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f4f4fe',
                            100: '#e9e8fd',
                            200: '#d3d1fb',
                            300: '#b0adf7',
                            400: '#8987f0',
                            500: '#5D5CDE',
                            600: '#4e4dcb',
                            700: '#4240ac',
                            800: '#373689',
                            900: '#312f6f',
                            950: '#1e1c45',
                        },
                        harvest: {
                            green: '#2ecc71',
                            yellow: '#f1c40f',
                            orange: '#e67e22',
                            red: '#e74c3c',
                            blue: '#3498db',
                            purple: '#9b59b6'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                    },
                    transitionProperty: {
                        'height': 'height',
                        'spacing': 'margin, padding',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        html, body {
            height: 100%;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }
        
        /* Base styles */
        .map-container {
            height: 100%;
            min-height: 300px;
        }
        
        /* Card animations */
        .harvest-card {
            transition: all 0.3s ease;
            transform: translateZ(0); /* Force GPU acceleration */
        }
        .harvest-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Loading animations */
        .loader {
            border-top-color: #5D5CDE;
            animation: spinner 1s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Transition animations */
        .slide-enter {
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
        }
        .slide-enter-active {
            transform: translateX(0);
        }
        .slide-exit {
            transform: translateX(0);
            transition: transform 0.3s ease-out;
        }
        .slide-exit-active {
            transform: translateX(-100%);
        }
        
        /* Fade animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in forwards;
            will-change: opacity;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
            will-change: transform, opacity;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Staggered animations for lists */
        .stagger-item {
            opacity: 0;
            transform: translateY(10px);
            animation: staggerFadeIn 0.5s ease forwards;
        }
        @keyframes staggerFadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(93, 92, 222, 0.5);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(93, 92, 222, 0.7);
        }
        
        /* Toast notification */
        .toast {
            right: -100%;
            transition: all 0.5s ease-in-out;
            z-index: 9999;
            pointer-events: auto;
        }
        .toast.show {
            right: 1rem;
        }
        
        /* Pulse animation for recording */
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        
        /* Recording animation */
        .recording-indicator {
            position: relative;
        }
        .recording-indicator::before {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #e74c3c;
            top: 50%;
            left: -20px;
            transform: translateY(-50%);
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        /* Route status indicators */
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
        }
        .status-active {
            background-color: rgba(16, 185, 129, 0.1);
            color: rgb(5, 150, 105);
        }
        .status-paused {
            background-color: rgba(245, 158, 11, 0.1);
            color: rgb(217, 119, 6);
        }
        .status-completed {
            background-color: rgba(59, 130, 246, 0.1);
            color: rgb(29, 78, 216);
        }
        
        /* No maps fallback */
        .maps-fallback {
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 2rem;
            text-align: center;
            height: 100%;
        }
        .dark .maps-fallback {
            background-color: #2d3748;
        }
        
        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* Focus visible styles */
        :focus-visible {
            outline: 2px solid #5D5CDE;
            outline-offset: 2px;
        }
        
        /* Button focus states */
        button:focus {
            outline: none;
        }
        button:focus-visible {
            outline: 2px solid #5D5CDE;
            outline-offset: 2px;
        }
        
        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 120px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Skeleton loading animation */
        .skeleton {
            animation: skeleton-loading 1.5s linear infinite alternate;
            border-radius: 0.25rem;
        }
        
        @keyframes skeleton-loading {
            0% {
                background-color: rgba(226, 232, 240, 0.5);
            }
            100% {
                background-color: rgba(203, 213, 225, 0.8);
            }
        }
        
        .dark .skeleton {
            animation: skeleton-loading-dark 1.5s linear infinite alternate;
        }
        
        @keyframes skeleton-loading-dark {
            0% {
                background-color: rgba(55, 65, 81, 0.5);
            }
            100% {
                background-color: rgba(75, 85, 99, 0.8);
            }
        }
        
        /* Form styles */
        input[type="text"],
        input[type="tel"],
        input[type="number"],
        input[type="email"],
        select,
        textarea {
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        input[type="text"]:focus,
        input[type="tel"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        select:focus,
        textarea:focus {
            border-color: #5D5CDE;
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.25);
        }
        
        /* Dropdown menu animations */
        .dropdown-menu {
            transform-origin: top right;
            transition: transform 0.2s ease, opacity 0.2s ease;
            transform: scale(0.95);
            opacity: 0;
            pointer-events: none;
        }
        
        .dropdown-menu.active {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Modal animations */
        .modal-overlay {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
        }
        
        .modal-container {
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .modal-overlay.active .modal-container {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
            
            body {
                background-color: white !important;
                color: black !important;
            }
            
            .print-break {
                page-break-before: always;
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans transition-colors duration-300">
    <!-- Notifications System -->
    <div id="notifications-container" class="fixed top-0 right-0 z-50 p-4 space-y-4 pointer-events-none max-w-xs sm:max-w-sm md:max-w-md w-full"></div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast fixed top-4 z-50 max-w-md bg-white dark:bg-gray-800 shadow-lg rounded-lg p-4 flex items-center border-l-4 border-primary-500">
        <div class="text-primary-500 mr-3">
            <i class="fas fa-info-circle text-xl"></i>
        </div>
        <div>
            <h3 class="font-bold text-gray-800 dark:text-white">Notificação</h3>
            <p id="toast-message" class="text-sm text-gray-600 dark:text-gray-300"></p>
        </div>
        <button onclick="hideToast()" class="ml-auto text-gray-400 hover:text-gray-500" aria-label="Fechar notificação">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="hidden fixed bottom-4 left-4 z-50 bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center">
        <i class="fas fa-wifi-slash mr-2"></i>
        <span>Você está offline. Algumas funcionalidades podem estar limitadas.</span>
    </div>

    <!-- App Container -->
    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm">
            <div class="container mx-auto px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/svgs/solid/tractor.svg" alt="Logo" class="w-8 h-8 text-primary-500">
                        <h1 class="text-xl font-bold text-primary-500">HarvestManager</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="darkModeToggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500" aria-label="Alternar modo escuro">
                            <i id="darkModeIcon" class="fas fa-moon"></i>
                        </button>
                        <div class="relative" id="userMenuContainer">
                            <button id="userMenuButton" class="flex items-center space-x-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 rounded-full" aria-expanded="false" aria-haspopup="true" aria-label="Menu do usuário">
                                <div id="userAvatarInitial" class="w-8 h-8 rounded-full bg-primary-500 flex items-center justify-center text-white font-semibold">
                                    U
                                </div>
                                <span id="userDisplayName" class="hidden sm:inline-block">Usuário</span>
                                <i class="fas fa-chevron-down text-xs hidden sm:inline-block"></i>
                            </button>
                            <div id="userMenu" class="dropdown-menu absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 z-10 ring-1 ring-black ring-opacity-5">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem">Perfil</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem">Configurações</a>
                                <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                                <a href="#" onclick="logout()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem">Sair</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <div id="app-view" class="container mx-auto px-4 py-6">
                <!-- Loading Indicator -->
                <div id="loading-indicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 flex flex-col items-center">
                        <div class="loader w-12 h-12 border-4 border-gray-300 dark:border-gray-600 rounded-full"></div>
                        <p class="mt-3 text-gray-700 dark:text-gray-300" id="loading-text">Carregando...</p>
                    </div>
                </div>
                <!-- Views will be dynamically inserted here -->
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bg-white dark:bg-gray-800 shadow-lg border-t border-gray-200 dark:border-gray-700 no-print">
            <div class="container mx-auto px-4">
                <div class="flex justify-around items-center py-3">
                    <button id="nav-dashboard" onclick="showView('dashboard')" class="flex flex-col items-center space-y-1 text-gray-600 dark:text-gray-400 hover:text-primary-500 dark:hover:text-primary-400 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 rounded-md px-2" aria-label="Ir para página inicial">
                        <i class="fas fa-home text-xl"></i>
                        <span class="text-xs">Início</span>
                    </button>
                    <button id="nav-harvest-fronts" onclick="showView('harvest-fronts')" class="flex flex-col items-center space-y-1 text-gray-600 dark:text-gray-400 hover:text-primary-500 dark:hover:text-primary-400 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 rounded-md px-2" aria-label="Ir para frentes de colheita">
                        <i class="fas fa-tractor text-xl"></i>
                        <span class="text-xs">Frentes</span>
                    </button>
                    <button id="nav-routes" onclick="showView('routes')" class="flex flex-col items-center space-y-1 text-gray-600 dark:text-gray-400 hover:text-primary-500 dark:hover:text-primary-400 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 rounded-md px-2" aria-label="Ir para rotas">
                        <i class="fas fa-route text-xl"></i>
                        <span class="text-xs">Rotas</span>
                    </button>
                    <button id="nav-farms" onclick="showView('farms')" class="flex flex-col items-center space-y-1 text-gray-600 dark:text-gray-400 hover:text-primary-500 dark:hover:text-primary-400 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 rounded-md px-2" aria-label="Ir para fazendas">
                        <i class="fas fa-map-marked-alt text-xl"></i>
                        <span class="text-xs">Fazendas</span>
                    </button>
                    <button id="nav-driver" onclick="showView('driver')" class="flex flex-col items-center space-y-1 text-gray-600 dark:text-gray-400 hover:text-primary-500 dark:hover:text-primary-400 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 rounded-md px-2" aria-label="Ir para modo motorista">
                        <i class="fas fa-truck text-xl"></i>
                        <span class="text-xs">Motorista</span>
                    </button>
                    <button id="nav-reports" onclick="showView('reports')" class="flex flex-col items-center space-y-1 text-gray-600 dark:text-gray-400 hover:text-primary-500 dark:hover:text-primary-400 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 rounded-md px-2" aria-label="Ir para relatórios">
                        <i class="fas fa-chart-bar text-xl"></i>
                        <span class="text-xs">Relatórios</span>
                    </button>
                </div>
            </div>
        </nav>
    </div>

    <!-- Modal Template -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 modal-container" role="dialog" aria-modal="true">
            <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 id="modal-title" class="text-lg font-medium text-gray-900 dark:text-white">Modal Title</h3>
                <button id="modal-close" class="text-gray-400 hover:text-gray-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 rounded-md" aria-label="Fechar modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modal-content" class="p-4">
                <!-- Dynamic content will be inserted here -->
            </div>
            <div id="modal-footer" class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-3">
                <!-- Buttons will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // Global Application State and Configuration
        // ==========================================
        
        // Inicialização da Aplicação
        document.addEventListener('DOMContentLoaded', function() {
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                initAppAfterDependencies();
            }
        });
        
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
        
        // Check browser compatibility for essential features
        function checkCompatibility() {
            const issues = [];
            
            if (!navigator.geolocation) {
                issues.push('Geolocalização não disponível neste navegador');
            }
            
            if (!window.indexedDB) {
                issues.push('Armazenamento local não suportado neste navegador');
            }
            
            if (!('serviceWorker' in navigator)) {
                issues.push('Service Workers não suportados (funcionalidade offline limitada)');
            }
            
            if (issues.length > 0) {
                const message = `Problemas de compatibilidade detectados: ${issues.join(', ')}`;
                showToast(message, 'warning');
                console.warn(message);
                return false;
            }
            
            return true;
        }
        
        // Database setup with improved schema and indexing
        // Mudando nome do banco para garantir que inicie zerado (nova versão sem dados antigos)
        const db = new Dexie('HarvestManagerDB_Prod');
        db.version(2).stores({
            harvestFronts: '++id, name, status, createdAt, updatedAt',
            routes: '++id, frontId, startTime, status, createdAt, updatedAt, *tags',
            drivers: '++id, name, status, assignedFront, createdAt, updatedAt',
            farms: '++id, name, status, createdAt, updatedAt',
            settings: 'key',
            syncQueue: '++id, action, tableName, itemId, data, timestamp, retries, status'
        });
        
        // Add hooks for sync queue when we're back online
        db.on('ready', () => {
            // Try to process sync queue when app starts
            if (navigator.onLine) {
                if (typeof processSyncQueue === 'function') {
                    processSyncQueue();
                }
            }
        });
        
        // Add online/offline detection
        window.addEventListener('online', handleOnlineStatus);
        window.addEventListener('offline', handleOfflineStatus);
        
        function handleOnlineStatus() {
            document.getElementById('offline-indicator').classList.add('hidden');
            showToast('Conexão restaurada', 'success');
            
            // Try to process any pending actions
            if (typeof processSyncQueue === 'function') {
                processSyncQueue();
            }
        }
        
        function handleOfflineStatus() {
            document.getElementById('offline-indicator').classList.remove('hidden');
            showToast('Você está offline. Os dados serão sincronizados quando a conexão for restaurada.', 'warning');
        }
        

        
        // Simulated auth token retrieval - replace with actual implementation
        async function getAuthToken() {
            // In a real app, retrieve from secure storage or request from auth server
            return 'simulated-auth-token';
        }
        
        // Sync queue processing - Improved to sync with Firebase
        async function processSyncQueue() {
            if (!navigator.onLine) return;
            
            const queueItems = await db.syncQueue.orderBy('timestamp').toArray();
            if (queueItems.length === 0) return;
            
            console.log(`Processing ${queueItems.length} items in sync queue...`);
            
            // Check if Firebase is available
            if (!firebase.apps.length) return;
            
            const dbFirestore = firebase.firestore();
            const currentUser = firebase.auth().currentUser;
            
            if (!currentUser) {
                console.log('No user logged in, skipping sync');
                return;
            }
            
            for (const item of queueItems) {
                try {
                    // Skip if already processing
                    if (item.status === 'processing') continue;
                    
                    // Mark as processing
                    await db.syncQueue.update(item.id, { status: 'processing' });
                    
                    const collectionRef = dbFirestore
                        .collection('users')
                        .doc(currentUser.uid)
                        .collection(item.tableName);
                    
                    if (item.action === 'create' || item.action === 'update' || item.action === 'add') {
                        // For create/update, we write to Firestore
                        // Convert ID to string for Firestore document ID
                        const docId = item.itemId.toString();
                        await collectionRef.doc(docId).set({ ...item.data }, { merge: true });
                        console.log(`Synced ${item.action} for ${item.tableName}/${item.itemId} to Firebase`);
                    } else if (item.action === 'delete') {
                        // For delete, remove from Firestore
                        const docId = item.itemId.toString();
                        await collectionRef.doc(docId).delete();
                        console.log(`Synced delete for ${item.tableName}/${item.itemId} from Firebase`);
                    }
                    
                    // If successful, remove from queue
                    await db.syncQueue.delete(item.id);
                    
                } catch (error) {
                    console.error(`Sync error for item ${item.id}:`, error);
                    
                    // Increment retries or fail
                    if (item.retries >= 3) {
                        await db.syncQueue.update(item.id, { status: 'failed', error: error.message });
                    } else {
                        await db.syncQueue.update(item.id, { 
                            status: 'pending', 
                            retries: (item.retries || 0) + 1 
                        });
                    }
                }
            }
        }
        
        // Setup Firestore listener for real-time updates
        function setupFirestoreListeners() {
            if (!firebase.apps.length) return;
            
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return;
            
            const dbFirestore = firebase.firestore();
            const tables = ['harvestFronts', 'routes', 'drivers', 'farms'];
            
            tables.forEach(tableName => {
                dbFirestore.collection('users')
                    .doc(currentUser.uid)
                    .collection(tableName)
                    .onSnapshot(snapshot => {
                        snapshot.docChanges().forEach(async change => {
                            const data = change.doc.data();
                            const id = parseInt(change.doc.id);
                            
                            if (change.type === "added" || change.type === "modified") {
                                try {
                                    await db[tableName].put({ ...data, id });
                                    console.log(`Updated local ${tableName}/${id} from Firebase`);
                                } catch (e) {
                                    console.error(`Error updating local DB from Firebase:`, e);
                                }
                            } else if (change.type === "removed") {
                                try {
                                    await db[tableName].delete(id);
                                    console.log(`Deleted local ${tableName}/${id} from Firebase`);
                                } catch (e) {
                                    console.error(`Error deleting from local DB:`, e);
                                }
                            }
                        });
                    });
            });
        }

        // Add to sync queue for later processing
        async function addToSyncQueue(action, tableName, itemId, data) {
            try {
                await db.syncQueue.add({
                    action,
                    tableName,
                    itemId,
                    data,
                    timestamp: new Date().toISOString(),
                    status: 'pending',
                    retries: 0
                });
                console.log(`Added ${action} operation to sync queue for ${tableName} id ${itemId}`);
                if (navigator.onLine && firebase.apps.length && firebase.auth().currentUser) {
                    await processSyncQueue();
                }
            } catch (error) {
                console.error('Erro ao adicionar à fila de sincronização:', error);
            }
        }
        
        // Compress path data to reduce storage requirements
        function compressPathData(path) {
            if (!path || path.length === 0) return [];
            
            // Simple approach: reduce precision and remove redundant points
            const compressed = [];
            let lastPoint = null;
            const precisionFactor = 100000; // 5 decimal places precision
            
            for (const point of path) {
                // Round coordinates to reduce size
                const roundedPoint = {
                    lat: Math.round(point.lat * precisionFactor) / precisionFactor,
                    lng: Math.round(point.lng * precisionFactor) / precisionFactor,
                    timestamp: point.timestamp
                };
                
                // Only include speed and accuracy if they exist and are significant
                if (point.speed) roundedPoint.speed = Math.round(point.speed * 10) / 10;
                if (point.accuracy && point.accuracy > 1) roundedPoint.accuracy = Math.round(point.accuracy);
                
                // Skip points that are too close together (except first and last point)
                if (lastPoint && path.indexOf(point) !== path.length - 1) {
                    const distance = haversineDistance(
                        lastPoint.lat, lastPoint.lng,
                        roundedPoint.lat, roundedPoint.lng
                    );
                    
                    // Skip if less than 5 meters
                    if (distance < 0.005) {
                        continue;
                    }
                }
                
                compressed.push(roundedPoint);
                lastPoint = roundedPoint;
            }
            
            // For very large paths, consider more advanced compression using binary encoding
            if (compressed.length > 1000) {
                try {
                    // Convert to string
                    const jsonStr = JSON.stringify(compressed);
                    // Convert to Uint8Array
                    const uint8Array = new TextEncoder().encode(jsonStr);
                    // Compress with pako
                    const compressedData = pako.deflate(uint8Array);
                    // Convert to base64 for storage
                    const base64Str = btoa(String.fromCharCode.apply(null, compressedData));
                    
                    console.log(`Compressed ${compressed.length} points from ${jsonStr.length} to ${base64Str.length} bytes`);
                    
                    // Return special format indicating compression
                    return { _compressed: true, data: base64Str, count: compressed.length };
                } catch (e) {
                    console.error('Path compression failed:', e);
                    // Fall back to uncompressed data
                    return compressed;
                }
            }
            
            return compressed;
        }
        
        // Decompress path data when loading
        function decompressPathData(pathData) {
            if (!pathData) return [];
            
            // Check if data is compressed
            if (pathData._compressed && pathData.data) {
                try {
                    // Convert from base64
                    const compressedData = new Uint8Array(atob(pathData.data).split('').map(c => c.charCodeAt(0)));
                    // Decompress
                    const decompressedData = pako.inflate(compressedData);
                    // Convert to string
                    const jsonStr = new TextDecoder().decode(decompressedData);
                    // Parse JSON
                    return JSON.parse(jsonStr);
                } catch (e) {
                    console.error('Path decompression failed:', e);
                    return [];
                }
            }
            
            // Return as is if not compressed
            return pathData;
        }
        
        // Application State
        const AppState = {
            currentView: 'welcome',
            previousView: null,
            currentUser: { name: 'Usuário', email: null, role: 'leader' },
            viewHistory: [],
            navigationEnabled: true,
            
            // Mapping for active nav items
            navMapping: {
                'dashboard': 'nav-dashboard',
                'harvest-fronts': 'nav-harvest-fronts',
                'add-harvest-front': 'nav-harvest-fronts',
                'edit-harvest-front': 'nav-harvest-fronts',
                'routes': 'nav-routes',
                'record-route': 'nav-routes',
                'route-details': 'nav-routes',
                'driver': 'nav-driver',
                'drivers': 'nav-driver',
                'add-driver': 'nav-driver',
                'edit-driver': 'nav-driver',
                'reports': 'nav-reports'
            },
            
            // Update active nav item
            updateActiveNavItem() {
                // Remove active class from all nav items
                document.querySelectorAll('[id^="nav-"]').forEach(item => {
                    item.classList.remove('text-primary-500', 'dark:text-primary-400');
                    item.classList.add('text-gray-600', 'dark:text-gray-400');
                });
                
                // Add active class to current nav item
                const navId = this.navMapping[this.currentView];
                if (navId) {
                    const navItem = document.getElementById(navId);
                    if (navItem) {
                        navItem.classList.remove('text-gray-600', 'dark:text-gray-400');
                        navItem.classList.add('text-primary-500', 'dark:text-primary-400');
                    }
                }
            }
        };
        
        function isDriverRole(role) {
            return role === 'driver';
        }
        
        function isFullAccessRole(role) {
            return role === 'leader' || role === 'supervisor' || role === 'controller';
        }
        
        function applyRolePermissions() {
            const role = AppState.currentUser && AppState.currentUser.role ? AppState.currentUser.role : null;
            const navDashboard = document.getElementById('nav-dashboard');
            const navHarvestFronts = document.getElementById('nav-harvest-fronts');
            const navRoutes = document.getElementById('nav-routes');
            const navFarms = document.getElementById('nav-farms');
            const navDriver = document.getElementById('nav-driver');
            const navReports = document.getElementById('nav-reports');
            
            if (isDriverRole(role)) {
                if (navDashboard) navDashboard.style.display = 'none';
                if (navHarvestFronts) navHarvestFronts.style.display = 'none';
                if (navFarms) navFarms.style.display = 'none';
                if (navReports) navReports.style.display = 'none';
                if (navDriver) navDriver.style.display = 'flex';
                if (navRoutes) navRoutes.style.display = 'none';
            } else if (role) {
                if (navDashboard) navDashboard.style.display = 'flex';
                if (navHarvestFronts) navHarvestFronts.style.display = 'flex';
                if (navRoutes) navRoutes.style.display = 'flex';
                if (navFarms) navFarms.style.display = 'flex';
                if (navDriver) navDriver.style.display = 'flex';
                if (navReports) navReports.style.display = 'flex';
            }
        }
        
        // Route recording state with improved tracking
        let currentRecording = {
            frontId: null,
            name: "",
            description: "",
            path: [],
            recording: false,
            watchId: null,
            startTime: null,
            endTime: null,
            map: null,
            routePolyline: null,
            currentPositionMarker: null,
            accuracyCircle: null,
            suggestedRouteLayer: null,
            timer: null,
            paused: false,
            elapsedTime: 0,
            lastLocation: null,
            locationUpdateInterval: null,
            batteryStatus: null,
            tags: [],
            locationErrorTimeout: null,
            locationErrors: 0
        };
        
        // Navigation state with enhanced features
        let navigationState = {
            active: false,
            routeId: null,
            frontId: null,
            currentStep: 0,
            map: null,
            directionsRenderer: null,
            positionMarker: null,
            watchId: null,
            route: null,
            distanceToDestination: null,
            estimatedTimeToDestination: null,
            speedReports: [],
            nextWaypointIndex: 0,
            nextWaypointAlert: false,
            navigationStartTime: null,
            accuracyThreshold: 20, // meters
            locationErrorTimeout: null,
            locationErrors: 0
        };
        
        // Initialize database with sample data if empty
        async function initializeDatabase() {
            try {
                showLoading('Inicializando banco de dados...');
                
                // Sistema zerado conforme solicitado
                // Código de dados fictícios removido completamente
                
                hideLoading();
                return true;
            } catch (error) {
                console.error('Erro ao inicializar banco de dados:', error);
                showToast('Erro ao inicializar banco de dados. Alguns recursos podem não funcionar corretamente.', 'error');
                hideLoading();
                return false;
            }
        }

        // Firebase Configuration and Initialization
        let isRegistering = false;
        
        function initializeFirebase() {
            const firebaseConfig = {
                apiKey: "AIzaSyAYEGceGZo0HEKl23pc92Zds9VGMcpZofA",
                authDomain: "maps-313a2.firebaseapp.com",
                projectId: "maps-313a2",
                storageBucket: "maps-313a2.firebasestorage.app",
                messagingSenderId: "1090999289542",
                appId: "1:1090999289542:web:61b9c04e5de3bc769739c7",
                measurementId: "G-946JBPMLT6"
            };
            
            try {
                if (!firebase.apps.length) {
                    const app = firebase.initializeApp(firebaseConfig);
                    // Initialize Analytics if supported
                    if (firebase.analytics) {
                        firebase.analytics();
                    }
                    console.log('Firebase initialized');
                }
                
                firebase.auth().onAuthStateChanged(async (user) => {
                    const header = document.querySelector('header');
                    const nav = document.querySelector('nav');
                    
                    if (user) {
                        try {
                            const dbFirestore = firebase.firestore();
                            const userRef = dbFirestore.collection('users').doc(user.uid);
                            const snapshot = await userRef.get();
                            
                            let role = null;
                            let displayName = user.email || 'Usuário';
                            let needsRoleSelection = false;
                            
                            if (snapshot.exists) {
                                const data = snapshot.data() || {};
                                const hasRole = !!data.role;
                                const hasProfile =
                                    !!(data.name && data.matricula && data.usina);
                                
                                if (hasRole) {
                                    role = data.role;
                                }
                                
                                if (!hasRole || !hasProfile || data.profileCompleted === false) {
                                    needsRoleSelection = true;
                                }
                                
                                if (data.name) displayName = data.name;
                            } else {
                                await userRef.set({
                                    email: user.email || null,
                                    createdAt: new Date().toISOString()
                                }, { merge: true });
                                needsRoleSelection = true;
                            }
                            
                            AppState.currentUser = {
                                name: displayName,
                                email: user.email || null,
                                role: role
                            };
                            
                            updateUserHeader();
                            
                            if (needsRoleSelection || !role) {
                                if (header) header.style.display = 'none';
                                if (nav) nav.style.display = 'none';
                                showRoleSelectionModal();
                            } else {
                                applyRolePermissions();
                                if (header) header.style.display = 'block';
                                if (nav) nav.style.display = 'block';
                                if (isDriverRole(role)) {
                                    showView('driver', { replace: true });
                                } else {
                                    showView('dashboard', { replace: true });
                                }
                                setupFirestoreListeners();
                                processSyncQueue();
                                if (window.syncInterval) clearInterval(window.syncInterval);
                                window.syncInterval = setInterval(processSyncQueue, 30000);
                            }
                        } catch (e) {
                            console.error('Erro ao carregar perfil do usuário:', e);
                            if (header) header.style.display = 'none';
                            if (nav) nav.style.display = 'none';
                            renderLoginView();
                        }
                    } else {
                        console.log('User signed out');
                        if (header) header.style.display = 'none';
                        if (nav) nav.style.display = 'none';
                        
                        AppState.currentUser = { name: 'Usuário', email: null, role: 'leader' };
                        renderLoginView();
                    }
                });
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                if (error && (error.code === 'app/no-app' || (error.message || '').includes('apiKey'))) {
                    showToast('Configuração do Firebase pendente. Edite o arquivo index.html.', 'warning');
                } else {
                    showToast('Erro ao conectar com o servidor. Verifique sua conexão.', 'error');
                }
                renderLoginView();
            }
        }
        
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email-address').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            const errorMessage = document.getElementById('login-error-message');
            
            errorDiv.classList.add('hidden');
            showLoading(isRegistering ? 'Criando conta...' : 'Entrando...');
            
            try {
                if (isRegistering) {
                    await firebase.auth().createUserWithEmailAndPassword(email, password);
                    showToast('Conta criada com sucesso!', 'success');
                } else {
                    await firebase.auth().signInWithEmailAndPassword(email, password);
                    showToast('Login realizado com sucesso!', 'success');
                }
            } catch (error) {
                console.error('Auth error:', error);
                errorDiv.classList.remove('hidden');
                
                let msg = 'Erro ao autenticar.';
                if (error.code === 'auth/wrong-password') msg = 'Senha incorreta.';
                if (error.code === 'auth/user-not-found') msg = 'Usuário não encontrado.';
                if (error.code === 'auth/email-already-in-use') msg = 'Email já está em uso.';
                if (error.code === 'auth/weak-password') msg = 'A senha deve ter pelo menos 6 caracteres.';
                
                errorMessage.textContent = msg;
            } finally {
                hideLoading();
            }
        }
        
        async function handleGoogleLogin() {
            try {
                showLoading('Conectando com Google...');
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({ prompt: 'select_account' });
                
                const ua = (navigator.userAgent || '').toLowerCase();
                const isApp = ua.includes('hmapp/android');
                
                if (isApp) {
                    await firebase.auth().signInWithRedirect(provider);
                } else {
                    await firebase.auth().signInWithPopup(provider);
                }
                showToast('Login com Google realizado com sucesso!', 'success');
                // Navigation handled by onAuthStateChanged
            } catch (error) {
                console.error('Google Auth error:', error);
                let msg = 'Erro ao fazer login com Google.';
                if (error.code === 'auth/popup-closed-by-user') {
                    msg = 'Login cancelado pelo usuário.';
                } else if (error.code === 'auth/operation-not-allowed') {
                    msg = 'Login com Google não está habilitado no Firebase. Ative o provedor Google em Authentication > Sign-in method.';
                } else if (error.code === 'auth/unauthorized-domain') {
                    msg = 'Domínio não autorizado. Adicione gutemberggomes.github.io, localhost:8081 e 127.0.0.1 em Authentication > Settings > Authorized domains no Firebase.';
                } else if (error.code === 'auth/cancelled-popup-request') {
                    msg = 'Outra tentativa de login está em andamento. Tente novamente.';
                } else if (error.code === 'auth/popup-blocked') {
                    msg = 'Popup bloqueado pelo navegador. Libere popups para este site e tente novamente.';
                }
                showToast(msg, 'error');
            } finally {
                hideLoading();
            }
        }
        
        async function processGoogleRedirectResult() {
            try {
                const result = await firebase.auth().getRedirectResult();
                if (result && result.user) {
                    showToast('Login com Google realizado com sucesso!', 'success');
                }
            } catch (error) {
                console.error('Redirect auth error:', error);
                let msg = 'Erro ao finalizar login com Google via redirecionamento.';
                if (error.code === 'auth/unauthorized-domain') {
                    msg = 'Domínio não autorizado. Adicione gutemberggomes.github.io em Authorized domains no Firebase.';
                } else if (error.code === 'auth/user-cancelled') {
                    msg = 'Login cancelado. Tente novamente.';
                }
                showToast(msg, 'error');
            }
        }
        
        function toggleRegisterMode() {
            isRegistering = !isRegistering;
            const title = document.querySelector('#view-login h2');
            const subtitle = document.querySelector('#view-login p');
            const btnText = document.getElementById('authButtonText');
            const toggleLink = document.getElementById('toggleAuthMode');
            
            if (isRegistering) {
                title.textContent = 'Criar Conta';
                subtitle.textContent = 'Preencha os dados para se cadastrar';
                btnText.textContent = 'Cadastrar';
                toggleLink.textContent = 'Já tem uma conta? Entrar';
            } else {
                title.textContent = 'HarvestManager';
                subtitle.textContent = 'Faça login para acessar o sistema';
                btnText.textContent = 'Entrar';
                toggleLink.textContent = 'Criar nova conta';
            }
        }
        
        function logout() {
            firebase.auth().signOut().then(() => {
                showToast('Desconectado.', 'info');
                // renderLoginView() is called by onAuthStateChanged
            }).catch((error) => {
                console.error('Logout error:', error);
            });
        }
        
        // Generate a sample path for demo purposes with improved variation
        function generateSamplePath(lat, lng, points) {
            const path = [];
            
            // Create some randomness in the path shape
            const radiusX = 0.01 + Math.random() * 0.02;
            const radiusY = 0.01 + Math.random() * 0.02;
            const centerShiftX = (Math.random() * 0.01) - 0.005;
            const centerShiftY = (Math.random() * 0.01) - 0.005;
            
            for (let i = 0; i < points; i++) {
                // Create a more realistic path using sine wave variation
                const progress = i / (points - 1);
                const angle = progress * Math.PI * 2;
                
                // Add some randomness to make it look more natural
                const jitter = 0.001 * (Math.random() - 0.5);
                
                const pointLat = lat + Math.sin(angle) * radiusX + centerShiftX + jitter;
                const pointLng = lng + Math.cos(angle) * radiusY + centerShiftY + jitter;
                
                // Add accuracy variation based on terrain
                const accuracy = 5 + Math.random() * 15;
                
                // Add speed variation
                const speed = 20 + Math.random() * 15; // km/h
                
                path.push({
                    lat: pointLat,
                    lng: pointLng,
                    timestamp: new Date(Date.now() - (points - i) * 30000).toISOString(),
                    accuracy: accuracy,
                    speed: speed
                });
            }
            return path;
        }
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            processGoogleRedirectResult();
            
            // Check and set initial online status
            if (!navigator.onLine) {
                handleOfflineStatus();
            }
            
            // Setup dark mode before any UI is shown
            setupDarkModeToggle();
            setupUserMenu();
            
            // Wait for all dependencies to be ready
            initAppAfterDependencies();
        });
        
        async function initAppAfterDependencies() {
            try {
                // Check compatibility
                checkCompatibility();
                
                // Initialize database
                const dbInitialized = await initializeDatabase();
                
                // Setup keyboard shortcuts
                setupKeyboardShortcuts();
                
                // Setup service worker for PWA
                setupServiceWorker();
                
                // Note: View navigation is handled by Firebase Auth state in initializeFirebase()
            } catch (error) {
                console.error('Erro ao inicializar aplicativo:', error);
                showToast('Erro ao inicializar aplicativo. Por favor, recarregue a página.', 'error');
            }
        }
        
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Only process shortcuts when navigation is enabled
                if (!AppState.navigationEnabled) return;
                
                // Ctrl+/ shows help menu
                if (e.ctrlKey && e.key === '/') {
                    e.preventDefault();
                    showHelpModal();
                }
                
                // Alt+D goes to dashboard
                if (e.altKey && e.key === 'd') {
                    e.preventDefault();
                    showView('dashboard');
                }
                
                // Alt+F goes to harvest fronts
                if (e.altKey && e.key === 'f') {
                    e.preventDefault();
                    showView('harvest-fronts');
                }
                
                // Alt+R goes to routes
                if (e.altKey && e.key === 'r') {
                    e.preventDefault();
                    showView('routes');
                }
                
                // Alt+M goes to drivers
                if (e.altKey && e.key === 'm') {
                    e.preventDefault();
                    showView('driver');
                }
                
                // Alt+S goes to reports
                if (e.altKey && e.key === 's') {
                    e.preventDefault();
                    showView('reports');
                }
            });
        }
        
        function setupServiceWorker() {
            if ('serviceWorker' in navigator) {
                // Use explicit path relative to the HTML file
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            }
        }
        
        // Monitor battery status for critical levels
        async function monitorBatteryStatus() {
            if ('getBattery' in navigator) {
                try {
                    const battery = await navigator.getBattery();
                    
                    // Check battery level and warn if low and not charging
                    if (battery.level <= 0.15 && !battery.charging) {
                        showToast('Bateria baixa! Conecte o carregador para evitar perda de dados.', 'warning');
                        
                        // If extremely low, auto-save current data
                        if (battery.level <= 0.05 && currentRecording.recording) {
                            showToast('Bateria crítica! Salvando dados atuais...', 'error');
                            stopRecording();
                        }
                    }
                    
                    // Set up listeners
                    battery.addEventListener('levelchange', () => updateBatteryStatus(battery));
                    battery.addEventListener('chargingchange', () => updateBatteryStatus(battery));
                    
                    return battery;
                } catch (error) {
                    console.error('Error accessing battery info:', error);
                }
            }
            return null;
        }
        
        // ==========================================
        // Modal System
        // ==========================================
        
        function showModal(title, content, buttons = []) {
            const modalContainer = document.getElementById('modal-container');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalFooter = document.getElementById('modal-footer');
            
            // Set title
            modalTitle.textContent = title;
            
            // Clear and set content
            modalContent.innerHTML = '';
            if (typeof content === 'string') {
                modalContent.innerHTML = content;
            } else if (content instanceof HTMLElement) {
                modalContent.appendChild(content);
            }
            
            // Clear and add buttons
            modalFooter.innerHTML = '';
            buttons.forEach(button => {
                const btnElement = document.createElement('button');
                btnElement.className = `px-4 py-2 rounded-md ${button.primary ? 'bg-primary-500 hover:bg-primary-600 text-white' : 'border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'}`;
                btnElement.textContent = button.text;
                if (button.id) btnElement.id = button.id;
                btnElement.addEventListener('click', () => {
                    if (button.action) button.action();
                    if (button.closeModal !== false) hideModal();
                });
                modalFooter.appendChild(btnElement);
            });
            
            // Set up close button
            document.getElementById('modal-close').addEventListener('click', hideModal);
            
            // Show modal
            modalContainer.classList.remove('hidden');
            setTimeout(() => {
                modalContainer.classList.add('active');
            }, 10);
            
            // Handle escape key
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    hideModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
            
            // Focus trap
            const focusableElements = modalContainer.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];
            
            // Focus first element
            if (firstElement) firstElement.focus();
            
            // Handle tab key
            modalContainer.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    if (e.shiftKey && document.activeElement === firstElement) {
                        e.preventDefault();
                        lastElement.focus();
                    } else if (!e.shiftKey && document.activeElement === lastElement) {
                        e.preventDefault();
                        firstElement.focus();
                    }
                }
            });
        }
        
        function hideModal() {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.remove('active');
            setTimeout(() => {
                modalContainer.classList.add('hidden');
            }, 300);
        }
        
        // Confirmation modal helper
        function showConfirmModal(title, message, confirmAction, confirmText = 'Confirmar', cancelText = 'Cancelar', destructive = false) {
            const content = `<p class="text-gray-700 dark:text-gray-300">${message}</p>`;
            const buttons = [
                { 
                    text: cancelText, 
                    primary: false
                },
                { 
                    text: confirmText, 
                    primary: true, 
                    action: confirmAction,
                    className: destructive ? 'bg-red-500 hover:bg-red-600 text-white' : ''
                }
            ];
            
            if (destructive) {
                buttons[1].className = 'bg-red-500 hover:bg-red-600 text-white';
            }
            
            showModal(title, content, buttons);
        }
        
        function showHelpModal() {
            const content = `
                <div class="space-y-4">
                    <h4 class="font-medium text-lg mb-2">Atalhos de Teclado</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>Ctrl + /</div>
                        <div>Mostrar ajuda</div>
                        
                        <div>Alt + D</div>
                        <div>Dashboard</div>
                        
                        <div>Alt + F</div>
                        <div>Frentes de colheita</div>
                        
                        <div>Alt + R</div>
                        <div>Rotas</div>
                        
                        <div>Alt + M</div>
                        <div>Motoristas</div>
                        
                        <div>Alt + S</div>
                        <div>Relatórios</div>
                    </div>
                    
                    <h4 class="font-medium text-lg mt-4 mb-2">Sobre o HarvestManager</h4>
                    <p>Versão 2.1.0</p>
                    <p>HarvestManager é uma solução completa para gestão de frentes de colheita, registro de rotas e navegação para motoristas agrícolas.</p>
                </div>
            `;
            
            showModal('Ajuda e Informações', content, [
                { text: 'Fechar', primary: true }
            ]);
        }
        
        async function chooseUserRole(role) {
            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    showToast('Usuário não autenticado.', 'error');
                    return;
                }
                
                const nameInput = document.getElementById('profile-name');
                const matriculaInput = document.getElementById('profile-matricula');
                const cnhInput = document.getElementById('profile-cnh');
                const usinaSelect = document.getElementById('profile-usina');
                
                const name = nameInput ? nameInput.value.trim() : '';
                const matricula = matriculaInput ? matriculaInput.value.trim() : '';
                const cnh = cnhInput ? cnhInput.value.trim() : '';
                const usina = usinaSelect ? usinaSelect.value : '';
                
                if (!name || !matricula || !usina) {
                    showToast('Preencha nome, matrícula e usina para finalizar o cadastro.', 'error');
                    return;
                }
                
                const dbFirestore = firebase.firestore();
                await dbFirestore.collection('users').doc(user.uid).set({
                    role: role,
                    name: name,
                    matricula: matricula,
                    cnh: cnh || null,
                    usina: usina,
                    profileCompleted: true
                }, { merge: true });
                
                AppState.currentUser = AppState.currentUser || {};
                AppState.currentUser.role = role;
                AppState.currentUser.name = name;
                
                applyRolePermissions();
                updateUserHeader();
                
                const header = document.querySelector('header');
                const nav = document.querySelector('nav');
                if (header) header.style.display = 'block';
                if (nav) nav.style.display = 'block';
                
                hideModal();
                
                if (isDriverRole(role)) {
                    showView('driver', { replace: true });
                } else {
                    showView('dashboard', { replace: true });
                }
                
                setupFirestoreListeners();
                processSyncQueue();
                if (window.syncInterval) clearInterval(window.syncInterval);
                window.syncInterval = setInterval(processSyncQueue, 30000);
            } catch (error) {
                console.error('Erro ao salvar perfil do usuário:', error);
                showToast('Erro ao salvar perfil. Tente novamente.', 'error');
            }
        }
        
        function showRoleSelectionModal() {
            const content = `
                <div class="space-y-6">
                    <p class="text-gray-700 dark:text-gray-300 text-sm">
                        Finalize seu cadastro preenchendo os dados abaixo e selecione seu perfil de acesso.
                    </p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="profile-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nome completo</label>
                            <input id="profile-name" type="text" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm" placeholder="Digite seu nome" />
                        </div>
                        <div>
                            <label for="profile-matricula" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Matrícula</label>
                            <input id="profile-matricula" type="text" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm" placeholder="Código ou número de matrícula" />
                        </div>
                        <div>
                            <label for="profile-cnh" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">CNH (se tiver)</label>
                            <input id="profile-cnh" type="text" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm" placeholder="Número da CNH (opcional)" />
                        </div>
                        <div>
                            <label for="profile-usina" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Usina</label>
                            <select id="profile-usina" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
                                <option value="">Selecione a usina</option>
                                <option value="Usina Cambui">Usina Cambui</option>
                                <option value="Usina Floresta">Usina Floresta</option>
                                <option value="Usina Vale do Verdão">Usina Vale do Verdão</option>
                                <option value="Usina Panorama">Usina Panorama</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <p class="text-gray-700 dark:text-gray-300 text-sm mb-3">
                            Agora selecione o que você será dentro do sistema:
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="chooseUserRole('driver')" class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-lg flex items-center space-x-3 hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-gray-700 transition">
                                <div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900 flex items-center justify-center text-primary-600 dark:text-primary-300">
                                    <i class="fas fa-truck"></i>
                                </div>
                                <div class="text-left">
                                    <div class="font-semibold text-gray-900 dark:text-white">Motorista</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">Apenas Modo Motorista e rotas disponíveis.</div>
                                </div>
                            </button>
                            <button onclick="chooseUserRole('controller')" class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-lg flex items-center space-x-3 hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-gray-700 transition">
                                <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-blue-600 dark:text-blue-300">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                                <div class="text-left">
                                    <div class="font-semibold text-gray-900 dark:text-white">Controle</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">Acesso completo às informações e relatórios.</div>
                                </div>
                            </button>
                            <button onclick="chooseUserRole('leader')" class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-lg flex items-center space-x-3 hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-gray-700 transition">
                                <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-600 dark:text-green-300">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                                <div class="text-left">
                                    <div class="font-semibold text-gray-900 dark:text-white">Líder</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">Configuração e gestão geral do sistema.</div>
                                </div>
                            </button>
                            <button onclick="chooseUserRole('supervisor')" class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-lg flex items-center space-x-3 hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-gray-700 transition">
                                <div class="w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center text-purple-600 dark:text-purple-300">
                                    <i class="fas fa-user-check"></i>
                                </div>
                                <div class="text-left">
                                    <div class="font-semibold text-gray-900 dark:text-white">Supervisor</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">Acesso completo para acompanhamento das operações.</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('Finalize seu cadastro', content, []);
        }
        
        // ==========================================
        // Navigation System
        // ==========================================
        
        // View management with history support
        function showView(viewName, options = {}) {
            const role = AppState.currentUser && AppState.currentUser.role ? AppState.currentUser.role : 'leader';
            if (role === 'driver') {
                const allowedViews = ['driver'];
                if (!allowedViews.includes(viewName)) {
                    showToast('Seu perfil de motorista permite acessar apenas as rotas.', 'warning');
                    return showView('driver', { replace: true, noAnimation: true });
                }
            }
            
            showLoading(`Carregando ${getViewTitle(viewName)}...`);
            
            // Store current view in history if not replacing
            if (!options.replace && AppState.currentView) {
                AppState.viewHistory.push(AppState.currentView);
            }
            
            // Store previous view for transitions
            AppState.previousView = AppState.currentView;
            AppState.currentView = viewName;
            
            // Update active navigation item
            AppState.updateActiveNavItem();
            
            // Small delay to ensure loading is shown
            setTimeout(async () => {
                try {
                    const appView = document.getElementById('app-view');
                    
                    // Store any parameters in dataset
                    if (options.params) {
                        Object.keys(options.params).forEach(key => {
                            appView.dataset[key] = options.params[key];
                        });
                    }
                    
                    // Add slide animation class if transitioning
                    if (AppState.previousView && !options.noAnimation) {
                        appView.classList.add('fade-in');
                        setTimeout(() => {
                            appView.classList.remove('fade-in');
                        }, 500);
                    }
                    
                    // Clear current view
                    appView.innerHTML = '';
                    
                    // Render the requested view
                    switch(viewName) {
                        case 'welcome':
                            renderWelcomeView();
                            break;
                        case 'dashboard':
                            await renderDashboardView();
                            break;
                        case 'harvest-fronts':
                            await renderHarvestFrontsView();
                            break;
                        case 'add-harvest-front':
                            renderAddHarvestFrontView();
                            break;
                        case 'edit-harvest-front':
                            await renderEditHarvestFrontView(appView.dataset.frontId);
                            break;
                        case 'routes':
                            await renderRoutesView();
                            break;
                        case 'farms':
                            await renderFarmsView();
                            break;
                        case 'add-farm':
                            await renderAddFarmView();
                            break;
                        case 'record-route':
                            await renderRecordRouteView(appView.dataset.frontId);
                            break;
                        case 'route-details':
                            await renderRouteDetailsView(appView.dataset.frontId, appView.dataset.routeId);
                            break;
                        case 'driver':
                            await renderDriverView();
                            break;
                        case 'drivers':
                            await renderDriversView();
                            break;
                        case 'add-driver':
                            await renderAddDriverView();
                            break;
                        case 'edit-driver':
                            await renderEditDriverView(appView.dataset.driverId);
                            break;
                        case 'reports':
                            await renderReportsView();
                            break;
                        default:
                            await renderDashboardView();
                            AppState.currentView = 'dashboard';
                    }
                    
                    hideLoading();
                    
                    // Scroll to top of view
                    window.scrollTo(0, 0);
                    
                } catch (error) {
                    console.error(`Erro ao renderizar view '${viewName}':`, error);
                    showToast(`Erro ao carregar a página: ${error.message}`, 'error');
                    hideLoading();
                    
                    // Fallback to dashboard on error
                    if (viewName !== 'dashboard') {
                        showView('dashboard', { replace: true });
                    }
                }
            }, 100);
        }
        
        function goBack() {
            if (AppState.viewHistory.length > 0) {
                const previousView = AppState.viewHistory.pop();
                showView(previousView, { replace: true });
            } else {
                showView('dashboard', { replace: true });
            }
        }
        
        function getViewTitle(viewName) {
            const titles = {
                'welcome': 'Boas-vindas',
                'dashboard': 'Painel',
                'harvest-fronts': 'Frentes de Colheita',
                'add-harvest-front': 'Nova Frente',
                'edit-harvest-front': 'Editar Frente',
                'routes': 'Rotas',
                'farms': 'Fazendas',
                'add-farm': 'Cadastrar Fazenda',
                'record-route': 'Registrar Rota',
                'route-details': 'Detalhes da Rota',
                'driver': 'Modo Motorista',
                'drivers': 'Motoristas',
                'add-driver': 'Novo Motorista',
                'edit-driver': 'Editar Motorista',
                'reports': 'Relatórios'
            };
            
            return titles[viewName] || 'Página';
        }
        
        // ==========================================
        // View Renderers
        // ==========================================
        
        // Login View Renderer
        function renderLoginView() {
            const appView = document.getElementById('app-view');
            
            // Hide navbar for login screen
            const header = document.querySelector('header');
            if (header) header.style.display = 'none';
            
            const nav = document.querySelector('nav');
            if (nav) nav.style.display = 'none';
            
            appView.innerHTML = `
                <div id="view-login" class="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 py-12 px-4 sm:px-6 lg:px-8">
                    <div class="max-w-md w-full space-y-8 bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg">
                        <div>
                            <div class="mx-auto h-16 w-16 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center">
                                <i class="fas fa-tractor text-3xl text-primary-600 dark:text-primary-400"></i>
                            </div>
                            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900 dark:text-white">
                                HarvestManager
                            </h2>
                            <p class="mt-2 text-center text-sm text-gray-600 dark:text-gray-400">
                                Faça login para acessar o sistema
                            </p>
                        </div>
                        <form class="mt-8 space-y-6" id="loginForm" onsubmit="handleLogin(event)">
                            <div class="rounded-md shadow-sm -space-y-px">
                                <div class="mb-4">
                                    <label for="email-address" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                                    <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-lg relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 text-gray-900 dark:text-white dark:bg-gray-700 focus:outline-none focus:ring-primary-500 focus:border-primary-500 focus:z-10 sm:text-sm" placeholder="seu@email.com">
                                </div>
                                <div>
                                    <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Senha</label>
                                    <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-lg relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 text-gray-900 dark:text-white dark:bg-gray-700 focus:outline-none focus:ring-primary-500 focus:border-primary-500 focus:z-10 sm:text-sm" placeholder="********">
                                </div>
                            </div>

                            <div class="flex items-center justify-between">
                                <div class="text-sm">
                                    <a href="#" onclick="toggleRegisterMode()" id="toggleAuthMode" class="font-medium text-primary-600 hover:text-primary-500 dark:text-primary-400">
                                        Criar nova conta
                                    </a>
                                </div>
                            </div>

                            <div>
                                <button type="submit" id="authButton" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200">
                                    <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                                        <i class="fas fa-sign-in-alt group-hover:text-primary-100"></i>
                                    </span>
                                    <span id="authButtonText">Entrar</span>
                                </button>
                            </div>
                        </form>
                        
                        <div class="mt-6">
                            <div class="relative">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-2 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400">Ou continue com</span>
                                </div>
                            </div>

                            <div class="mt-6">
                                <button onclick="handleGoogleLogin()" type="button" class="w-full flex justify-center items-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200">
                                    <img class="h-5 w-5 mr-2" src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google">
                                    <span>Google</span>
                                </button>
                            </div>
                        </div>
                        
                        <div id="login-error" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                            <span class="block sm:inline" id="login-error-message"></span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderWelcomeView() {
            // Se não estiver logado, redireciona para login
            if (!firebase.auth().currentUser) {
                renderLoginView();
                return;
            }
            
            const appView = document.getElementById('app-view');
            appView.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-[70vh] space-y-8 fade-in-up">
                    <div class="text-center">
                        <div class="flex justify-center mb-6">
                            <div class="w-24 h-24 bg-primary-500 text-white rounded-full flex items-center justify-center shadow-lg">
                                <i class="fas fa-tractor text-4xl"></i>
                            </div>
                        </div>
                        <h1 class="text-3xl font-bold text-primary-500 mb-2">Bem-vindo ao HarvestManager</h1>
                        <p class="text-gray-600 dark:text-gray-400 max-w-md mx-auto">
                            Solução completa para gestão de frentes de colheita, registro de rotas e navegação para motoristas agrícolas.
                        </p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-3xl">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 flex items-center space-x-4 hover:shadow-lg transition-shadow stagger-item" style="animation-delay: 100ms;">
                            <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-blue-500 dark:text-blue-300">
                                <i class="fas fa-tractor"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold">Frentes de Colheita</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Gerencie suas equipes e áreas de colheita</p>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 flex items-center space-x-4 hover:shadow-lg transition-shadow stagger-item" style="animation-delay: 200ms;">
                            <div class="w-12 h-12 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-500 dark:text-green-300">
                                <i class="fas fa-route"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold">Registro de Rotas</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Grave e acompanhe trajetos com precisão</p>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 flex items-center space-x-4 hover:shadow-lg transition-shadow stagger-item" style="animation-delay: 300ms;">
                            <div class="w-12 h-12 rounded-full bg-amber-100 dark:bg-amber-900 flex items-center justify-center text-amber-500 dark:text-amber-300">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold">Gestão de Motoristas</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Atribua motoristas às frentes de trabalho</p>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 flex items-center space-x-4 hover:shadow-lg transition-shadow stagger-item" style="animation-delay: 400ms;">
                            <div class="w-12 h-12 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center text-purple-500 dark:text-purple-300">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold">Relatórios</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Analise dados de produtividade e eficiência</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stagger-item" style="animation-delay: 500ms;">
                        <button onclick="startApp()" class="px-8 py-3 bg-primary-500 hover:bg-primary-600 text-white rounded-lg shadow-md transition-all font-medium focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                            Começar Agora
                        </button>
                    </div>
                    
                    <div class="text-center text-sm text-gray-500 dark:text-gray-400 mt-8 stagger-item" style="animation-delay: 600ms;">
                        <p>Versão 2.1.0</p>
                    </div>
                </div>
            `;
        }
        
        async function renderDashboardView() {
            const appView = document.getElementById('app-view');
            
            try {
                // Get data from database
                const harvestFronts = await db.harvestFronts.toArray();
                const routes = await db.routes.toArray();
                const drivers = await db.drivers.toArray();
                
                // Process route paths for any that might be compressed
                routes.forEach(route => {
                    if (route.path && route.path._compressed) {
                        route.path = decompressPathData(route.path);
                    }
                });
                
                // Calculate stats
                const activeFronts = harvestFronts.filter(front => front.status === 'active').length;
                const activeDrivers = drivers.filter(driver => driver.status === 'active').length;
                const completedRoutes = routes.filter(route => route.status === 'completed').length;
                const activeRoutes = routes.filter(route => route.status === 'active').length;
                const totalDistance = routes.reduce((sum, route) => sum + (route.distance || 0), 0);
                
                // Calculate recent stats
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStart = today.toISOString();
                
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);
                const weekStart = weekAgo.toISOString();
                
                const routesThisWeek = routes.filter(route => route.createdAt >= weekStart);
                const routesToday = routes.filter(route => route.createdAt >= todayStart);
                
                // Get daily distance data for the chart
                const dailyData = getDailyDistanceData(routes);
                
                appView.innerHTML = `
                    <div class="fade-in">
                        <div class="flex flex-wrap items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold">Dashboard</h2>
                            <div class="flex space-x-2">
                                <button onclick="refreshDashboard()" class="flex items-center px-3 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg text-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary-500">
                                    <i class="fas fa-sync-alt mr-2"></i>
                                    Atualizar
                                </button>
                                <button onclick="printDashboard()" class="flex items-center px-3 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg text-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary-500">
                                    <i class="fas fa-print mr-2"></i>
                                    Imprimir
                                </button>
                            </div>
                        </div>
                        
                        <!-- Quick Stats Cards -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 transition-transform hover:scale-105">
                                <div class="flex items-center">
                                    <div class="rounded-full bg-green-100 dark:bg-green-900 p-3 mr-4">
                                        <i class="fas fa-tractor text-green-500 dark:text-green-300"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Frentes Ativas</p>
                                        <h3 class="text-2xl font-bold">${activeFronts}/${harvestFronts.length}</h3>
                                    </div>
                                </div>
                                <div class="mt-3 text-xs text-gray-500">
                                    <span class="${activeFronts > 0 ? 'text-green-500' : 'text-red-500'}">
                                        <i class="fas ${activeFronts > 0 ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                                        ${((activeFronts / Math.max(harvestFronts.length, 1)) * 100).toFixed()}%
                                    </span>
                                    taxa de atividade
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 transition-transform hover:scale-105">
                                <div class="flex items-center">
                                    <div class="rounded-full bg-blue-100 dark:bg-blue-900 p-3 mr-4">
                                        <i class="fas fa-route text-blue-500 dark:text-blue-300"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Rotas Registradas</p>
                                        <h3 class="text-2xl font-bold">${completedRoutes}<span class="text-sm text-gray-500 ml-1">+${activeRoutes} ativas</span></h3>
                                    </div>
                                </div>
                                <div class="mt-3 text-xs text-gray-500">
                                    <span class="text-blue-500">
                                        <i class="fas fa-plus"></i>
                                        ${routesThisWeek.length}
                                    </span>
                                    nos últimos 7 dias
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 transition-transform hover:scale-105">
                                <div class="flex items-center">
                                    <div class="rounded-full bg-purple-100 dark:bg-purple-900 p-3 mr-4">
                                        <i class="fas fa-truck text-purple-500 dark:text-purple-300"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Motoristas Ativos</p>
                                        <h3 class="text-2xl font-bold">${activeDrivers}/${drivers.length}</h3>
                                    </div>
                                </div>
                                <div class="mt-3 text-xs text-gray-500">
                                    <span class="${activeDrivers > drivers.length/2 ? 'text-green-500' : 'text-yellow-500'}">
                                        <i class="fas ${activeDrivers > drivers.length/2 ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                                        ${((activeDrivers / Math.max(drivers.length, 1)) * 100).toFixed()}%
                                    </span>
                                    da equipe disponível
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 transition-transform hover:scale-105">
                                <div class="flex items-center">
                                    <div class="rounded-full bg-amber-100 dark:bg-amber-900 p-3 mr-4">
                                        <i class="fas fa-road text-amber-500 dark:text-amber-300"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Distância Total</p>
                                        <h3 class="text-2xl font-bold">${totalDistance.toFixed(1)} <span class="text-sm">km</span></h3>
                                    </div>
                                </div>
                                <div class="mt-3 text-xs text-gray-500">
                                    <span class="text-amber-500">
                                        <i class="fas fa-tachometer-alt"></i>
                                        ${(totalDistance / Math.max(completedRoutes, 1)).toFixed(1)}
                                    </span>
                                    km por rota em média
                                </div>
                            </div>
                        </div>
                        
                        <!-- Operations Map and Recent Activity -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                                    <h3 class="font-semibold">Mapa de Operações</h3>
                                    <button onclick="centerMapOnAllOperations()" class="text-sm text-primary-500 hover:text-primary-600 flex items-center focus:outline-none focus:underline">
                                        <i class="fas fa-expand-alt mr-1"></i> Visualizar tudo
                                    </button>
                                </div>
                                <div id="operations-map" class="map-container rounded-b-lg" style="height: 400px;"></div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                                    <h3 class="font-semibold">Atividade Recente</h3>
                                    <a href="#" onclick="showView('routes')" class="text-sm text-primary-500 hover:text-primary-600 focus:outline-none focus:underline">
                                        Ver todas as rotas
                                    </a>
                                </div>
                                <div class="p-4">
                                    <div class="space-y-4">
                                        ${routes.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                                            .slice(0, 4)
                                            .map((route, index) => {
                                                const front = harvestFronts.find(f => f.id === route.frontId);
                                                const date = new Date(route.updatedAt);
                                                
                                                return `
                                                    <div class="flex items-start stagger-item" style="animation-delay: ${index * 100}ms">
                                                        <div class="mr-3 mt-1">
                                                            <div class="w-8 h-8 rounded-full flex items-center justify-center ${route.status === 'completed' ? 'bg-blue-100 text-blue-500 dark:bg-blue-900 dark:text-blue-300' : 'bg-green-100 text-green-500 dark:bg-green-900 dark:text-green-300'}">
                                                                <i class="fas fa-${route.status === 'completed' ? 'check-circle' : 'route'}"></i>
                                                            </div>
                                                        </div>
                                                        <div class="flex-1">
                                                            <div class="flex justify-between items-start">
                                                                <h4 class="font-medium">${route.name || `Rota #${route.id}`}</h4>
                                                                <span class="text-xs text-gray-500">${formatTimeAgo(route.updatedAt)}</span>
                                                            </div>
                                                            <p class="text-sm text-gray-500 dark:text-gray-400">${front?.name || 'Frente desconhecida'} • ${route.distance ? route.distance.toFixed(1) + ' km' : 'Distância não registrada'}</p>
                                                            <div class="flex mt-1">
                                                                ${route.tags ? route.tags.map(tag => `
                                                                    <span class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-0.5 rounded-full mr-1">${tag}</span>
                                                                `).join('') : ''}
                                                            </div>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        ${routes.length === 0 ? `
                                            <div class="text-center py-6 text-gray-500 dark:text-gray-400">
                                                <p>Nenhuma atividade registrada</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Distance Chart and Status -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-6">
                            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                                <h3 class="font-semibold">Distância Diária (Últimos 7 dias)</h3>
                            </div>
                            <div class="p-4">
                                <canvas id="distanceChart" height="200"></canvas>
                            </div>
                        </div>
                        
                        <!-- Quick Access Sections -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                                    <h3 class="font-semibold">Frentes de Colheita Recentes</h3>
                                    <button onclick="showView('harvest-fronts')" class="text-primary-500 hover:text-primary-600 text-sm font-medium focus:outline-none focus:underline">
                                        Ver Todas
                                    </button>
                                </div>
                                <div class="p-4">
                                    ${harvestFronts.length > 0 ? 
                                        harvestFronts
                                            .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                                            .slice(0, 3)
                                            .map((front, index) => `
                                                <div class="flex items-center p-3 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg mb-2 stagger-item" style="animation-delay: ${index * 100}ms">
                                                    <div class="w-3 h-3 rounded-full mr-3" style="background-color: ${front.color}"></div>
                                                    <div class="flex-1">
                                                        <h4 class="font-medium">${front.name}</h4>
                                                        <p class="text-sm text-gray-500 dark:text-gray-400">${front.location}</p>
                                                    </div>
                                                    <span class="text-xs px-2 py-1 rounded-full ${front.status === 'active' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'}">
                                                        ${front.status === 'active' ? 'Ativa' : 'Inativa'}
                                                    </span>
                                                </div>
                                            `).join('') : 
                                        `<div class="text-center py-6 text-gray-500 dark:text-gray-400">
                                            <p>Nenhuma frente de colheita cadastrada</p>
                                            <button onclick="showView('add-harvest-front')" class="mt-2 text-primary-500 hover:text-primary-600 focus:outline-none focus:underline">
                                                Adicionar Frente de Colheita
                                            </button>
                                        </div>`
                                    }
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                                    <h3 class="font-semibold">Motoristas Ativos</h3>
                                    <button onclick="showView('drivers')" class="text-primary-500 hover:text-primary-600 text-sm font-medium focus:outline-none focus:underline">
                                        Ver Todos
                                    </button>
                                </div>
                                <div class="p-4">
                                    ${drivers.length > 0 ? 
                                        drivers
                                            .filter(driver => driver.status === 'active')
                                            .slice(0, 3)
                                            .map((driver, index) => {
                                                const front = harvestFronts.find(f => f.id === driver.assignedFront);
                                                return `
                                                    <div class="flex items-center p-3 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg mb-2 stagger-item" style="animation-delay: ${index * 100}ms">
                                                        <div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900 text-primary-500 dark:text-primary-300 mr-3 flex items-center justify-center">
                                                            <i class="fas fa-user"></i>
                                                        </div>
                                                        <div class="flex-1">
                                                            <h4 class="font-medium">${driver.name}</h4>
                                                            <p class="text-sm text-gray-500 dark:text-gray-400">${front?.name || 'Nenhuma frente atribuída'}</p>
                                                        </div>
                                                        <span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                                            Ativo
                                                        </span>
                                                    </div>
                                                `;
                                            }).join('') : 
                                        `<div class="text-center py-6 text-gray-500 dark:text-gray-400">
                                            <p>Nenhum motorista cadastrado</p>
                                            <button onclick="showView('add-driver')" class="mt-2 text-primary-500 hover:text-primary-600 focus:outline-none focus:underline">
                                                Adicionar Motorista
                                            </button>
                                        </div>`
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="mt-8">
                            <h3 class="text-lg font-medium mb-4">Ações Rápidas</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <button onclick="showView('add-harvest-front')" class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 flex flex-col items-center justify-center text-center hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                    <div class="w-12 h-12 rounded-full bg-primary-100 dark:bg-primary-900 flex items-center justify-center text-primary-500 dark:text-primary-300 mb-2">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <span class="text-sm font-medium">Nova Frente</span>
                                </button>
                                
                                <button onclick="showHarvestFrontsForRouteRecording()" class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 flex flex-col items-center justify-center text-center hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                    <div class="w-12 h-12 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-500 dark:text-green-300 mb-2">
                                        <i class="fas fa-route"></i>
                                    </div>
                                    <span class="text-sm font-medium">Registrar Rota</span>
                                </button>
                                
                                <button onclick="showView('add-driver')" class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 flex flex-col items-center justify-center text-center hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                    <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-blue-500 dark:text-blue-300 mb-2">
                                        <i class="fas fa-user-plus"></i>
                                    </div>
                                    <span class="text-sm font-medium">Novo Motorista</span>
                                </button>
                                
                                <button onclick="showView('reports')" class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 flex flex-col items-center justify-center text-center hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                    <div class="w-12 h-12 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center text-purple-500 dark:text-purple-300 mb-2">
                                        <i class="fas fa-chart-bar"></i>
                                    </div>
                                    <span class="text-sm font-medium">Ver Relatórios</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Check for failed sync items -->
                        <div id="sync-status-container" class="mt-8 hidden">
                            <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-800 text-yellow-800 dark:text-yellow-200 p-4">
                                <div class="flex">
                                    <i class="fas fa-exclamation-triangle mt-1 mr-2"></i>
                                    <div>
                                        <p class="font-medium">Problemas de sincronização</p>
                                        <p class="text-sm mt-1" id="sync-status-message">Existem itens pendentes de sincronização.</p>
                                        <button onclick="retryFailedSyncs()" class="mt-2 text-sm px-3 py-1 bg-yellow-200 dark:bg-yellow-700 rounded hover:bg-yellow-300 dark:hover:bg-yellow-600 transition-colors">
                                            Tentar sincronizar novamente
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Check for failed sync items
                checkSyncStatus();
                
                // Initialize operations map
                setTimeout(() => {
                    initOperationsMap();
                }, 100);
                
                // Initialize distance chart
                setTimeout(() => {
                    initDistanceChart(dailyData);
                }, 100);
                
            } catch (error) {
                console.error('Erro ao renderizar dashboard:', error);
                appView.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 text-center">
                        <div class="w-16 h-16 bg-red-100 dark:bg-red-900 mx-auto rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-exclamation-triangle text-red-500 dark:text-red-300 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-medium mb-2">Erro ao carregar dados</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-4">${error.message || 'Não foi possível carregar os dados do dashboard'}</p>
                        <button onclick="showView('dashboard')" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                            Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }
        
        // Check for failed sync items and show notification if needed
        async function checkSyncStatus() {
            try {
                const failedItems = await db.syncQueue.where('status').equals('failed').count();
                const pendingItems = await db.syncQueue.where('status').equals('pending').count();
                
                if (failedItems > 0 || pendingItems > 0) {
                    const container = document.getElementById('sync-status-container');
                    const message = document.getElementById('sync-status-message');
                    
                    if (container && message) {
                        container.classList.remove('hidden');
                        
                        if (failedItems > 0) {
                            message.textContent = `${failedItems} item(s) não puderam ser sincronizados com o servidor.`;
                        } else {
                            message.textContent = `${pendingItems} item(s) aguardando sincronização.`;
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar status de sincronização:', error);
            }
        }
        
        // Retry failed sync items
        async function retryFailedSyncs() {
            try {
                showLoading('Tentando sincronizar itens...');
                
                // Reset failed items to pending
                await db.syncQueue.where('status').equals('failed').modify({ 
                    status: 'pending',
                    lastAttempt: new Date().toISOString()
                });
                
                // Process pending items
                await processOfflineActions();
                
                hideLoading();
                
                // Refresh dashboard
                showView('dashboard', { replace: true });
                
            } catch (error) {
                console.error('Erro ao tentar sincronizar itens:', error);
                hideLoading();
                showToast('Erro ao tentar sincronizar: ' + error.message, 'error');
            }
        }
        
        function getDailyDistanceData(routes) {
            // Get data for the last 7 days
            const data = [];
            const labels = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);
                
                const nextDay = new Date(date);
                nextDay.setDate(nextDay.getDate() + 1);
                
                const dayRoutes = routes.filter(route => {
                    const routeDate = new Date(route.startTime);
                    return routeDate >= date && routeDate < nextDay;
                });
                
                const dayDistance = dayRoutes.reduce((sum, route) => sum + (route.distance || 0), 0);
                
                data.push(dayDistance.toFixed(1));
                labels.push(date.toLocaleDateString('pt-BR', { weekday: 'short', day: 'numeric' }));
            }
            
            return { data, labels };
        }
        
        function initDistanceChart(dailyData) {
            const ctx = document.getElementById('distanceChart');
            if (!ctx) return;
            
            // Detect dark mode for chart colors
            const isDarkMode = document.documentElement.classList.contains('dark');
            
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dailyData.labels,
                    datasets: [{
                        label: 'Distância (km)',
                        data: dailyData.data,
                        backgroundColor: 'rgba(93, 92, 222, 0.5)',
                        borderColor: 'rgba(93, 92, 222, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: isDarkMode ? '#e5e7eb' : '#374151'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} km`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDarkMode ? '#e5e7eb' : '#374151',
                                callback: function(value) {
                                    return value + ' km';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: isDarkMode ? '#e5e7eb' : '#374151'
                            }
                        }
                    }
                }
            });
            
            // Store the chart instance for later updates
            window.distanceChart = chart;
            
            // Update chart when dark mode changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                const isDarkMode = document.documentElement.classList.contains('dark');
                
                chart.options.scales.y.grid.color = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                chart.options.scales.y.ticks.color = isDarkMode ? '#e5e7eb' : '#374151';
                chart.options.scales.x.ticks.color = isDarkMode ? '#e5e7eb' : '#374151';
                chart.options.plugins.legend.labels.color = isDarkMode ? '#e5e7eb' : '#374151';
                
                chart.update();
            });
        }
        
        function refreshDashboard() {
            showView('dashboard', { replace: true, noAnimation: true });
        }
        
        function printDashboard() {
            window.print();
        }
        
        async function showHarvestFrontsForRouteRecording() {
            try {
                showLoading('Carregando frentes de colheita...');
                
                const fronts = await db.harvestFronts.where('status').equals('active').toArray();
                
                if (fronts.length === 0) {
                    hideLoading();
                    showToast('Nenhuma frente de colheita ativa disponível.', 'warning');
                    return;
                }
                
                if (fronts.length === 1) {
                    // If there's only one active front, go directly to record route
                    hideLoading();
                    recordRoute(fronts[0].id);
                    return;
                }
                
                // Create modal content to select a front
                const content = document.createElement('div');
                content.innerHTML = `
                    <p class="mb-4 text-gray-700 dark:text-gray-300">Selecione uma frente de colheita para registrar a rota:</p>
                    <div class="space-y-2 max-h-60 overflow-y-auto">
                        ${fronts.map(front => `
                            <div class="p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer flex items-center" data-front-id="${front.id}">
                                <div class="w-3 h-3 rounded-full mr-3" style="background-color: ${front.color}"></div>
                                <div>
                                    <h4 class="font-medium">${front.name}</h4>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">${front.location}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                // Add click events to the front items
                setTimeout(() => {
                    const frontItems = content.querySelectorAll('[data-front-id]');
                    frontItems.forEach(item => {
                        item.addEventListener('click', () => {
                            const frontId = item.dataset.frontId;
                            hideModal();
                            recordRoute(frontId);
                        });
                    });
                }, 100);
                
                hideLoading();
                
                // Show modal
                showModal('Registrar Nova Rota', content, [
                    { text: 'Cancelar', primary: false }
                ]);
                
            } catch (error) {
                console.error('Erro ao carregar frentes de colheita:', error);
                hideLoading();
                showToast('Erro ao carregar frentes de colheita.', 'error');
            }
        }
        
        async function renderHarvestFrontsView() {
            try {
                const harvestFronts = await db.harvestFronts.toArray();
                const drivers = await db.drivers.toArray();
                
                const appView = document.getElementById('app-view');
                appView.innerHTML = `
                    <div class="fade-in">
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Frentes de Colheita</h2>
                            <div class="flex space-x-3">
                                <button onclick="showView('drivers')" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg flex items-center focus:outline-none focus:ring-2 focus:ring-gray-500">
                                    <i class="fas fa-users mr-2"></i> Motoristas
                                </button>
                                <button onclick="showView('add-harvest-front')" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg flex items-center focus:outline-none focus:ring-2 focus:ring-primary-500">
                                    <i class="fas fa-plus mr-2"></i> Nova Frente
                                </button>
                            </div>
                        </div>
                        
                        <!-- Search and Filter -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                            <div class="flex flex-wrap gap-4">
                                <div class="flex-1 min-w-[200px]">
                                    <label for="frontSearch" class="sr-only">Buscar frentes</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-search text-gray-400"></i>
                                        </div>
                                        <input type="text" id="frontSearch" class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" placeholder="Buscar frentes...">
                                    </div>
                                </div>
                                <div>
                                    <label for="statusFilter" class="sr-only">Filtrar por status</label>
                                    <select id="statusFilter" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                                        <option value="all">Todos os status</option>
                                        <option value="active">Ativas</option>
                                        <option value="inactive">Inativas</option>
                                    </select>
                                </div>
                                <div>
                                    <button id="sortToggle" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-md flex items-center hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                                        <i class="fas fa-sort mr-2"></i> 
                                        <span id="sortText">Nome (A-Z)</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Front Cards -->
                        <div id="harvestFrontsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                            ${harvestFronts.length > 0 ? 
                                harvestFronts.map((front, index) => {
                                    const assignedDrivers = drivers.filter(d => d.assignedFront === front.id && d.status === 'active');
                                    
                                    return `
                                        <div class="harvest-card bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden stagger-item" style="animation-delay: ${index * 100}ms" data-front-id="${front.id}" data-front-name="${front.name}" data-front-status="${front.status}">
                                            <div class="h-3" style="background-color: ${front.color}"></div>
                                            <div class="p-5">
                                                <div class="flex justify-between items-start">
                                                    <h3 class="font-semibold text-lg mb-1">${front.name}</h3>
                                                    <span class="text-xs px-2 py-1 rounded-full ${front.status === 'active' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'}">
                                                        ${front.status === 'active' ? 'Ativa' : 'Inativa'}
                                                    </span>
                                                </div>
                                                <p class="text-gray-500 dark:text-gray-400 text-sm mb-2">${front.description || 'Sem descrição'}</p>
                                                <div class="flex items-center text-sm text-gray-600 dark:text-gray-300 mb-4">
                                                    <i class="fas fa-map-marker-alt mr-2"></i> ${front.location}
                                                </div>
                                                <div class="flex items-center text-sm mb-4">
                                                    <div class="text-gray-600 dark:text-gray-300 mr-4 routes-count" data-front-id="${front.id}">
                                                        <i class="fas fa-route mr-1"></i> <span class="skeleton w-16 h-4 inline-block">Carregando...</span>
                                                    </div>
                                                    <div class="text-gray-600 dark:text-gray-300">
                                                        <i class="fas fa-user mr-1"></i> ${assignedDrivers.length} motoristas
                                                    </div>
                                                </div>
                                                <div class="flex flex-wrap gap-2">
                                                    <button onclick="recordRoute(${front.id})" class="px-3 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg flex-1 text-sm flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                                        <i class="fas fa-route mr-2"></i> Registrar Rota
                                                    </button>
                                                    <div class="dropdown relative">
                                                        <button class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 bg-gray-100 dark:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </button>
                                                        <div class="dropdown-menu hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 z-10">
                                                            <button onclick="editHarvestFront(${front.id})" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                                                <i class="fas fa-pencil-alt mr-2"></i> Editar
                                                            </button>
                                                            <button onclick="viewFrontDetails(${front.id})" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                                                <i class="fas fa-info-circle mr-2"></i> Detalhes
                                                            </button>
                                                            <button onclick="toggleFrontStatus(${front.id}, '${front.status === 'active' ? 'inactive' : 'active'}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                                                <i class="fas fa-${front.status === 'active' ? 'pause' : 'play'} mr-2"></i> ${front.status === 'active' ? 'Desativar' : 'Ativar'}
                                                            </button>
                                                            <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                                                            <button onclick="deleteHarvestFront(${front.id})" class="block w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20">
                                                                <i class="fas fa-trash mr-2"></i> Excluir
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('') : 
                                `<div class="col-span-full bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 text-center">
                                    <div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 mx-auto rounded-full flex items-center justify-center mb-4">
                                        <i class="fas fa-tractor text-gray-400 dark:text-gray-500 text-2xl"></i>
                                    </div>
                                    <h3 class="text-lg font-medium mb-2">Nenhuma frente de colheita</h3>
                                    <p class="text-gray-500 dark:text-gray-400 mb-4">Adicione sua primeira frente de colheita para começar a registrar rotas.</p>
                                    <button onclick="showView('add-harvest-front')" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                        <i class="fas fa-plus mr-2"></i> Adicionar Frente de Colheita
                                    </button>
                                </div>`
                            }
                        </div>
                        
                        <!-- Empty state for filtered results -->
                        <div id="noResultsMessage" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 text-center">
                            <div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 mx-auto rounded-full flex items-center justify-center mb-4">
                                <i class="fas fa-search text-gray-400 dark:text-gray-500 text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-medium mb-2">Nenhuma frente encontrada</h3>
                            <p class="text-gray-500 dark:text-gray-400 mb-4">Tente ajustar os filtros ou realizar uma nova busca.</p>
                            <button onclick="resetFilters()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                Limpar Filtros
                            </button>
                        </div>
                    </div>
                `;
                
                // Set up dropdown toggles
                const dropdownButtons = document.querySelectorAll('.dropdown button');
                dropdownButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const dropdown = button.nextElementSibling;
                        dropdown.classList.toggle('hidden');
                        
                        // Close other dropdowns
                        document.querySelectorAll('.dropdown-menu:not(.hidden)').forEach(menu => {
                            if (menu !== dropdown) {
                                menu.classList.add('hidden');
                            }
                        });
                    });
                });
                
                // Close dropdowns when clicking outside
                document.addEventListener('click', () => {
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        menu.classList.add('hidden');
                    });
                });
                
                // Set up search and filtering
                const searchInput = document.getElementById('frontSearch');
                const statusFilter = document.getElementById('statusFilter');
                const sortToggle = document.getElementById('sortToggle');
                let currentSort = 'name-asc';
                
                if (searchInput && statusFilter && sortToggle) {
                    searchInput.addEventListener('input', filterFronts);
                    statusFilter.addEventListener('change', filterFronts);
                    
                    sortToggle.addEventListener('click', () => {
                        if (currentSort === 'name-asc') {
                            currentSort = 'name-desc';
                            document.getElementById('sortText').textContent = 'Nome (Z-A)';
                        } else if (currentSort === 'name-desc') {
                            currentSort = 'date-desc';
                            document.getElementById('sortText').textContent = 'Mais recentes';
                        } else if (currentSort === 'date-desc') {
                            currentSort = 'date-asc';
                            document.getElementById('sortText').textContent = 'Mais antigas';
                        } else {
                            currentSort = 'name-asc';
                            document.getElementById('sortText').textContent = 'Nome (A-Z)';
                        }
                        
                        filterFronts();
                    });
                }
                
                // Load route counts asynchronously
                if (harvestFronts.length > 0) {
                    harvestFronts.forEach(async (front) => {
                        try {
                            const routeCount = await db.routes.where('frontId').equals(front.id).count();
                            const routeCountElements = document.querySelectorAll(`.routes-count[data-front-id="${front.id}"] span`);
                            routeCountElements.forEach(el => {
                                el.textContent = `${routeCount} rotas`;
                                el.classList.remove('skeleton');
                            });
                        } catch (error) {
                            console.error(`Erro ao carregar contagem de rotas para frente ${front.id}:`, error);
                        }
                    });
                }
                
            } catch (error) {
                console.error('Erro ao renderizar frentes de colheita:', error);
                const appView = document.getElementById('app-view');
                appView.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 text-center">
                        <div class="w-16 h-16 bg-red-100 dark:bg-red-900 mx-auto rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-exclamation-triangle text-red-500 dark:text-red-300 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-medium mb-2">Erro ao carregar frentes de colheita</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-4">${error.message || 'Não foi possível carregar as frentes de colheita'}</p>
                        <button onclick="showView('harvest-fronts')" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                            Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }
        
        function filterFronts() {
            const searchInput = document.getElementById('frontSearch');
            const statusFilter = document.getElementById('statusFilter');
            const frontsList = document.getElementById('harvestFrontsList');
            const noResultsMessage = document.getElementById('noResultsMessage');
            
            if (!searchInput || !statusFilter || !frontsList || !noResultsMessage) return;
            
            const searchTerm = searchInput.value.toLowerCase();
            const statusFilterValue = statusFilter.value;
            
            const frontCards = frontsList.querySelectorAll('.harvest-card');
            let visibleCount = 0;
            
            frontCards.forEach(card => {
                const frontName = card.dataset.frontName.toLowerCase();
                const frontStatus = card.dataset.frontStatus;
                
                const matchesSearch = frontName.includes(searchTerm);
                const matchesStatus = statusFilterValue === 'all' || frontStatus === statusFilterValue;
                
                if (matchesSearch && matchesStatus) {
                    card.classList.remove('hidden');
                    visibleCount++;
                } else {
                    card.classList.add('hidden');
                }
            });
            
            // Sort visible items
            const sortedCards = Array.from(frontCards).filter(card => !card.classList.contains('hidden'));
            
            // Apply sorting
            sortedCards.sort((a, b) => {
                if (currentSort === 'name-asc') {
                    return a.dataset.frontName.localeCompare(b.dataset.frontName);
                } else if (currentSort === 'name-desc') {
                    return b.dataset.frontName.localeCompare(a.dataset.frontName);
                } else if (currentSort === 'date-desc' || currentSort === 'date-asc') {
                    const idA = parseInt(a.dataset.frontId);
                    const idB = parseInt(b.dataset.frontId);
                    return currentSort === 'date-desc' ? idB - idA : idA - idB;
                }
                return 0;
            });
            
            // Reorder DOM elements
            sortedCards.forEach(card => {
                frontsList.appendChild(card);
            });
            
            // Show/hide no results message
            if (visibleCount === 0) {
                frontsList.classList.add('hidden');
                noResultsMessage.classList.remove('hidden');
            } else {
                frontsList.classList.remove('hidden');
                noResultsMessage.classList.add('hidden');
            }
        }
        
        function resetFilters() {
            const searchInput = document.getElementById('frontSearch');
            const statusFilter = document.getElementById('statusFilter');
            
            if (searchInput) searchInput.value = '';
            if (statusFilter) statusFilter.value = 'all';
            
            filterFronts();
        }
        
        async function viewFrontDetails(frontId) {
            try {
                showLoading('Carregando detalhes da frente...');
                
                const front = await db.harvestFronts.get(parseInt(frontId));
                if (!front) {
                    hideLoading();
                    showToast('Frente de colheita não encontrada', 'error');
                    return;
                }
                
                const routes = await db.routes.where('frontId').equals(frontId).toArray();
                const drivers = await db.drivers.where('assignedFront').equals(frontId).toArray();
                
                // Process route paths for any that might be compressed
                routes.forEach(route => {
                    if (route.path && route.path._compressed) {
                        route.path = decompressPathData(route.path);
                    }
                });
                
                // Calculate statistics
                const totalRoutes = routes.length;
                const completedRoutes = routes.filter(r => r.status === 'completed').length;
                const activeRoutes = routes.filter(r => r.status === 'active').length;
                const totalDistance = routes.reduce((sum, route) => sum + (route.distance || 0), 0);
                
                // Get last 5 routes
                const recentRoutes = routes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
                
                const content = document.createElement('div');
                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex items-center">
                            <div class="w-4 h-4 rounded-full mr-3" style="background-color: ${front.color}"></div>
                            <h3 class="text-lg font-medium">${front.name}</h3>
                            <span class="ml-auto text-xs px-2 py-1 rounded-full ${front.status === 'active' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'}">
                                ${front.status === 'active' ? 'Ativa' : 'Inativa'}
                            </span>
                        </div>
                        
                        <div>
                            <p class="text-gray-700 dark:text-gray-300">${front.description || 'Sem descrição'}</p>
                            <p class="text-gray-500 dark:text-gray-400 mt-2"><i class="fas fa-map-marker-alt mr-2"></i>${front.location}</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3">
                                <p class="text-sm text-gray-500 dark:text-gray-400">Total de Rotas</p>
                                <p class="text-xl font-bold">${totalRoutes}</p>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3">
                                <p class="text-sm text-gray-500 dark:text-gray-400">Distância Total</p>
                                <p class="text-xl font-bold">${totalDistance.toFixed(1)} km</p>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-medium mb-2">Motoristas Atribuídos (${drivers.length})</h4>
                            ${drivers.length > 0 ? `
                                <div class="space-y-2 max-h-40 overflow-y-auto">
                                    ${drivers.map(driver => `
                                        <div class="flex items-center p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                            <div class="w-8 h-8 rounded-full bg-primary-100 dark:bg-primary-900 text-primary-500 dark:text-primary-300 mr-3 flex items-center justify-center">
                                                <i class="fas fa-user"></i>
                                            </div>
                                            <div>
                                                <p class="font-medium">${driver.name}</p>
                                                <p class="text-xs text-gray-500 dark:text-gray-400">${driver.phone || 'Sem telefone'}</p>
                                            </div>
                                            <span class="ml-auto text-xs px-2 py-1 rounded-full ${driver.status === 'active' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'}">
                                                ${driver.status === 'active' ? 'Ativo' : 'Inativo'}
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <p class="text-gray-500 dark:text-gray-400 text-center p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                    Nenhum motorista atribuído a esta frente
                                </p>
                            `}
                        </div>
                        
                        <div>
                            <h4 class="font-medium mb-2">Rotas Recentes</h4>
                            ${recentRoutes.length > 0 ? `
                                <div class="space-y-2 max-h-40 overflow-y-auto">
                                    ${recentRoutes.map(route => `
                                        <div class="flex items-center justify-between p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                            <div>
                                                <p class="font-medium">${route.name || `Rota #${route.id}`}</p>
                                                <p class="text-xs text-gray-500 dark:text-gray-400">${new Date(route.startTime).toLocaleDateString()} • ${route.distance ? route.distance.toFixed(1) + ' km' : 'N/A'}</p>
                                            </div>
                                            <span class="text-xs px-2 py-1 rounded-full ${getStatusClass(route.status)}">
                                                ${getStatusText(route.status)}
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <p class="text-gray-500 dark:text-gray-400 text-center p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                    Nenhuma rota registrada para esta frente
                                </p>
                            `}
                        </div>
                        
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            <p>Criada em: ${new Date(front.createdAt).toLocaleString()}</p>
                            <p>Última atualização: ${new Date(front.updatedAt).toLocaleString()}</p>
                        </div>
                    </div>
                `;
                
                hideLoading();
                
                showModal(`Detalhes da Frente`, content, [
                    { text: 'Editar', primary: false, action: () => editHarvestFront(frontId) },
                    { text: 'Registrar Rota', primary: true, action: () => recordRoute(frontId) }
                ]);
                
            } catch (error) {
                console.error('Erro ao carregar detalhes da frente:', error);
                hideLoading();
                showToast('Erro ao carregar detalhes da frente', 'error');
            }
        }
        
        function renderAddHarvestFrontView() {
            const appView = document.getElementById('app-view');
            appView.innerHTML = `
                <div class="fade-in">
                    <div class="flex items-center mb-6">
                        <button onclick="goBack()" class="mr-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 rounded-full p-1">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h2 class="text-2xl font-bold">Nova Frente de Colheita</h2>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="font-medium">Informações da Frente</h3>
                        </div>
                        <form id="addHarvestFrontForm" onsubmit="saveHarvestFront(event)" class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <div class="mb-4">
                                        <label for="frontName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nome da Frente *</label>
                                        <input type="text" id="frontName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base" required>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="frontDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descrição</label>
                                        <textarea id="frontDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base"></textarea>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="mb-4">
                                        <label for="frontLocation" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Localização *</label>
                                        <input type="text" id="frontLocation" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base" placeholder="Digite ou selecione uma fazenda" required>
                                        <div class="mt-2">
                                            <select id="frontFarmSelect" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
                                                <option value="">Selecionar fazenda cadastrada (KML)</option>
                                            </select>
                                        </div>
                                        <div id="frontFarmMap" class="mt-3 h-40 w-full rounded-lg border border-gray-300 dark:border-gray-600 hidden"></div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cor da Frente</label>
                                        <div class="flex flex-wrap gap-2" id="colorOptions">
                                            <label class="cursor-pointer relative">
                                                <input type="radio" name="frontColor" value="#2ecc71" class="sr-only peer" checked>
                                                <div class="w-8 h-8 rounded-full bg-[#2ecc71] border-2 border-transparent hover:border-gray-400 dark:hover:border-gray-500 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-700 dark:peer-checked:ring-white"></div>
                                            </label>
                                            <label class="cursor-pointer relative">
                                                <input type="radio" name="frontColor" value="#3498db" class="sr-only peer">
                                                <div class="w-8 h-8 rounded-full bg-[#3498db] border-2 border-transparent hover:border-gray-400 dark:hover:border-gray-500 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-700 dark:peer-checked:ring-white"></div>
                                            </label>
                                            <label class="cursor-pointer relative">
                                                <input type="radio" name="frontColor" value="#f1c40f" class="sr-only peer">
                                                <div class="w-8 h-8 rounded-full bg-[#f1c40f] border-2 border-transparent hover:border-gray-400 dark:hover:border-gray-500 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-700 dark:peer-checked:ring-white"></div>
                                            </label>
                                            <label class="cursor-pointer relative">
                                                <input type="radio" name="frontColor" value="#e67e22" class="sr-only peer">
                                                <div class="w-8 h-8 rounded-full bg-[#e67e22] border-2 border-transparent hover:border-gray-400 dark:hover:border-gray-500 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-700 dark:peer-checked:ring-white"></div>
                                            </label>
                                            <label class="cursor-pointer relative">
                                                <input type="radio" name="frontColor" value="#e74c3c" class="sr-only peer">
                                                <div class="w-8 h-8 rounded-full bg-[#e74c3c] border-2 border-transparent hover:border-gray-400 dark:hover:border-gray-500 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-700 dark:peer-checked:ring-white"></div>
                                            </label>
                                            <label class="cursor-pointer relative">
                                                <input type="radio" name="frontColor" value="#9b59b6" class="sr-only peer">
                                                <div class="w-8 h-8 rounded-full bg-[#9b59b6] border-2 border-transparent hover:border-gray-400 dark:hover:border-gray-500 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-700 dark:peer-checked:ring-white"></div>
                                            </label>
                                            <label class="cursor-pointer relative">
                                                <input type="radio" name="frontColor" value="#5D5CDE" class="sr-only peer">
                                                <div class="w-8 h-8 rounded-full bg-[#5D5CDE] border-2 border-transparent hover:border-gray-400 dark:hover:border-gray-500 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-700 dark:peer-checked:ring-white"></div>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                                        <div class="flex space-x-4">
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="frontStatus" value="active" class="form-radio text-primary-500" checked>
                                                <span class="ml-2">Ativa</span>
                                            </label>
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="frontStatus" value="inactive" class="form-radio text-gray-500">
                                                <span class="ml-2">Inativa</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex justify-end space-x-3">
                                <button type="button" onclick="goBack()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                                    Cancelar
                                </button>
                                <button type="submit" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                    Salvar Frente
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-200">
                        <div class="flex">
                            <i class="fas fa-info-circle mt-1 mr-2"></i>
                            <div>
                                <p class="text-sm">Após criar uma frente de colheita, você poderá:</p>
                                <ul class="list-disc list-inside text-sm mt-2 ml-2">
                                    <li>Registrar rotas de transporte</li>
                                    <li>Atribuir motoristas à frente</li>
                                    <li>Visualizar estatísticas de operação</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Populate fazendas cadastradas e mapa de pré-visualização
            (async () => {
                try {
                    const selectEl = document.getElementById('frontFarmSelect');
                    const inputEl = document.getElementById('frontLocation');
                    const mapEl = document.getElementById('frontFarmMap');
                    
                    const farms = await db.farms.toArray();
                    if (selectEl && farms && farms.length > 0) {
                        farms.forEach(farm => {
                            const opt = document.createElement('option');
                            opt.value = String(farm.id);
                            opt.textContent = farm.name;
                            selectEl.appendChild(opt);
                        });
                        
                        let mapInstance = null;
                        let geoLayer = null;
                        
                        selectEl.addEventListener('change', () => {
                            const farmId = parseInt(selectEl.value);
                            const selected = farms.find(f => f.id === farmId);
                            
                            if (selected) {
                                if (inputEl) inputEl.value = selected.name;
                                
                                if (mapEl) {
                                    mapEl.classList.remove('hidden');
                                    
                                    if (!mapInstance) {
                                        mapInstance = L.map('frontFarmMap');
                                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                            attribution: '&copy; OpenStreetMap contributors'
                                        }).addTo(mapInstance);
                                    }
                                    
                                    if (geoLayer) {
                                        geoLayer.remove();
                                        geoLayer = null;
                                    }
                                    
                                    if (selected.geoJson) {
                                        geoLayer = L.geoJSON(selected.geoJson, {
                                            style: { color: '#10B981', weight: 2, fillOpacity: 0.2 }
                                        }).addTo(mapInstance);
                                        
                                        const bounds = geoLayer.getBounds();
                                        if (bounds.isValid()) {
                                            mapInstance.fitBounds(bounds, { padding: [10, 10] });
                                        }
                                        setTimeout(() => mapInstance.invalidateSize(), 100);
                                    }
                                }
                            } else {
                                if (mapEl) {
                                    mapEl.classList.add('hidden');
                                }
                            }
                        });
                    }
                } catch(e) {
                    console.error('Erro ao carregar fazendas para Localização:', e);
                }
            })();
        }
        
        async function renderEditHarvestFrontView(frontId) {
            try {
                const front = await db.harvestFronts.get(parseInt(frontId));
                if (!front) {
                    showToast('Frente de colheita não encontrada', 'error');
                    showView('harvest-fronts');
                    return;
                }
                
                const appView = document.getElementById('app-view');
                appView.innerHTML = `
                    <div class="fade-in">
                        <div class="flex items-center mb-6">
                            <button onclick="goBack()" class="mr-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 rounded-full p-1">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <h2 class="text-2xl font-bold">Editar Frente de Colheita</h2>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
                            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center">
                                <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${front.color}"></div>
                                <h3 class="font-medium">${front.name}</h3>
                            </div>
                            <form id="editHarvestFrontForm" onsubmit="updateHarvestFront(event, ${front.id})" class="p-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <div class="mb-4">
                                            <label for="frontName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nome da Frente *</label>
                                            <input type="text" id="frontName" value="${front.name}" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base" required>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="frontDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descrição</label>
                                            <textarea id="frontDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base">${front.description || ''}</textarea>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <div class="mb-4">
                                            <label for="frontLocation" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Localização *</label>
                                            <input type="text" id="frontLocation" value="${front.location}" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base" required>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                                            <div class="flex space-x-4">
                                                <label class="inline-flex items-center">
                                                    <input type="radio" name="frontStatus" value="active" class="form-radio text-primary-500" ${front.status === 'active' ? 'checked' : ''}>
                                                    <span class="ml-2">Ativa</span>
                                                </label>
                                                <label class="inline-flex items-center">
                                                    <input type="radio" name="frontStatus" value="inactive" class="form-radio text-gray-500" ${front.status === 'inactive' ? 'checked' : ''}>
                                                    <span class="ml-2">Inativa</span>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cor da Frente</label>
                                            <div class="flex flex-wrap gap-2" id="colorOptions">
                                                <label class="cursor-pointer relative">
                                                    <input type="radio" name="frontColor" value="#2ecc71" class="sr-only peer" ${front.color === '#2ecc71' ? 'checked' : ''}>
                                                    <div class="w-8 h-8 rounded-full bg-[#2ecc71] border-2 border-transparent hover:border-gray-400 dark:hover:border-gray-500 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-700 dark:peer-checked:ring-white"></div>
                                                </label>
                                                <label class="cursor-pointer relative">
                                                    <input type="radio" name="frontColor" value="#3498db" class="sr-only peer" ${front.color === '#3498db' ? 'checked' : ''}>
                                                    <div class="w-8 h-8 rounded-full bg-[#3498db] border-2 border-transparent hover:border-gray-400 dark:hover:border-gray-500 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-700 dark:peer-checked:ring-white"></div>
                                                </label>
                                                <label class="cursor-pointer relative">
                                                    <input type="radio" name="frontColor" value="#f1c40f" class="sr-only peer" ${front.color === '#f1c40f' ? 'checked' : ''}>
                                                    <div class="w-8 h-8 rounded-full bg-[#f1c40f] border-2 border-transparent hover:border-gray-400 dark:hover:border-gray-500 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-700 dark:peer-checked:ring-white"></div>
                                                </label>
                                                <label class="cursor-pointer relative">
                                                    <input type="radio" name="frontColor" value="#e67e22" class="sr-only peer" ${front.color === '#e67e22' ? 'checked' : ''}>
                                                    <div class="w-8 h-8 rounded-full bg-[#e67e22] border-2 border-transparent hover:border-gray-400 dark:hover:border-gray-500 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-700 dark:peer-checked:ring-white"></div>
                                                </label>
                                                <label class="cursor-pointer relative">
                                                    <input type="radio" name="frontColor" value="#e74c3c" class="sr-only peer" ${front.color === '#e74c3c' ? 'checked' : ''}>
                                                    <div class="w-8 h-8 rounded-full bg-[#e74c3c] border-2 border-transparent hover:border-gray-400 dark:hover:border-gray-500 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-700 dark:peer-checked:ring-white"></div>
                                                </label>
                                                <label class="cursor-pointer relative">
                                                    <input type="radio" name="frontColor" value="#9b59b6" class="sr-only peer" ${front.color === '#9b59b6' ? 'checked' : ''}>
                                                    <div class="w-8 h-8 rounded-full bg-[#9b59b6] border-2 border-transparent hover:border-gray-400 dark:hover:border-gray-500 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-700 dark:peer-checked:ring-white"></div>
                                                </label>
                                                <label class="cursor-pointer relative">
                                                    <input type="radio" name="frontColor" value="#5D5CDE" class="sr-only peer" ${front.color === '#5D5CDE' ? 'checked' : ''}>
                                                    <div class="w-8 h-8 rounded-full bg-[#5D5CDE] border-2 border-transparent hover:border-gray-400 dark:hover:border-gray-500 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-700 dark:peer-checked:ring-white"></div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-6 flex justify-end space-x-3">
                                    <button type="button" onclick="goBack()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                        Atualizar Frente
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="mt-4 text-sm text-gray-500 dark:text-gray-400">
                            <p>Criada em: ${new Date(front.createdAt).toLocaleString()}</p>
                            <p>Última atualização: ${new Date(front.updatedAt).toLocaleString()}</p>
                        </div>
                    </div>
                `;
                

            } catch (error) {
                console.error('Erro ao renderizar edição de frente:', error);
                showToast('Erro ao carregar dados da frente de colheita', 'error');
                showView('harvest-fronts');
            }
        }
        
        async function renderRoutesView() {
            try {
                const routes = await db.routes.toArray();
                const harvestFronts = await db.harvestFronts.toArray();
                
                // Process route paths for any that might be compressed
                routes.forEach(route => {
                    if (route.path && route.path._compressed) {
                        route.path = decompressPathData(route.path);
                    }
                });
                
                // Sort routes by date (newest first)
                routes.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
                
                const appView = document.getElementById('app-view');
                appView.innerHTML = `
                    <div class="fade-in">
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Rotas Registradas</h2>
                            <div class="flex space-x-3">
                                <button onclick="showHarvestFrontsForRouteRecording()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg flex items-center focus:outline-none focus:ring-2 focus:ring-primary-500">
                                    <i class="fas fa-plus mr-2"></i> Nova Rota
                                </button>
                            </div>
                        </div>
                        
                        <!-- Search and Filter -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                            <div class="flex flex-wrap gap-4">
                                <div class="flex-1 min-w-[200px]">
                                    <label for="routeSearch" class="sr-only">Buscar rotas</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-search text-gray-400"></i>
                                        </div>
                                        <input type="text" id="routeSearch" class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" placeholder="Buscar rotas...">
                                    </div>
                                </div>
                                <div>
                                    <label for="routeStatusFilter" class="sr-only">Filtrar por status</label>
                                    <select id="routeStatusFilter" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                                        <option value="all">Todos os status</option>
                                        <option value="active">Ativas</option>
                                        <option value="completed">Concluídas</option>
                                        <option value="paused">Pausadas</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="routeFrontFilter" class="sr-only">Filtrar por frente</label>
                                    <select id="routeFrontFilter" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                                        <option value="all">Todas as frentes</option>
                                        ${harvestFronts.map(front => `<option value="${front.id}">${front.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        ${routes.length > 0 ? `
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden mb-6">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-700">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    <div class="flex items-center cursor-pointer" onclick="sortRoutes('id')">
                                                        ID
                                                        <i class="fas fa-sort ml-1 text-gray-400"></i>
                                                    </div>
                                                </th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    <div class="flex items-center cursor-pointer" onclick="sortRoutes('name')">
                                                        Nome
                                                        <i class="fas fa-sort ml-1 text-gray-400"></i>
                                                    </div>
                                                </th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    <div class="flex items-center cursor-pointer" onclick="sortRoutes('front')">
                                                        Frente
                                                        <i class="fas fa-sort ml-1 text-gray-400"></i>
                                                    </div>
                                                </th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    <div class="flex items-center cursor-pointer" onclick="sortRoutes('date')">
                                                        Data
                                                        <i class="fas fa-sort ml-1 text-gray-400"></i>
                                                    </div>
                                                </th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    Status
                                                </th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    <div class="flex items-center cursor-pointer" onclick="sortRoutes('distance')">
                                                        Distância
                                                        <i class="fas fa-sort ml-1 text-gray-400"></i>
                                                    </div>
                                                </th>
                                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    Ações
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="routesTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            ${routes.map((route, index) => {
                                                const front = harvestFronts.find(f => f.id === route.frontId);
                                                const startDate = new Date(route.startTime);
                                                
                                                return `
                                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors stagger-item" 
                                                        style="animation-delay: ${index * 50}ms"
                                                        data-route-id="${route.id}"
                                                        data-route-name="${route.name || ''}"
                                                        data-route-front="${front?.id || ''}"
                                                        data-route-status="${route.status}">
                                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                            <span class="text-primary-500">#${route.id}</span>
                                                        </td>
                                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                            ${route.name || 'Sem nome'}
                                                        </td>
                                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                            <div class="flex items-center">
                                                                ${front ? `
                                                                    <div class="w-2 h-2 rounded-full mr-2" style="background-color: ${front.color}"></div>
                                                                    ${front.name}
                                                                ` : 'Frente não encontrada'}
                                                            </div>
                                                        </td>
                                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                            ${startDate.toLocaleDateString()} ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                                        </td>
                                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                            <span class="status-badge ${getStatusClass(route.status)}">
                                                                ${getStatusText(route.status)}
                                                            </span>
                                                        </td>
                                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                            ${route.distance ? route.distance.toFixed(1) + ' km' : 'N/A'}
                                                        </td>
                                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                            <div class="flex justify-end space-x-2">
                                                                <button onclick="viewRouteDetails(${route.frontId}, ${route.id})" class="text-primary-500 hover:text-primary-600 p-1" aria-label="Ver detalhes">
                                                                    <i class="fas fa-eye"></i>
                                                                </button>
                                                                ${route.status === 'active' ? `
                                                                    <button onclick="showDriverNavigation(${route.frontId}, ${route.id})" class="text-blue-500 hover:text-blue-600 p-1" aria-label="Navegar">
                                                                        <i class="fas fa-location-arrow"></i>
                                                                    </button>
                                                                ` : ''}
                                                                <button onclick="deleteRoute(${route.frontId}, ${route.id})" class="text-red-500 hover:text-red-600 p-1" aria-label="Excluir">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Empty state for filtered results -->
                            <div id="noRoutesMessage" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 text-center">
                                <div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 mx-auto rounded-full flex items-center justify-center mb-4">
                                    <i class="fas fa-search text-gray-400 dark:text-gray-500 text-2xl"></i>
                                </div>
                                <h3 class="text-lg font-medium mb-2">Nenhuma rota encontrada</h3>
                                <p class="text-gray-500 dark:text-gray-400 mb-4">Tente ajustar os filtros ou realizar uma nova busca.</p>
                                <button onclick="resetRouteFilters()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                    Limpar Filtros
                                </button>
                            </div>
                        ` : `
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 text-center">
                                <div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 mx-auto rounded-full flex items-center justify-center mb-4">
                                    <i class="fas fa-route text-gray-400 dark:text-gray-500 text-2xl"></i>
                                </div>
                                <h3 class="text-lg font-medium mb-2">Nenhuma rota registrada</h3>
                                <p class="text-gray-500 dark:text-gray-400 mb-4">Selecione uma frente de colheita e comece a registrar rotas.</p>
                                <button onclick="showHarvestFrontsForRouteRecording()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                    Registrar Nova Rota
                                </button>
                            </div>
                        `}
                        
                        <!-- Route Statistics -->
                        ${routes.length > 0 ? `
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mt-6">
                                <h3 class="font-semibold mb-4">Estatísticas das Rotas</h3>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                                        <div class="text-sm text-gray-500 dark:text-gray-400">Total de Rotas</div>
                                        <div class="text-xl font-bold">${routes.length}</div>
                                    </div>
                                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                                        <div class="text-sm text-gray-500 dark:text-gray-400">Distância Total</div>
                                        <div class="text-xl font-bold">${routes.reduce((sum, route) => sum + (route.distance || 0), 0).toFixed(1)} km</div>
                                    </div>
                                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                                        <div class="text-sm text-gray-500 dark:text-gray-400">Tempo Total</div>
                                        <div class="text-xl font-bold">${formatTotalDuration(routes.reduce((sum, route) => sum + (route.duration || 0), 0))}</div>
                                    </div>
                                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                                        <div class="text-sm text-gray-500 dark:text-gray-400">Média por Rota</div>
                                        <div class="text-xl font-bold">${(routes.reduce((sum, route) => sum + (route.distance || 0), 0) / routes.length).toFixed(1)} km</div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 class="font-medium mb-3">Distribuição por Status</h4>
                                    <div class="h-10 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                        ${generateStatusDistributionBar(routes)}
                                    </div>
                                    <div class="flex justify-between mt-2 text-xs">
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 rounded-full bg-green-500 mr-1"></div>
                                            <span>Ativas (${routes.filter(r => r.status === 'active').length})</span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 rounded-full bg-yellow-500 mr-1"></div>
                                            <span>Pausadas (${routes.filter(r => r.status === 'paused').length})</span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 rounded-full bg-blue-500 mr-1"></div>
                                            <span>Concluídas (${routes.filter(r => r.status === 'completed').length})</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // Set up search and filtering
                if (routes.length > 0) {
                    const searchInput = document.getElementById('routeSearch');
                    const statusFilter = document.getElementById('routeStatusFilter');
                    const frontFilter = document.getElementById('routeFrontFilter');
                    
                    if (searchInput && statusFilter && frontFilter) {
                        searchInput.addEventListener('input', filterRoutes);
                        statusFilter.addEventListener('change', filterRoutes);
                        frontFilter.addEventListener('change', filterRoutes);
                    }
                }
                
            } catch (error) {
                console.error('Erro ao renderizar rotas:', error);
                const appView = document.getElementById('app-view');
                appView.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 text-center">
                        <div class="w-16 h-16 bg-red-100 dark:bg-red-900 mx-auto rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-exclamation-triangle text-red-500 dark:text-red-300 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-medium mb-2">Erro ao carregar rotas</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-4">${error.message || 'Não foi possível carregar as rotas'}</p>
                        <button onclick="showView('routes')" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                            Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }
        
        function generateStatusDistributionBar(routes) {
            const total = routes.length;
            const active = routes.filter(r => r.status === 'active').length;
            const paused = routes.filter(r => r.status === 'paused').length;
            const completed = routes.filter(r => r.status === 'completed').length;
            
            const activePercent = (active / total) * 100;
            const pausedPercent = (paused / total) * 100;
            const completedPercent = (completed / total) * 100;
            
            return `
                <div class="flex h-full">
                    <div style="width: ${activePercent}%" class="bg-green-500"></div>
                    <div style="width: ${pausedPercent}%" class="bg-yellow-500"></div>
                    <div style="width: ${completedPercent}%" class="bg-blue-500"></div>
                </div>
            `;
        }
        
        function formatTotalDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = Math.floor(minutes % 60);
            
            if (hours === 0) {
                return `${mins}min`;
            } else {
                return `${hours}h ${mins}min`;
            }
        }
        
        function getStatusClass(status) {
            switch(status) {
                case 'active': return 'status-active';
                case 'paused': return 'status-paused';
                case 'completed': return 'status-completed';
                default: return 'status-paused';
            }
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'active': return 'Ativa';
                case 'paused': return 'Pausada';
                case 'completed': return 'Concluída';
                default: return status;
            }
        }
        
        function filterRoutes() {
            const searchInput = document.getElementById('routeSearch');
            const statusFilter = document.getElementById('routeStatusFilter');
            const frontFilter = document.getElementById('routeFrontFilter');
            const routesTableBody = document.getElementById('routesTableBody');
            const noRoutesMessage = document.getElementById('noRoutesMessage');
            
            if (!searchInput || !statusFilter || !frontFilter || !routesTableBody || !noRoutesMessage) return;
            
            const searchTerm = searchInput.value.toLowerCase();
            const statusValue = statusFilter.value;
            const frontValue = frontFilter.value;
            
            const rows = routesTableBody.querySelectorAll('tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const routeName = (row.dataset.routeName || '').toLowerCase();
                const routeStatus = row.dataset.routeStatus;
                const routeFront = row.dataset.routeFront;
                
                const matchesSearch = routeName.includes(searchTerm);
                const matchesStatus = statusValue === 'all' || routeStatus === statusValue;
                const matchesFront = frontValue === 'all' || routeFront === frontValue;
                
                if (matchesSearch && matchesStatus && matchesFront) {
                    row.classList.remove('hidden');
                    visibleCount++;
                } else {
                    row.classList.add('hidden');
                }
            });
            
            // Show/hide no routes message
            if (visibleCount === 0) {
                routesTableBody.parentElement.parentElement.classList.add('hidden');
                noRoutesMessage.classList.remove('hidden');
            } else {
                routesTableBody.parentElement.parentElement.classList.remove('hidden');
                noRoutesMessage.classList.add('hidden');
            }
        }
        
        function resetRouteFilters() {
            const searchInput = document.getElementById('routeSearch');
            const statusFilter = document.getElementById('routeStatusFilter');
            const frontFilter = document.getElementById('routeFrontFilter');
            
            if (searchInput) searchInput.value = '';
            if (statusFilter) statusFilter.value = 'all';
            if (frontFilter) frontFilter.value = 'all';
            
            filterRoutes();
        }
        
        // Global sort state
        let routeSortField = 'date';
        let routeSortDirection = 'desc';
        
        function sortRoutes(field) {
            if (routeSortField === field) {
                // Toggle direction if same field
                routeSortDirection = routeSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // New field, set default direction
                routeSortField = field;
                routeSortDirection = 'asc';
            }
            
            const routesTableBody = document.getElementById('routesTableBody');
            if (!routesTableBody) return;
            
            const rows = Array.from(routesTableBody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                let valueA, valueB;
                
                switch(field) {
                    case 'id':
                        valueA = parseInt(a.dataset.routeId);
                        valueB = parseInt(b.dataset.routeId);
                        break;
                    case 'name':
                        valueA = a.dataset.routeName || '';
                        valueB = b.dataset.routeName || '';
                        break;
                    case 'front':
                        valueA = a.dataset.routeFront || '';
                        valueB = b.dataset.routeFront || '';
                        break;
                    case 'distance':
                        valueA = parseFloat(a.querySelectorAll('td')[5].textContent);
                        valueB = parseFloat(b.querySelectorAll('td')[5].textContent);
                        // Handle 'N/A' values
                        if (isNaN(valueA)) valueA = 0;
                        if (isNaN(valueB)) valueB = 0;
                        break;
                    case 'date':
                        valueA = new Date(a.querySelectorAll('td')[3].textContent);
                        valueB = new Date(b.querySelectorAll('td')[3].textContent);
                        break;
                    default:
                        return 0;
                }
                
                if (routeSortDirection === 'asc') {
                    if (valueA < valueB) return -1;
                    if (valueA > valueB) return 1;
                } else {
                    if (valueA > valueB) return -1;
                    if (valueA < valueB) return 1;
                }
                return 0;
            });
            
            // Update DOM
            rows.forEach(row => {
                routesTableBody.appendChild(row);
            });
            
            // Update sort icons
            const sortIcons = document.querySelectorAll('th i.fa-sort, th i.fa-sort-up, th i.fa-sort-down');
            sortIcons.forEach(icon => {
                icon.classList.remove('fa-sort-up', 'fa-sort-down', 'text-primary-500');
                icon.classList.add('fa-sort', 'text-gray-400');
            });
            
            // Set active sort icon
            const activeHeader = document.querySelector(`th div[onclick="sortRoutes('${field}')"]`);
            if (activeHeader) {
                const icon = activeHeader.querySelector('i');
                icon.classList.remove('fa-sort', 'text-gray-400');
                icon.classList.add(routeSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down', 'text-primary-500');
            }
        }
        
        async function renderRecordRouteView(frontId) {
            try {
                const front = await db.harvestFronts.get(parseInt(frontId));
                if (!front) {
                    showToast('Frente de colheita não encontrada', 'error');
                    showView('harvest-fronts');
                    return;
                }
                
                const appView = document.getElementById('app-view');
                appView.dataset.frontId = frontId;
                
                appView.innerHTML = `
                    <div class="fade-in">
                        <div class="flex items-center mb-3">
                            <button onclick="goBack()" class="mr-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 rounded-full p-1">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <h2 class="text-xl font-bold">Registrar Rota - ${front.name}</h2>
                        </div>
                        
                        <div class="mb-4 flex items-center">
                            <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${front.color}"></div>
                            <span class="text-gray-600 dark:text-gray-300">${front.location}</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2">
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mb-6">
                                    <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                                        <h3 class="font-medium">Mapa de Gravação</h3>
                                        <div class="flex items-center">
                                            <span id="accuracy-indicator" class="hidden text-xs px-2 py-1 rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 mr-2">
                                                <i class="fas fa-signal mr-1"></i> <span id="accuracy-value">0</span>m
                                            </span>
                                            <span id="recording-status" class="hidden text-xs px-2 py-1 rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">
                                                <i class="fas fa-circle text-red-500 mr-1 recording-dot"></i> Gravando
                                            </span>
                                        </div>
                                    </div>
                                    <div id="record-map" class="map-container" style="height: 400px;"></div>
                                </div>
                                
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 text-center">
                                            <div class="text-sm text-gray-500 dark:text-gray-400">Tempo de Gravação</div>
                                            <div id="recording-time" class="text-lg font-semibold">00:00:00</div>
                                        </div>
                                        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 text-center">
                                            <div class="text-sm text-gray-500 dark:text-gray-400">Pontos Registrados</div>
                                            <div id="points-count" class="text-lg font-semibold">0</div>
                                        </div>
                                        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 text-center">
                                            <div class="text-sm text-gray-500 dark:text-gray-400">Distância</div>
                                            <div id="distance-count" class="text-lg font-semibold">0.0 km</div>
                                        </div>
                                        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 text-center">
                                            <div class="text-sm text-gray-500 dark:text-gray-400">Velocidade</div>
                                            <div id="current-speed" class="text-lg font-semibold">0.0 km/h</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- GPS Quality Indicator -->
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                                    <h3 class="font-medium mb-2">Qualidade do GPS</h3>
                                    <div class="flex items-center space-x-2">
                                        <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                            <div id="gps-quality-bar" class="h-2.5 rounded-full bg-green-500" style="width: 100%"></div>
                                        </div>
                                        <span id="gps-quality-text" class="text-sm font-medium text-green-500">Excelente</span>
                                    </div>
                                    <p id="gps-quality-message" class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                        GPS pronto para gravação precisa.
                                    </p>
                                </div>
                            </div>
                            
                            <div class="lg:col-span-1">
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                                    <h3 class="font-medium mb-4">Informações da Rota</h3>
                                    <form id="routeInfoForm">
                                        <div class="mb-4">
                                            <label for="routeName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nome da Rota</label>
                                            <input type="text" id="routeName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base" placeholder="Ex: Transporte para usina">
                                        </div>
                                        <div class="mb-4">
                                            <label for="routeDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descrição</label>
                                            <input type="text" id="routeDescription" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base" placeholder="Ex: Área 1 - Talhão 3">
                                        </div>
                                        <div class="mb-4">
                                            <label for="routeTags" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tags (separadas por vírgula)</label>
                                            <input type="text" id="routeTags" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base" placeholder="Ex: transporte, usina">
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Rota Sugerida (KML)</label>
                                            <div class="flex space-x-2 items-center">
                                                <button onclick="document.getElementById('kmlInput').click()" type="button" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                                    <i class="fas fa-file-upload mr-2"></i> Importar KML
                                                </button>
                                                <span id="kmlFileName" class="inline-flex items-center text-sm text-gray-500 dark:text-gray-400 truncate max-w-[150px]">Nenhum arquivo selecionado</span>
                                            </div>
                                            <input type="file" id="kmlInput" accept=".kml" class="hidden" onchange="handleKmlImport(event)">
                                        </div>
                                    </form>
                                    
                                    <div id="battery-status" class="mb-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg hidden">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm text-gray-700 dark:text-gray-300">Bateria</span>
                                            <span id="battery-level" class="text-sm font-medium">100%</span>
                                        </div>
                                        <div class="w-full h-2 bg-gray-300 dark:bg-gray-600 rounded-full mt-2">
                                            <div id="battery-indicator" class="h-full bg-green-500 rounded-full" style="width: 100%;"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 gap-3 mt-6">
                                        <button id="startButton" onclick="startRecording(${frontId})" class="px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg shadow-md font-medium flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                            <i class="fas fa-play mr-2"></i> Iniciar Gravação
                                        </button>
                                        <button id="stopButton" onclick="stopRecording()" class="px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg shadow-md font-medium flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2" disabled>
                                            <i class="fas fa-stop mr-2"></i> Parar Gravação
                                        </button>
                                        <button id="pauseButton" onclick="pauseRecording()" class="px-4 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg shadow-md font-medium flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2" disabled>
                                            <i class="fas fa-pause mr-2"></i> Pausar Gravação
                                        </button>
                                        <button id="resumeButton" onclick="resumeRecording()" class="px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg shadow-md font-medium flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 hidden">
                                            <i class="fas fa-play mr-2"></i> Continuar Gravação
                                        </button>
                                        <button id="centerMapButton" onclick="centerMapOnCurrentLocation()" class="px-4 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg shadow-md font-medium flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                                            <i class="fas fa-crosshairs mr-2"></i> Centralizar Mapa
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-800 text-yellow-800 dark:text-yellow-200">
                                    <div class="flex">
                                        <i class="fas fa-info-circle mt-1 mr-2"></i>
                                        <div>
                                            <p class="text-sm">Para melhor precisão na gravação de rotas:</p>
                                            <ul class="list-disc list-inside text-sm mt-2 ml-2">
                                                <li>Certifique-se de que a localização do dispositivo está ativada</li>
                                                <li>Mantenha o aplicativo aberto durante o registro da rota</li>
                                                <li>Evite áreas com sinal de GPS fraco</li>
                                                <li>Mantenha o dispositivo com bateria suficiente</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Check battery API support
                if ('getBattery' in navigator) {
                    try {
                        const battery = await navigator.getBattery();
                        updateBatteryStatus(battery);
                        
                        // Listen for battery changes
                        battery.addEventListener('levelchange', () => {
                            updateBatteryStatus(battery);
                        });
                        battery.addEventListener('chargingchange', () => {
                            updateBatteryStatus(battery);
                        });
                        
                        // Start monitoring for critical battery levels
                        monitorBatteryStatus();
                        
                        // Show battery status element
                        document.getElementById('battery-status').classList.remove('hidden');
                    } catch (error) {
                        console.error('Erro ao acessar informações da bateria:', error);
                    }
                }
                
                // Initialize map for recording
                setTimeout(() => {
                    initRecordMap();
                }, 100);
            } catch (error) {
                console.error('Erro ao renderizar registro de rota:', error);
                showToast('Erro ao carregar página de registro de rota', 'error');
                showView('harvest-fronts');
            }
        }
        
        function updateBatteryStatus(battery) {
            const batteryLevel = document.getElementById('battery-level');
            const batteryIndicator = document.getElementById('battery-indicator');
            
            if (batteryLevel && batteryIndicator) {
                const level = Math.floor(battery.level * 100);
                batteryLevel.textContent = `${level}%${battery.charging ? ' (Carregando)' : ''}`;
                batteryIndicator.style.width = `${level}%`;
                
                // Update color based on level
                if (level <= 20) {
                    batteryIndicator.classList.remove('bg-green-500', 'bg-yellow-500');
                    batteryIndicator.classList.add('bg-red-500');
                } else if (level <= 50) {
                    batteryIndicator.classList.remove('bg-green-500', 'bg-red-500');
                    batteryIndicator.classList.add('bg-yellow-500');
                } else {
                    batteryIndicator.classList.remove('bg-yellow-500', 'bg-red-500');
                    batteryIndicator.classList.add('bg-green-500');
                }
                
                // Store in recording state
                currentRecording.batteryStatus = {
                    level,
                    charging: battery.charging
                };
                
                // Show warning if battery is low and recording
                if (level <= 15 && currentRecording.recording && !battery.charging) {
                    showToast('Bateria baixa! Conecte o carregador para evitar perda de dados.', 'warning');
                }
                
                // Auto-save if battery is critically low
                if (level <= 5 && currentRecording.recording && !battery.charging) {
                    showToast('Bateria crítica! Salvando dados atuais...', 'error');
                    stopRecording();
                }
            }
        }
        
        function updateGpsQualityIndicator(accuracy) {
            const gpsQualityBar = document.getElementById('gps-quality-bar');
            const gpsQualityText = document.getElementById('gps-quality-text');
            const gpsQualityMessage = document.getElementById('gps-quality-message');
            
            if (!gpsQualityBar || !gpsQualityText || !gpsQualityMessage) return;
            
            // Categorize GPS quality based on accuracy
            let quality, color, width, message;
            
            if (accuracy <= 5) {
                quality = "Excelente";
                color = "bg-green-500";
                width = "100%";
                message = "GPS pronto para gravação precisa.";
            } else if (accuracy <= 10) {
                quality = "Boa";
                color = "bg-green-400";
                width = "80%";
                message = "Boa precisão para a maioria das gravações.";
            } else if (accuracy <= 20) {
                quality = "Aceitável";
                color = "bg-yellow-500";
                width = "60%";
                message = "Precisão razoável, gravação pode continuar.";
            } else if (accuracy <= 40) {
                quality = "Fraca";
                color = "bg-orange-500";
                width = "40%";
                message = "Precisão baixa. Tente mover-se para uma área mais aberta.";
            } else {
                quality = "Ruim";
                color = "bg-red-500";
                width = "20%";
                message = "Precisão muito baixa. Gravação não recomendada.";
            }
            
            // Update the indicator
            gpsQualityBar.className = "h-2.5 rounded-full " + color;
            gpsQualityBar.style.width = width;
            gpsQualityText.textContent = quality;
            gpsQualityText.className = "text-sm font-medium " + color.replace('bg-', 'text-');
            gpsQualityMessage.textContent = message;
            
            // Warn user if GPS quality is poor and recording is active
            if (accuracy > 40 && currentRecording.recording) {
                showToast("Sinal GPS fraco. Os pontos gravados podem ser imprecisos.", "warning");
            }
        }
        
        async function renderRouteDetailsView(frontId, routeId) {
            try {
                const front = await db.harvestFronts.get(parseInt(frontId));
                if (!front) {
                    showToast('Frente de colheita não encontrada', 'error');
                    showView('routes');
                    return;
                }
                
                const route = await db.routes.get(parseInt(routeId));
                if (!route) {
                    showToast('Rota não encontrada', 'error');
                    showView('routes');
                    return;
                }
                
                // Decompress path data if needed
                if (route.path && route.path._compressed) {
                    route.path = decompressPathData(route.path);
                }
                
                const appView = document.getElementById('app-view');
                appView.dataset.frontId = frontId;
                appView.dataset.routeId = routeId;
                
                const startDate = new Date(route.startTime);
                const endDate = route.endTime ? new Date(route.endTime) : null;
                const duration = endDate ? (endDate - startDate) / (1000 * 60) : null; // Minutes
                
                // Calculate distance if not already set
                let distance = route.distance;
                if (!distance && route.path && route.path.length >= 2) {
                    distance = calculateRouteDistance(route.path);
                    // Update route in database with calculated distance
                    await db.routes.update(route.id, { distance });
                }
                
                // Calculate statistics
                const avgSpeed = route.averageSpeed || (route.distance && route.duration ? (route.distance / (route.duration / 60)) : null);
                const maxSpeed = route.path ? Math.max(...route.path.map(p => p.speed || 0)) : 0;
                const elevationGain = route.elevationGain || 0;
                
                appView.innerHTML = `
                    <div class="fade-in">
                        <div class="flex items-center mb-3">
                            <button onclick="goBack()" class="mr-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 rounded-full p-1">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <h2 class="text-xl font-bold">${route.name || `Detalhes da Rota #${route.id}`}</h2>
                        </div>
                        
                        <div class="mb-4 flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${front.color}"></div>
                                <span class="text-gray-600 dark:text-gray-300">${front.name} - ${front.location}</span>
                            </div>
                            <span class="status-badge ${getStatusClass(route.status)}">
                                ${getStatusText(route.status)}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2">
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mb-6">
                                    <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                                        <h3 class="font-medium">Mapa da Rota</h3>
                                        <div class="flex space-x-2">
                                            <button onclick="toggleFullscreen('route-details-map')" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 rounded p-1">
                                                <i class="fas fa-expand"></i>
                                            </button>
                                            ${route.status === 'active' ? `
                                                <button onclick="showDriverNavigation(${frontId}, ${routeId})" class="bg-primary-500 hover:bg-primary-600 text-white px-3 py-1 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                                                    <i class="fas fa-location-arrow mr-1"></i> Navegar
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div id="route-details-map" class="map-container" style="height: 400px;"></div>
                                </div>
                                
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                                    <h3 class="font-medium mb-4">Estatísticas da Rota</h3>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg text-center">
                                            <div class="text-sm text-gray-500 dark:text-gray-400">Distância</div>
                                            <div class="text-lg font-semibold">${distance ? distance.toFixed(1) + ' km' : 'N/A'}</div>
                                        </div>
                                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg text-center">
                                            <div class="text-sm text-gray-500 dark:text-gray-400">Duração</div>
                                            <div class="text-lg font-semibold">${duration ? `${Math.floor(duration / 60)}h ${Math.floor(duration % 60)}m` : 'N/A'}</div>
                                        </div>
                                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg text-center">
                                            <div class="text-sm text-gray-500 dark:text-gray-400">Velocidade Média</div>
                                            <div class="text-lg font-semibold">${avgSpeed ? avgSpeed.toFixed(1) + ' km/h' : 'N/A'}</div>
                                        </div>
                                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg text-center">
                                            <div class="text-sm text-gray-500 dark:text-gray-400">Pontos</div>
                                            <div class="text-lg font-semibold">${route.path?.length || 0}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md mb-6">
                                    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="font-medium">Histórico de Pontos</h3>
                                    </div>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                            <thead class="bg-gray-50 dark:bg-gray-700">
                                                <tr>
                                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        #
                                                    </th>
                                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        Latitude
                                                    </th>
                                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        Longitude
                                                    </th>
                                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        Precisão
                                                    </th>
                                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        Velocidade
                                                    </th>
                                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        Hora
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                                ${route.path?.slice(0, 10).map((point, index) => {
                                                    const pointTime = new Date(point.timestamp);
                                                    return `
                                                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-200">
                                                                ${index + 1}
                                                            </td>
                                                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                                ${point.lat.toFixed(6)}
                                                            </td>
                                                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                                ${point.lng.toFixed(6)}
                                                            </td>
                                                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                                ${point.accuracy ? point.accuracy.toFixed(1) + ' m' : 'N/A'}
                                                            </td>
                                                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                                ${point.speed ? point.speed.toFixed(1) + ' km/h' : 'N/A'}
                                                            </td>
                                                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                                ${pointTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})}
                                                            </td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                                ${route.path?.length > 10 ? `
                                                    <tr>
                                                        <td colspan="6" class="px-3 py-2 text-center text-sm text-gray-500 dark:text-gray-400">
                                                            + ${route.path.length - 10} pontos adicionais
                                                        </td>
                                                    </tr>
                                                ` : ''}
                                                ${!route.path || route.path.length === 0 ? `
                                                    <tr>
                                                        <td colspan="6" class="px-3 py-2 text-center text-sm text-gray-500 dark:text-gray-400">
                                                            Nenhum ponto registrado
                                                        </td>
                                                    </tr>
                                                ` : ''}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                ${route.path && route.path.length > 0 ? `
                                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                                        <h3 class="font-medium mb-4">Gráfico de Velocidade</h3>
                                        <canvas id="speedChart" height="200"></canvas>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="lg:col-span-1">
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                                    <h3 class="font-medium mb-3">Informações da Rota</h3>
                                    <div class="space-y-3">
                                        ${route.name ? `
                                            <div class="flex justify-between">
                                                <span class="text-gray-500 dark:text-gray-400">Nome</span>
                                                <span class="font-medium">${route.name}</span>
                                            </div>
                                        ` : ''}
                                        ${route.description ? `
                                            <div class="flex justify-between">
                                                <span class="text-gray-500 dark:text-gray-400">Descrição</span>
                                                <span>${route.description}</span>
                                            </div>
                                        ` : ''}
                                        <div class="flex justify-between">
                                            <span class="text-gray-500 dark:text-gray-400">Data e Hora</span>
                                            <span>${startDate.toLocaleDateString()} ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                        </div>
                                        ${duration ? `
                                            <div class="flex justify-between">
                                                <span class="text-gray-500 dark:text-gray-400">Duração</span>
                                                <span>${Math.floor(duration / 60)}h ${Math.floor(duration % 60)}m</span>
                                            </div>
                                        ` : ''}
                                        <div class="flex justify-between">
                                            <span class="text-gray-500 dark:text-gray-400">Pontos Registrados</span>
                                            <span>${route.path?.length || 0}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-500 dark:text-gray-400">Distância</span>
                                            <span>${distance ? distance.toFixed(2) + ' km' : 'N/A'}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-500 dark:text-gray-400">Status</span>
                                            <span class="status-badge ${getStatusClass(route.status)}">
                                                ${getStatusText(route.status)}
                                            </span>
                                        </div>
                                        
                                        ${route.tags && route.tags.length > 0 ? `
                                            <div>
                                                <span class="text-gray-500 dark:text-gray-400 block mb-2">Tags</span>
                                                <div class="flex flex-wrap gap-2">
                                                    ${route.tags.map(tag => `
                                                        <span class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded-full text-xs">
                                                            ${tag}
                                                        </span>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                                    <h3 class="font-medium mb-3">Ações</h3>
                                    <div class="space-y-3">
                                        ${route.status === 'active' ? `
                                            <button onclick="showDriverNavigation(${frontId}, ${routeId})" class="w-full px-4 py-3 bg-primary-500 hover:bg-primary-600 text-white rounded-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                                <i class="fas fa-location-arrow mr-2"></i> Iniciar Navegação
                                            </button>
                                            <button onclick="completeRoute(${routeId})" class="w-full px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                                <i class="fas fa-check-circle mr-2"></i> Marcar Como Concluída
                                            </button>
                                        ` : ''}
                                        <button onclick="exportRouteData(${frontId}, ${routeId})" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                                            <i class="fas fa-download mr-2"></i> Exportar Dados
                                        </button>
                                        <button onclick="shareRoute(${frontId}, ${routeId})" class="w-full px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                            <i class="fas fa-share-alt mr-2"></i> Compartilhar
                                        </button>
                                        <button onclick="duplicateRoute(${routeId})" class="w-full px-4 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">
                                            <i class="fas fa-copy mr-2"></i> Duplicar Rota
                                        </button>
                                        <button onclick="deleteRoute(${frontId}, ${routeId})" class="w-full px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                                            <i class="fas fa-trash mr-2"></i> Excluir Rota
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="text-xs text-gray-500 dark:text-gray-400 p-4">
                                    <p>ID da Rota: ${route.id}</p>
                                    <p>Criada em: ${new Date(route.createdAt).toLocaleString()}</p>
                                    <p>Última atualização: ${new Date(route.updatedAt).toLocaleString()}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Initialize map for route details
                setTimeout(() => {
                    initRouteDetailsMap(route);
                }, 100);
                
                // Initialize speed chart if route has path data
                if (route.path && route.path.length > 0) {
                    setTimeout(() => {
                        initSpeedChart(route);
                    }, 200);
                }
                
            } catch (error) {
                console.error('Erro ao renderizar detalhes da rota:', error);
                showToast('Erro ao carregar detalhes da rota', 'error');
                showView('routes');
            }
        }
        
        function initSpeedChart(route) {
            const ctx = document.getElementById('speedChart');
            if (!ctx || !route.path || route.path.length === 0) return;
            
            // Extract speed and time data
            const speedData = [];
            const labels = [];
            
            // Sample the data to avoid too many points
            const sampleRate = Math.max(1, Math.floor(route.path.length / 50));
            
            for (let i = 0; i < route.path.length; i += sampleRate) {
                const point = route.path[i];
                speedData.push(point.speed || 0);
                
                // Format time as HH:MM
                const time = new Date(point.timestamp);
                labels.push(time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
            }
            
            // Detect dark mode for chart colors
            const isDarkMode = document.documentElement.classList.contains('dark');
            
            // Create the chart
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Velocidade (km/h)',
                        data: speedData,
                        borderColor: '#5D5CDE',
                        backgroundColor: 'rgba(93, 92, 222, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 1,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: isDarkMode ? '#e5e7eb' : '#374151'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y.toFixed(1)} km/h`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDarkMode ? '#e5e7eb' : '#374151',
                                callback: function(value) {
                                    return value + ' km/h';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: isDarkMode ? '#e5e7eb' : '#374151',
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
            
            // Update chart when dark mode changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                const isDarkMode = document.documentElement.classList.contains('dark');
                
                chart.options.scales.y.grid.color = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                chart.options.scales.y.ticks.color = isDarkMode ? '#e5e7eb' : '#374151';
                chart.options.scales.x.ticks.color = isDarkMode ? '#e5e7eb' : '#374151';
                chart.options.plugins.legend.labels.color = isDarkMode ? '#e5e7eb' : '#374151';
                
                chart.update();
            });
        }
        
        function toggleFullscreen(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (!document.fullscreenElement) {
                if (element.requestFullscreen) {
                    element.requestFullscreen();
                } else if (element.webkitRequestFullscreen) {
                    element.webkitRequestFullscreen();
                } else if (element.msRequestFullscreen) {
                    element.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }
        
        async function completeRoute(routeId) {
            try {
                const route = await db.routes.get(parseInt(routeId));
                if (!route) {
                    showToast('Rota não encontrada', 'error');
                    return;
                }
                
                showConfirmModal(
                    'Concluir Rota',
                    'Tem certeza que deseja marcar esta rota como concluída?',
                    async () => {
                        try {
                            showLoading('Atualizando rota...');
                            
                            const updates = {
                                status: 'completed',
                                endTime: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            };
                            
                            await db.routes.update(parseInt(routeId), updates);
                            
                            await addToSyncQueue('update', 'routes', routeId, {
                                ...route,
                                ...updates
                            });
                            
                            hideLoading();
                            showToast('Rota marcada como concluída com sucesso!', 'success');
                            
                            // Refresh the current view
                            showView('route-details', { 
                                params: { 
                                    frontId: route.frontId, 
                                    routeId: routeId 
                                },
                                replace: true
                            });
                        } catch (error) {
                            console.error('Erro ao atualizar rota:', error);
                            hideLoading();
                            showToast('Erro ao atualizar rota: ' + error.message, 'error');
                        }
                    }
                );
            } catch (error) {
                console.error('Erro ao preparar conclusão de rota:', error);
                showToast('Erro ao preparar conclusão de rota: ' + error.message, 'error');
            }
        }
        
        async function duplicateRoute(routeId) {
            try {
                const route = await db.routes.get(parseInt(routeId));
                if (!route) {
                    showToast('Rota não encontrada', 'error');
                    return;
                }
                
                showConfirmModal(
                    'Duplicar Rota',
                    'Deseja criar uma cópia desta rota?',
                    async () => {
                        try {
                            showLoading('Duplicando rota...');
                            
                            // Create a new route object based on the original
                            const newRoute = {
                                frontId: route.frontId,
                                name: `${route.name || 'Rota'} (Cópia)`,
                                description: route.description,
                                path: route.path,
                                startTime: new Date().toISOString(),
                                status: 'active',
                                distance: route.distance,
                                tags: route.tags,
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            };
                            
                            const newRouteId = await db.routes.add(newRoute);
                            
                            await addToSyncQueue('add', 'routes', newRouteId, newRoute);
                            
                            hideLoading();
                            showToast('Rota duplicada com sucesso!', 'success');
                            
                            // Navigate to the new route
                            showView('route-details', { 
                                params: { 
                                    frontId: route.frontId, 
                                    routeId: newRouteId 
                                }
                            });
                        } catch (error) {
                            console.error('Erro ao duplicar rota:', error);
                            hideLoading();
                            showToast('Erro ao duplicar rota: ' + error.message, 'error');
                        }
                    }
                );
            } catch (error) {
                console.error('Erro ao preparar duplicação de rota:', error);
                showToast('Erro ao preparar duplicação de rota: ' + error.message, 'error');
            }
        }
        
        async function renderDriverView() {
            try {
                const routes = await db.routes.toArray();
                const harvestFronts = await db.harvestFronts.toArray();
                const drivers = await db.drivers.toArray();
                
                // Process route paths for any that might be compressed
                routes.forEach(route => {
                    if (route.path && route.path._compressed) {
                        route.path = decompressPathData(route.path);
                    }
                });
                
                // Get active routes (completed or active)
                const activeRoutes = routes.filter(route => route.status === 'completed' || route.status === 'active');
                
                const appView = document.getElementById('app-view');
                appView.innerHTML = `
                    <div class="fade-in">
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Modo Motorista</h2>
                            ${AppState.currentUser && AppState.currentUser.role === 'leader' ? `
                                <button onclick="showView('drivers')" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg flex items-center focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                    <i class="fas fa-users mr-2"></i> Gerenciar Motoristas
                                </button>
                            ` : ''}
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
                                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                                    <h3 class="font-medium">Selecione uma Rota para Navegação</h3>
                                </div>
                                
                                ${activeRoutes.length > 0 ? `
                                    <div class="p-4">
                                        <div class="relative">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <i class="fas fa-search text-gray-400"></i>
                                            </div>
                                            <input type="text" id="driverRouteSearch" class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" placeholder="Buscar rotas...">
                                        </div>
                                    </div>
                                    
                                    <div class="p-4 space-y-3 max-h-[400px] overflow-y-auto" id="routesList">
                                        ${activeRoutes.map((route, index) => {
                                            const front = harvestFronts.find(f => f.id === route.frontId);
                                            const startDate = new Date(route.startTime);
                                            const assignedDriver = drivers.find(d => d.assignedFront === route.frontId && d.status === 'active');
                                            
                                            return `
                                                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors stagger-item" 
                                                     style="animation-delay: ${index * 100}ms" 
                                                     onclick="showDriverNavigation(${route.frontId}, ${route.id})"
                                                     data-route-name="${route.name || ''}"
                                                     data-front-name="${front?.name || ''}">
                                                    <div class="flex justify-between items-center">
                                                        <div class="flex items-center">
                                                            ${front ? `<div class="w-3 h-3 rounded-full mr-2" style="background-color: ${front.color}"></div>` : ''}
                                                            <h4 class="font-medium">${route.name || `Rota #${route.id}`}</h4>
                                                        </div>
                                                        <div class="text-sm text-gray-500 dark:text-gray-400">
                                                            ${startDate.toLocaleDateString()}
                                                        </div>
                                                    </div>
                                                    <div class="mt-2 flex justify-between items-center">
                                                        <div class="flex items-center text-sm text-gray-600 dark:text-gray-300">
                                                            <i class="fas fa-route mr-2"></i>
                                                            <span>${route.distance ? route.distance.toFixed(1) + ' km' : 'Distância não registrada'}</span>
                                                        </div>
                                                        <span class="status-badge ${getStatusClass(route.status)}">
                                                            ${getStatusText(route.status)}
                                                        </span>
                                                    </div>
                                                    ${front ? `
                                                        <div class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                                            <i class="fas fa-map-marker-alt mr-2"></i>
                                                            <span>${front.name} - ${front.location}</span>
                                                        </div>
                                                    ` : ''}
                                                    ${assignedDriver ? `
                                                        <div class="mt-2 flex items-center text-sm text-gray-600 dark:text-gray-300">
                                                            <i class="fas fa-user mr-2"></i>
                                                            <span>Motorista: ${assignedDriver.name}</span>
                                                        </div>
                                                    ` : ''}
                                                    ${route.tags && route.tags.length > 0 ? `
                                                        <div class="mt-2 flex flex-wrap gap-1">
                                                            ${route.tags.map(tag => `
                                                                <span class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-0.5 rounded-full text-xs">
                                                                    ${tag}
                                                                </span>
                                                            `).join('')}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : `
                                    <div class="text-center py-12 px-4 text-gray-500 dark:text-gray-400">
                                        <div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 mx-auto rounded-full flex items-center justify-center mb-4">
                                            <i class="fas fa-route text-gray-400 dark:text-gray-500 text-2xl"></i>
                                        </div>
                                        <p class="mb-4">Nenhuma rota disponível para navegação</p>
                                        ${AppState.currentUser && AppState.currentUser.role === 'leader' ? `
                                            <button onclick="showHarvestFrontsForRouteRecording()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                                Registrar Nova Rota
                                            </button>
                                        ` : ''}
                                    </div>
                                `}
                            </div>
                            
                            <div>
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5 mb-6">
                                    <h3 class="font-medium mb-3">Informações para Motoristas</h3>
                                    <div class="space-y-3 text-gray-600 dark:text-gray-300">
                                        <div class="flex items-start">
                                            <i class="fas fa-info-circle mt-1 mr-3 text-primary-500"></i>
                                            <p>Selecione uma rota ao lado para iniciar a navegação guiada.</p>
                                        </div>
                                        <div class="flex items-start">
                                            <i class="fas fa-map-marked-alt mt-1 mr-3 text-primary-500"></i>
                                            <p>O modo de navegação mostrará o trajeto completo e sua posição atual em tempo real.</p>
                                        </div>
                                        <div class="flex items-start">
                                            <i class="fas fa-truck mt-1 mr-3 text-primary-500"></i>
                                            <p>Mantenha o aplicativo aberto durante o trajeto para melhor precisão e registro de dados.</p>
                                        </div>
                                        <div class="flex items-start">
                                            <i class="fas fa-bell mt-1 mr-3 text-primary-500"></i>
                                            <p>Você receberá alertas de navegação quando estiver se aproximando de pontos importantes.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                ${AppState.currentUser && AppState.currentUser.role === 'leader' ? `
                                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="font-medium">Motoristas Disponíveis</h3>
                                            <a href="#" onclick="showView('add-driver')" class="text-sm text-primary-500 hover:text-primary-600 focus:outline-none focus:underline">
                                                Adicionar Motorista
                                            </a>
                                        </div>
                                        ${drivers.length > 0 ? `
                                            <div class="space-y-3 max-h-[250px] overflow-y-auto">
                                                ${drivers.filter(d => d.status === 'active').map((driver, index) => {
                                                    const assignedFront = harvestFronts.find(f => f.id === driver.assignedFront);
                                                    return `
                                                        <div class="flex items-center p-3 bg-gray-100 dark:bg-gray-700 rounded-lg stagger-item" style="animation-delay: ${index * 100}ms">
                                                            <div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900 text-primary-500 dark:text-primary-300 mr-3 flex items-center justify-center">
                                                                <i class="fas fa-user"></i>
                                                            </div>
                                                            <div class="flex-1">
                                                                <h5 class="font-medium">${driver.name}</h5>
                                                                <div class="flex items-center">
                                                                    <p class="text-sm text-gray-500 dark:text-gray-400">
                                                                        ${assignedFront ? `<span class="flex items-center"><i class="fas fa-tractor mr-1 text-xs"></i> ${assignedFront.name}</span>` : 'Nenhuma frente atribuída'}
                                                                    </p>
                                                                    ${driver.vehicleType ? `
                                                                        <p class="text-sm text-gray-500 dark:text-gray-400 ml-3">
                                                                            <i class="fas fa-truck-monster mr-1 text-xs"></i> ${driver.vehicleType}
                                                                        </p>
                                                                    ` : ''}
                                                                </div>
                                                            </div>
                                                            <span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                                                Ativo
                                                            </span>
                                                        </div>
                                                    `;
                                                }).join('')}
                                                ${drivers.filter(d => d.status === 'active').length === 0 ? `
                                                    <p class="text-gray-500 dark:text-gray-400 text-center py-4">Nenhum motorista ativo</p>
                                                ` : ''}
                                            </div>
                                        ` : `
                                            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                                                <p>Nenhum motorista cadastrado</p>
                                                <button onclick="showView('add-driver')" class="mt-2 text-primary-500 hover:text-primary-600 focus:outline-none focus:underline">
                                                    Adicionar Motorista
                                                </button>
                                            </div>
                                        `}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // Set up search functionality
                if (activeRoutes.length > 0) {
                    const searchInput = document.getElementById('driverRouteSearch');
                    if (searchInput) {
                        searchInput.addEventListener('input', function() {
                            const searchTerm = this.value.toLowerCase();
                            const routeItems = document.querySelectorAll('#routesList > div');
                            
                            routeItems.forEach(item => {
                                const routeName = (item.dataset.routeName || '').toLowerCase();
                                const frontName = (item.dataset.frontName || '').toLowerCase();
                                
                                if (routeName.includes(searchTerm) || frontName.includes(searchTerm)) {
                                    item.classList.remove('hidden');
                                } else {
                                    item.classList.add('hidden');
                                }
                            });
                        });
                    }
                }
                
            } catch (error) {
                console.error('Erro ao renderizar visão do motorista:', error);
                const appView = document.getElementById('app-view');
                appView.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 text-center">
                        <div class="w-16 h-16 bg-red-100 dark:bg-red-900 mx-auto rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-exclamation-triangle text-red-500 dark:text-red-300 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-medium mb-2">Erro ao carregar dados</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-4">${error.message || 'Não foi possível carregar os dados do motorista'}</p>
                        <button onclick="showView('driver')" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                            Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }
        
        async function showDriverNavigation(frontId, routeId) {
            try {
                const front = await db.harvestFronts.get(parseInt(frontId));
                if (!front) {
                    showToast('Frente de colheita não encontrada', 'error');
                    showView('driver');
                    return;
                }
                
                const route = await db.routes.get(parseInt(routeId));
                if (!route) {
                    showToast('Rota não encontrada', 'error');
                    showView('driver');
                    return;
                }
                
                // Decompress path data if needed
                if (route.path && route.path._compressed) {
                    route.path = decompressPathData(route.path);
                }
                
                const appView = document.getElementById('app-view');
                
                appView.innerHTML = `
                    <div class="fade-in h-full flex flex-col">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <button onclick="exitDriverNavigation()" class="mr-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 rounded-full p-1">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <h2 class="text-xl font-bold truncate">${route.name || `Rota #${route.id}`}</h2>
                            </div>
                            <div class="flex items-center">
                                <span class="status-badge ${getStatusClass(route.status)} mr-2">
                                    ${getStatusText(route.status)}
                                </span>
                                <div id="gps-signal-indicator" class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                    <i class="fas fa-satellite-dish mr-1"></i> GPS: <span id="gps-accuracy-value">--</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md flex-1 overflow-hidden">
                            <div id="navigation-map" class="w-full h-full"></div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3">
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-3 text-center">
                                <div class="text-sm text-gray-500 dark:text-gray-400">Distância</div>
                                <div id="navigation-distance" class="text-lg font-semibold">--</div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-3 text-center">
                                <div class="text-sm text-gray-500 dark:text-gray-400">Tempo</div>
                                <div id="navigation-time" class="text-lg font-semibold">--</div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-3 text-center">
                                <div class="text-sm text-gray-500 dark:text-gray-400">Velocidade</div>
                                <div id="navigation-speed" class="text-lg font-semibold">0 km/h</div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-3 text-center">
                                <div class="text-sm text-gray-500 dark:text-gray-400">Progresso</div>
                                <div id="navigation-progress" class="text-lg font-semibold">0%</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
                            <button id="start-navigation-btn" onclick="startNavigation()" class="px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                <i class="fas fa-play mr-2"></i> Iniciar Navegação
                            </button>
                            <button id="stop-navigation-btn" onclick="stopNavigation()" class="px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2" disabled>
                                <i class="fas fa-stop mr-2"></i> Parar Navegação
                            </button>
                            <button id="center-map-nav-btn" onclick="centerMapOnUserLocation()" class="px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                <i class="fas fa-crosshairs mr-2"></i> Centralizar Mapa
                            </button>
                        </div>
                        
                        <!-- Navigation alert container -->
                        <div id="navigation-alert" class="fixed bottom-20 left-0 right-0 mx-auto max-w-md bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 hidden transform transition-transform duration-300 translate-y-full">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 bg-blue-100 dark:bg-blue-900 rounded-full p-2">
                                    <i class="fas fa-info-circle text-blue-500 dark:text-blue-300 text-xl"></i>
                                </div>
                                <div class="ml-3 flex-1">
                                    <h3 id="alert-title" class="text-sm font-medium text-gray-900 dark:text-white">Alerta</h3>
                                    <p id="alert-message" class="mt-1 text-sm text-gray-500 dark:text-gray-400">Mensagem do alerta.</p>
                                </div>
                                <button onclick="dismissNavigationAlert()" class="flex-shrink-0 text-gray-400 hover:text-gray-500">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Initialize navigation map
                setTimeout(() => {
                    initNavigationMap(route);
                }, 100);
                
                // Listen for device orientation changes to resize map properly
                window.addEventListener('resize', () => {
                    if (navigationState.map) {
                        navigationState.map.invalidateSize();
                    }
                });
                
                // Start battery monitoring
                monitorBatteryStatus();
                
                // Set navigation state
                navigationState.routeId = routeId;
                navigationState.frontId = frontId;
                navigationState.route = route;
                
            } catch (error) {
                console.error('Erro ao iniciar navegação:', error);
                showToast('Erro ao iniciar navegação: ' + error.message, 'error');
                showView('driver');
            }
        }
        
        function initNavigationMap(route) {
            const mapContainer = document.getElementById('navigation-map');
            if (!mapContainer) return;
            
            try {
                // Create map
                const startPoint = [route.path[0].lat, route.path[0].lng];
                
                if (navigationState.map) {
                    navigationState.map.remove();
                    navigationState.map = null;
                }
                
                const map = L.map(mapContainer).setView(startPoint, 15);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // Create route path
                const routePath = route.path.map(point => [point.lat, point.lng]);
                
                // Create polyline for route
                const routePolyline = L.polyline(routePath, {
                    color: '#5D5CDE',
                    opacity: 1.0,
                    weight: 5
                }).addTo(map);
                
                // Create markers for start and end points
                const startIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: '<div style="background-color: #4CAF50; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                const startMarker = L.marker(routePath[0], {
                    icon: startIcon,
                    title: 'Início'
                }).addTo(map);
                
                const endIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: '<div style="background-color: #F44336; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                const endMarker = L.marker(routePath[routePath.length - 1], {
                    icon: endIcon,
                    title: 'Fim'
                }).addTo(map);
                
                // Fit map to route bounds
                const bounds = L.latLngBounds(routePath);
                map.fitBounds(bounds, { padding: [50, 50] });
                
                // Create position marker
                const positionIcon = L.divIcon({
                    className: 'position-marker',
                    html: '<div id="nav-arrow" style="transform: rotate(0deg); transition: transform 0.3s;"><i class="fas fa-location-arrow" style="color: #1E88E5; font-size: 24px; text-shadow: 0 0 2px white;"></i></div>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                
                const positionMarker = L.marker(startPoint, {
                    icon: positionIcon,
                    title: 'Sua posição'
                }).addTo(map);
                
                // Create accuracy circle
                const accuracyCircle = L.circle(startPoint, {
                    color: '#1E88E5',
                    fillColor: '#1E88E5',
                    fillOpacity: 0.2,
                    radius: 0,
                    weight: 1
                }).addTo(map);
                
                // Store map objects in navigation state
                navigationState.map = map;
                navigationState.routePolyline = routePolyline;
                navigationState.positionMarker = positionMarker;
                navigationState.accuracyCircle = accuracyCircle;
                navigationState.startMarker = startMarker;
                navigationState.endMarker = endMarker;
                
                // Add route markers at important points (every ~1/5 of the route)
                addRouteWaypoints(map, routePath);
                
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
                
            } catch (error) {
                console.error('Erro ao inicializar mapa de navegação:', error);
                showToast('Erro ao inicializar mapa de navegação', 'error');
            }
        }
        
        function addRouteWaypoints(map, routePath) {
            // Add waypoints every ~20% of the route
            const waypoints = [];
            const routeLength = routePath.length;
            
            if (routeLength <= 10) return; // Skip for very short routes
            
            // Calculate waypoint positions
            for (let i = 1; i < 5; i++) {
                const index = Math.floor((routeLength * i) / 5);
                waypoints.push({
                    position: routePath[index],
                    index: index
                });
            }
            
            // Create markers for waypoints
            waypoints.forEach((waypoint, idx) => {
                const icon = L.divIcon({
                    className: 'waypoint-icon',
                    html: `<div style="background-color: #FFC107; color: white; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">${idx + 1}</div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                const marker = L.marker(waypoint.position, {
                    icon: icon,
                    title: `Ponto ${idx + 1}`
                }).addTo(map);
                
                // Store waypoint in navigation state
                if (!navigationState.waypoints) navigationState.waypoints = [];
                navigationState.waypoints.push({
                    marker: marker,
                    index: waypoint.index,
                    passed: false
                });
            });
        }
        
        function startNavigation() {
            if (!navigationState.route || !navigationState.map) {
                showToast('Erro: Rota não disponível para navegação', 'error');
                return;
            }
            
            try {
                // Update UI
                document.getElementById('start-navigation-btn').disabled = true;
                document.getElementById('stop-navigation-btn').disabled = false;
                
                // Set navigation as active
                navigationState.active = true;
                navigationState.navigationStartTime = new Date();
                
                // Start tracking location
                if (navigator.geolocation) {
                    // Set accuracy options
                    const options = {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    };
                    
                    // Start watching position
                    navigationState.watchId = navigator.geolocation.watchPosition(
                        updateNavigation,
                        handleNavigationError,
                        options
                    );
                    
                    // Setup monitoring for location errors
                    setupLocationErrorHandling((message) => {
                        showToast(message, 'warning');
                    });
                    
                    showToast('Navegação iniciada!', 'success');
                    
                    // Show initial alert
                    showNavigationAlert('Navegação Iniciada', 'Siga o caminho destacado no mapa para chegar ao destino.');
                    
                    // Keep screen on if possible
                    keepScreenOn(true);
                } else {
                    showToast('Geolocalização não disponível no seu dispositivo', 'error');
                    stopNavigation();
                }
            } catch (error) {
                console.error('Erro ao iniciar navegação:', error);
                showToast('Erro ao iniciar navegação: ' + error.message, 'error');
                stopNavigation();
            }
        }
        
        function updateNavigation(position) {
            if (!navigationState.active || !navigationState.map) return;
            
            try {
                // Reset location error counter
                navigationState.locationErrors = 0;
                clearTimeout(navigationState.locationErrorTimeout);
                
                // Extract position data
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                const speed = position.coords.speed ? position.coords.speed * 3.6 : 0; // Convert m/s to km/h
                const heading = position.coords.heading || 0;
                
                // Update GPS signal indicator
                const gpsAccuracyElement = document.getElementById('gps-accuracy-value');
                const gpsSignalIndicator = document.getElementById('gps-signal-indicator');
                
                if (gpsAccuracyElement && gpsSignalIndicator) {
                    gpsAccuracyElement.textContent = `${accuracy.toFixed(0)}m`;
                    
                    // Update color based on accuracy
                    gpsSignalIndicator.className = 'text-xs px-2 py-1 rounded-full';
                    
                    if (accuracy <= 10) {
                        gpsSignalIndicator.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900', 'dark:text-green-200');
                    } else if (accuracy <= 30) {
                        gpsSignalIndicator.classList.add('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-900', 'dark:text-yellow-200');
                    } else {
                        gpsSignalIndicator.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-200');
                    }
                }
                
                // Update current position marker
                const latLng = [lat, lng];
                
                if (navigationState.positionMarker) {
                    navigationState.positionMarker.setLatLng(latLng);
                }
                
                // Update accuracy circle
                if (navigationState.accuracyCircle) {
                    navigationState.accuracyCircle.setLatLng(latLng);
                    navigationState.accuracyCircle.setRadius(accuracy);
                }
                
                // Update marker rotation based on heading if moving
                if (speed > 1 && heading !== null) {
                    if (navigationState.positionMarker) {
                        const markerElement = navigationState.positionMarker.getElement();
                        if (markerElement) {
                            const arrow = markerElement.querySelector('#nav-arrow');
                            if (arrow) {
                                arrow.style.transform = `rotate(${heading}deg)`;
                            }
                        }
                    }
                }
                
                // Calculate closest point on route
                const routePath = navigationState.route.path;
                const closest = findClosestPointOnRoute(routePath, { lat, lng });
                
                // Update navigation stats
                updateNavigationStats(closest, speed);
                
                // Check waypoints
                checkWaypoints(closest.index);
                
                // Center map on user location if auto-follow is enabled
                if (navigationState.autoFollow) {
                    navigationState.map.panTo(latLng);
                }
                
                // Store speed report for analysis
                navigationState.speedReports.push({
                    time: new Date(),
                    speed: speed,
                    position: { lat, lng },
                    accuracy: accuracy
                });
                
                // Keep only last 100 reports to save memory
                if (navigationState.speedReports.length > 100) {
                    navigationState.speedReports.shift();
                }
                
            } catch (error) {
                console.error('Erro ao atualizar navegação:', error);
            }
        }
        
        function findClosestPointOnRoute(routePath, currentPosition) {
            let closestPoint = null;
            let closestDistance = Infinity;
            let closestIndex = 0;
            
            for (let i = 0; i < routePath.length; i++) {
                const point = routePath[i];
                const distance = haversineDistance(
                    currentPosition.lat, currentPosition.lng,
                    point.lat, point.lng
                );
                
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestPoint = point;
                    closestIndex = i;
                }
            }
            
            return {
                point: closestPoint,
                distance: closestDistance * 1000, // Convert to meters
                index: closestIndex,
                progress: (closestIndex / (routePath.length - 1)) * 100
            };
        }
        
        function updateNavigationStats(closest, speed) {
            // Update distance
            const distanceElement = document.getElementById('navigation-distance');
            if (distanceElement) {
                // Calculate distance to end of route
                const routePath = navigationState.route.path;
                let remainingDistance = 0;
                
                for (let i = closest.index; i < routePath.length - 1; i++) {
                    remainingDistance += haversineDistance(
                        routePath[i].lat, routePath[i].lng,
                        routePath[i + 1].lat, routePath[i + 1].lng
                    );
                }
                
                navigationState.distanceToDestination = remainingDistance;
                distanceElement.textContent = `${remainingDistance.toFixed(1)} km`;
            }
            
            // Update time remaining
            const timeElement = document.getElementById('navigation-time');
            if (timeElement) {
                // Calculate estimated time based on speed
                const safeSpeed = Math.max(5, speed); // Assume at least 5 km/h to avoid division by zero
                const timeHours = navigationState.distanceToDestination / safeSpeed;
                const timeMinutes = timeHours * 60;
                
                navigationState.estimatedTimeToDestination = timeMinutes;
                
                if (timeMinutes < 1) {
                    timeElement.textContent = '< 1 min';
                } else if (timeMinutes < 60) {
                    timeElement.textContent = `${Math.round(timeMinutes)} min`;
                } else {
                    const hours = Math.floor(timeMinutes / 60);
                    const minutes = Math.round(timeMinutes % 60);
                    timeElement.textContent = `${hours}h ${minutes}min`;
                }
            }
            
            // Update speed
            const speedElement = document.getElementById('navigation-speed');
            if (speedElement) {
                speedElement.textContent = `${speed.toFixed(0)} km/h`;
            }
            
            // Update progress
            const progressElement = document.getElementById('navigation-progress');
            if (progressElement) {
                const progress = Math.min(100, Math.max(0, closest.progress)).toFixed(0);
                progressElement.textContent = `${progress}%`;
                
                // Approaching destination, notify if near end
                if (progress > 95 && navigationState.distanceToDestination < 0.2) { // Within 200m of destination
                    showNavigationAlert('Chegando ao Destino', 'Você está se aproximando do destino final. Preste atenção à sinalização.');
                }
            }
        }
        
        function checkWaypoints(currentRouteIndex) {
            if (!navigationState.waypoints) return;
            
            navigationState.waypoints.forEach(waypoint => {
                // Check if we've passed this waypoint
                if (!waypoint.passed && currentRouteIndex > waypoint.index) {
                    waypoint.passed = true;
                    
                    // Change marker icon to indicate passed waypoint
                    const marker = waypoint.marker;
                    const waypointNumber = navigationState.waypoints.indexOf(waypoint) + 1;
                    
                    const passedIcon = L.divIcon({
                        className: 'waypoint-icon',
                        html: `<div style="background-color: #4CAF50; color: white; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">${waypointNumber}</div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });
                    
                    marker.setIcon(passedIcon);
                    
                    // Show alert for reached waypoint
                    showNavigationAlert(`Ponto ${waypointNumber} Alcançado`, 'Continue seguindo a rota para o próximo ponto.');
                }
            });
        }
        
        function showNavigationAlert(title, message) {
            const alertContainer = document.getElementById('navigation-alert');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            
            if (alertContainer && alertTitle && alertMessage) {
                alertTitle.textContent = title;
                alertMessage.textContent = message;
                
                // Show alert with animation
                alertContainer.classList.remove('hidden', 'translate-y-full');
                alertContainer.classList.add('translate-y-0');
                
                // Auto-dismiss after 5 seconds
                setTimeout(dismissNavigationAlert, 5000);
            }
        }
        
        function dismissNavigationAlert() {
            const alertContainer = document.getElementById('navigation-alert');
            
            if (alertContainer) {
                alertContainer.classList.add('translate-y-full');
                setTimeout(() => {
                    alertContainer.classList.add('hidden');
                }, 300);
            }
        }
        
        function handleNavigationError(error) {
            // Count consecutive errors
            navigationState.locationErrors = (navigationState.locationErrors || 0) + 1;
            
            // Log the error
            console.error('Erro de geolocalização:', error);
            
            // Show error message based on the error code
            let message = 'Erro de geolocalização desconhecido';
            
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Permissão de geolocalização negada';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Informações de localização indisponíveis';
                    break;
                case error.TIMEOUT:
                    message = 'Tempo limite excedido ao obter localização';
                    break;
            }
            
            // Show toast after multiple errors
            if (navigationState.locationErrors >= 3) {
                showToast(message + '. Verifique se o GPS está ativado.', 'error');
            }
            
            // After 5 consecutive errors, suggest stopping navigation
            if (navigationState.locationErrors >= 5) {
                showNavigationAlert('Problemas com GPS', 'Temos enfrentado dificuldades em obter sua localização. Considere parar a navegação e tentar novamente mais tarde.');
            }
        }
        
        function setupLocationErrorHandling(errorCallback) {
            // Clear any existing timeout
            if (navigationState.locationErrorTimeout) {
                clearTimeout(navigationState.locationErrorTimeout);
            }
            
            // Set a timeout to check if we're still receiving location updates
            navigationState.locationErrorTimeout = setInterval(() => {
                if (navigationState.active) {
                    const lastUpdate = navigationState.lastLocationUpdate || 0;
                    const now = Date.now();
                    
                    // If no update in 30 seconds, trigger error
                    if (now - lastUpdate > 30000) {
                        errorCallback("Sinal GPS perdido. A navegação pode estar imprecisa.");
                        navigationState.locationErrors++;
                        
                        // After prolonged loss, suggest stopping
                        if (navigationState.locationErrors >= 3) {
                            showNavigationAlert('Sinal GPS Perdido', 'Não estamos recebendo atualizações de localização. Verifique se o GPS está ativado.');
                        }
                    }
                }
            }, 30000);
            
            return navigationState.locationErrorTimeout;
        }
        
        function stopNavigation() {
            // Clear watch position
            if (navigationState.watchId) {
                navigator.geolocation.clearWatch(navigationState.watchId);
                navigationState.watchId = null;
            }
            
            // Clear any timeouts
            clearTimeout(navigationState.locationErrorTimeout);
            
            // Update UI
            const startButton = document.getElementById('start-navigation-btn');
            const stopButton = document.getElementById('stop-navigation-btn');
            
            if (startButton) startButton.disabled = false;
            if (stopButton) stopButton.disabled = true;
            
            // Set navigation as inactive
            navigationState.active = false;
            
            // Allow screen to sleep again
            keepScreenOn(false);
            
            // Show toast
            showToast('Navegação parada', 'info');
        }
        
        function exitDriverNavigation() {
            // Make sure to stop navigation
            if (navigationState.active) {
                stopNavigation();
            }
            
            // Reset navigation state
            navigationState = {
                active: false,
                routeId: null,
                frontId: null,
                currentStep: 0,
                map: null,
                directionsRenderer: null,
                positionMarker: null,
                watchId: null,
                route: null,
                distanceToDestination: null,
                estimatedTimeToDestination: null,
                speedReports: [],
                nextWaypointIndex: 0,
                nextWaypointAlert: false,
                navigationStartTime: null,
                accuracyThreshold: 20,
                locationErrorTimeout: null,
                locationErrors: 0
            };
            
            // Go back to driver view
            showView('driver');
        }
        
        function centerMapOnUserLocation() {
            if (!navigationState.map || !navigationState.positionMarker) return;
            
            const position = navigationState.positionMarker.getPosition();
            if (position) {
                navigationState.map.panTo(position);
                navigationState.map.setZoom(18);
                
                // Enable auto-follow mode
                navigationState.autoFollow = true;
                showToast('Seguindo sua localização', 'info');
                
                // Disable auto-follow after 10 seconds
                setTimeout(() => {
                    navigationState.autoFollow = false;
                }, 10000);
            } else {
                showToast('Localização atual não disponível', 'warning');
            }
        }
        
        // Keep the screen on during navigation if possible
        function keepScreenOn(enabled) {
            try {
                if (enabled) {
                    if (navigator.wakeLock) {
                        navigator.wakeLock.request('screen')
                            .then(wakeLock => {
                                navigationState.wakeLock = wakeLock;
                                console.log('Wake Lock ativado');
                            })
                            .catch(err => {
                                console.error('Erro ao ativar Wake Lock:', err);
                            });
                    }
                } else {
                    if (navigationState.wakeLock) {
                        navigationState.wakeLock.release()
                            .then(() => {
                                console.log('Wake Lock desativado');
                                navigationState.wakeLock = null;
                            });
                    }
                }
            } catch (err) {
                console.error('Wake Lock não suportado:', err);
            }
        }
        
        async function renderDriversView() {
            try {
                const drivers = await db.drivers.toArray();
                const harvestFronts = await db.harvestFronts.toArray();
                
                const appView = document.getElementById('app-view');
                appView.innerHTML = `
                    <div class="fade-in">
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Motoristas</h2>
                            <div class="flex space-x-3">
                                <button onclick="showView('driver')" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg flex items-center focus:outline-none focus:ring-2 focus:ring-gray-500">
                                    <i class="fas fa-truck mr-2"></i> Modo Motorista
                                </button>
                                <button onclick="showView('add-driver')" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg flex items-center focus:outline-none focus:ring-2 focus:ring-primary-500">
                                    <i class="fas fa-plus mr-2"></i> Novo Motorista
                                </button>
                            </div>
                        </div>
                        
                        <!-- Search and Filter -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                            <div class="flex flex-wrap gap-4">
                                <div class="flex-1 min-w-[200px]">
                                    <label for="driverSearch" class="sr-only">Buscar motoristas</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-search text-gray-400"></i>
                                        </div>
                                        <input type="text" id="driverSearch" class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" placeholder="Buscar motoristas...">
                                    </div>
                                </div>
                                <div>
                                    <label for="driverStatusFilter" class="sr-only">Filtrar por status</label>
                                    <select id="driverStatusFilter" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                                        <option value="all">Todos os status</option>
                                        <option value="active">Ativos</option>
                                        <option value="inactive">Inativos</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="driverFrontFilter" class="sr-only">Filtrar por frente</label>
                                    <select id="driverFrontFilter" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                                        <option value="all">Todas as frentes</option>
                                        ${harvestFronts.map(front => `<option value="${front.id}">${front.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Drivers List -->
                        ${drivers.length > 0 ? `
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mb-6">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-700">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    Nome
                                                </th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    Contato
                                                </th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    Frente Atribuída
                                                </th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    Veículo
                                                </th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    Status
                                                </th>
                                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    Ações
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="driversTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            ${drivers.map((driver, index) => {
                                                const front = harvestFronts.find(f => f.id === driver.assignedFront);
                                                
                                                return `
                                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors stagger-item" 
                                                        style="animation-delay: ${index * 50}ms"
                                                        data-driver-id="${driver.id}"
                                                        data-driver-name="${driver.name}"
                                                        data-driver-status="${driver.status}"
                                                        data-driver-front="${driver.assignedFront || ''}">
                                                        <td class="px-6 py-4 whitespace-nowrap">
                                                            <div class="flex items-center">
                                                                <div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900 text-primary-500 dark:text-primary-300 flex items-center justify-center mr-3">
                                                                    <i class="fas fa-user"></i>
                                                                </div>
                                                                <div>
                                                                    <div class="font-medium">${driver.name}</div>
                                                                    <div class="text-sm text-gray-500 dark:text-gray-400">${driver.experience || 'Experiência não informada'}</div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td class="px-6 py-4 whitespace-nowrap">
                                                            <div class="text-sm">${driver.phone || 'N/A'}</div>
                                                            <div class="text-sm text-gray-500 dark:text-gray-400">CNH: ${driver.license || 'N/A'}</div>
                                                        </td>
                                                        <td class="px-6 py-4 whitespace-nowrap">
                                                            ${front ? `
                                                                <div class="flex items-center">
                                                                    <div class="w-2 h-2 rounded-full mr-2" style="background-color: ${front.color}"></div>
                                                                    <span>${front.name}</span>
                                                                </div>
                                                            ` : 'Nenhuma frente atribuída'}
                                                        </td>
                                                        <td class="px-6 py-4 whitespace-nowrap">
                                                            <div class="text-sm">${driver.vehicleType || 'N/A'}</div>
                                                            <div class="text-sm text-gray-500 dark:text-gray-400">${driver.vehiclePlate || 'N/A'}</div>
                                                        </td>
                                                        <td class="px-6 py-4 whitespace-nowrap">
                                                            <span class="text-xs px-2 py-1 rounded-full ${driver.status === 'active' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'}">
                                                                ${driver.status === 'active' ? 'Ativo' : 'Inativo'}
                                                            </span>
                                                        </td>
                                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                            <div class="flex justify-end space-x-2">
                                                                <button onclick="editDriver(${driver.id})" class="text-primary-500 hover:text-primary-600 p-1" aria-label="Editar">
                                                                    <i class="fas fa-pencil-alt"></i>
                                                                </button>
                                                                <button onclick="toggleDriverStatus(${driver.id}, '${driver.status === 'active' ? 'inactive' : 'active'}')" class="text-blue-500 hover:text-blue-600 p-1" aria-label="${driver.status === 'active' ? 'Desativar' : 'Ativar'}">
                                                                    <i class="fas fa-${driver.status === 'active' ? 'pause' : 'play'}"></i>
                                                                </button>
                                                                <button onclick="deleteDriver(${driver.id})" class="text-red-500 hover:text-red-600 p-1" aria-label="Excluir">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Empty state for filtered results -->
                            <div id="noDriversMessage" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 text-center">
                                <div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 mx-auto rounded-full flex items-center justify-center mb-4">
                                    <i class="fas fa-search text-gray-400 dark:text-gray-500 text-2xl"></i>
                                </div>
                                <h3 class="text-lg font-medium mb-2">Nenhum motorista encontrado</h3>
                                <p class="text-gray-500 dark:text-gray-400 mb-4">Tente ajustar os filtros ou realizar uma nova busca.</p>
                                <button onclick="resetDriverFilters()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                    Limpar Filtros
                                </button>
                            </div>
                        ` : `
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 text-center">
                                <div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 mx-auto rounded-full flex items-center justify-center mb-4">
                                    <i class="fas fa-user text-gray-400 dark:text-gray-500 text-2xl"></i>
                                </div>
                                <h3 class="text-lg font-medium mb-2">Nenhum motorista cadastrado</h3>
                                <p class="text-gray-500 dark:text-gray-400 mb-4">Adicione seu primeiro motorista para atribuí-lo a uma frente de colheita.</p>
                                <button onclick="showView('add-driver')" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                    <i class="fas fa-plus mr-2"></i> Adicionar Motorista
                                </button>
                            </div>
                        `}
                        
                        <!-- Driver Statistics -->
                        ${drivers.length > 0 ? `
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                                    <h3 class="font-medium mb-2">Status dos Motoristas</h3>
                                    <div class="flex-1 space-y-2">
                                        <div>
                                            <div class="flex justify-between text-sm text-gray-600 dark:text-gray-300 mb-1">
                                                <span>Ativos</span>
                                                <span>${drivers.filter(d => d.status === 'active').length}/${drivers.length}</span>
                                            </div>
                                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                                <div class="bg-green-500 h-2 rounded-full" style="width: ${(drivers.filter(d => d.status === 'active').length / Math.max(drivers.length, 1)) * 100}%"></div>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="flex justify-between text-sm text-gray-600 dark:text-gray-300 mb-1">
                                                <span>Atribuídos a Frentes</span>
                                                <span>${drivers.filter(d => d.assignedFront).length}/${drivers.length}</span>
                                            </div>
                                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                                <div class="bg-blue-500 h-2 rounded-full" style="width: ${(drivers.filter(d => d.assignedFront).length / Math.max(drivers.length, 1)) * 100}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 col-span-2">
                                    <h3 class="font-medium mb-2">Distribuição por Frentes</h3>
                                    <div class="space-y-2">
                                        ${harvestFronts.map(front => {
                                            const count = drivers.filter(d => d.assignedFront === front.id).length;
                                            const percentage = (count / Math.max(drivers.length, 1)) * 100;
                                            
                                            return `
                                                <div>
                                                    <div class="flex justify-between text-sm text-gray-600 dark:text-gray-300 mb-1">
                                                        <div class="flex items-center">
                                                            <div class="w-2 h-2 rounded-full mr-2" style="background-color: ${front.color}"></div>
                                                            <span>${front.name}</span>
                                                        </div>
                                                        <span>${count} motorista${count !== 1 ? 's' : ''}</span>
                                                    </div>
                                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                                        <div class="h-2 rounded-full" style="background-color: ${front.color}; width: ${percentage}%"></div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                        
                                        ${(() => {
                                            const unassignedCount = drivers.filter(d => !d.assignedFront).length;
                                            const percentage = (unassignedCount / Math.max(drivers.length, 1)) * 100;
                                            
                                            return `
                                                <div>
                                                    <div class="flex justify-between text-sm text-gray-600 dark:text-gray-300 mb-1">
                                                        <span>Não atribuídos</span>
                                                        <span>${unassignedCount} motorista${unassignedCount !== 1 ? 's' : ''}</span>
                                                    </div>
                                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                                        <div class="bg-gray-400 h-2 rounded-full" style="width: ${percentage}%"></div>
                                                    </div>
                                                </div>
                                            `;
                                        })()}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // Set up search and filtering
                if (drivers.length > 0) {
                    const searchInput = document.getElementById('driverSearch');
                    const statusFilter = document.getElementById('driverStatusFilter');
                    const frontFilter = document.getElementById('driverFrontFilter');
                    
                    if (searchInput && statusFilter && frontFilter) {
                        searchInput.addEventListener('input', filterDrivers);
                        statusFilter.addEventListener('change', filterDrivers);
                        frontFilter.addEventListener('change', filterDrivers);
                    }
                }
                
            } catch (error) {
                console.error('Erro ao renderizar lista de motoristas:', error);
                const appView = document.getElementById('app-view');
                appView.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 text-center">
                        <div class="w-16 h-16 bg-red-100 dark:bg-red-900 mx-auto rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-exclamation-triangle text-red-500 dark:text-red-300 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-medium mb-2">Erro ao carregar motoristas</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-4">${error.message || 'Não foi possível carregar os motoristas'}</p>
                        <button onclick="showView('drivers')" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                            Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }
        
        function filterDrivers() {
            const searchInput = document.getElementById('driverSearch');
            const statusFilter = document.getElementById('driverStatusFilter');
            const frontFilter = document.getElementById('driverFrontFilter');
            const driversTable = document.getElementById('driversTableBody');
            const noDriversMessage = document.getElementById('noDriversMessage');
            
            if (!searchInput || !statusFilter || !frontFilter || !driversTable || !noDriversMessage) return;
            
            const searchTerm = searchInput.value.toLowerCase();
            const statusValue = statusFilter.value;
            const frontValue = frontFilter.value;
            
            const rows = driversTable.querySelectorAll('tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const driverName = (row.dataset.driverName || '').toLowerCase();
                const driverStatus = row.dataset.driverStatus;
                const driverFront = row.dataset.driverFront;
                
                const matchesSearch = driverName.includes(searchTerm);
                const matchesStatus = statusValue === 'all' || driverStatus === statusValue;
                const matchesFront = frontValue === 'all' || driverFront === frontValue;
                
                if (matchesSearch && matchesStatus && matchesFront) {
                    row.classList.remove('hidden');
                    visibleCount++;
                } else {
                    row.classList.add('hidden');
                }
            });
            
            // Show/hide no drivers message
            if (visibleCount === 0) {
                driversTable.parentElement.parentElement.classList.add('hidden');
                noDriversMessage.classList.remove('hidden');
            } else {
                driversTable.parentElement.parentElement.classList.remove('hidden');
                noDriversMessage.classList.add('hidden');
            }
        }
        
        function resetDriverFilters() {
            const searchInput = document.getElementById('driverSearch');
            const statusFilter = document.getElementById('driverStatusFilter');
            const frontFilter = document.getElementById('driverFrontFilter');
            
            if (searchInput) searchInput.value = '';
            if (statusFilter) statusFilter.value = 'all';
            if (frontFilter) frontFilter.value = 'all';
            
            filterDrivers();
        }
        
        async function renderAddDriverView() {
            try {
                const harvestFronts = await db.harvestFronts.toArray();
                
                const appView = document.getElementById('app-view');
                appView.innerHTML = `
                    <div class="fade-in">
                        <div class="flex items-center mb-6">
                            <button onclick="goBack()" class="mr-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 rounded-full p-1">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <h2 class="text-2xl font-bold">Novo Motorista</h2>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
                            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                                <h3 class="font-medium">Informações do Motorista</h3>
                            </div>
                            <form id="addDriverForm" onsubmit="saveDriver(event)" class="p-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <div class="mb-4">
                                            <label for="driverName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nome Completo *</label>
                                            <input type="text" id="driverName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base" required>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="driverPhone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Telefone</label>
                                            <input type="tel" id="driverPhone" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base" placeholder="(00) 00000-0000">
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="driverLicense" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">CNH</label>
                                            <input type="text" id="driverLicense" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base">
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="driverExperience" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Experiência</label>
                                            <input type="text" id="driverExperience" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base" placeholder="Ex: 5 anos">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <div class="mb-4">
                                            <label for="driverVehicleType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tipo de Veículo</label>
                                            <select id="driverVehicleType" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base">
                                                <option value="">Selecione um tipo de veículo</option>
                                                <option value="Caminhão">Caminhão</option>
                                                <option value="Trator">Trator</option>
                                                <option value="Colheitadeira">Colheitadeira</option>
                                                <option value="Caminhonete">Caminhonete</option>
                                                <option value="Outro">Outro</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="driverVehiclePlate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Placa do Veículo</label>
                                            <input type="text" id="driverVehiclePlate" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base" placeholder="ABC-1234">
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="driverAssignedFront" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Frente Atribuída</label>
                                            <select id="driverAssignedFront" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base">
                                                <option value="">Nenhuma frente atribuída</option>
                                                ${harvestFronts.filter(front => front.status === 'active').map(front => `
                                                    <option value="${front.id}">${front.name}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                                            <div class="flex space-x-4">
                                                <label class="inline-flex items-center">
                                                    <input type="radio" name="driverStatus" value="active" class="form-radio text-primary-500" checked>
                                                    <span class="ml-2">Ativo</span>
                                                </label>
                                                <label class="inline-flex items-center">
                                                    <input type="radio" name="driverStatus" value="inactive" class="form-radio text-gray-500">
                                                    <span class="ml-2">Inativo</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-6 flex justify-end space-x-3">
                                    <button type="button" onclick="goBack()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                        Salvar Motorista
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-200">
                            <div class="flex">
                                <i class="fas fa-info-circle mt-1 mr-2"></i>
                                <div>
                                    <p class="text-sm">Após cadastrar um motorista, você poderá:</p>
                                    <ul class="list-disc list-inside text-sm mt-2 ml-2">
                                        <li>Atribuí-lo a uma frente de colheita</li>
                                        <li>Acompanhar seu desempenho nos relatórios</li>
                                        <li>Gerenciar suas permissões no sistema</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add phone mask if any masking library is available
                const phoneInput = document.getElementById('driverPhone');
                if (phoneInput) {
                    phoneInput.addEventListener('input', function(e) {
                        const x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/);
                        e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
                    });
                }
                
                // Add vehicle plate mask
                const plateInput = document.getElementById('driverVehiclePlate');
                if (plateInput) {
                    plateInput.addEventListener('input', function(e) {
                        // Basic Brazilian plate format: AAA-1234 or new Mercosul format
                        let value = e.target.value.toUpperCase();
                        
                        // Remove anything that's not letter, number, or hyphen
                        value = value.replace(/[^A-Z0-9-]/g, '');
                        
                        // Insert hyphen if needed
                        if (value.length > 3 && value.charAt(3) !== '-') {
                            value = value.slice(0, 3) + '-' + value.slice(3);
                        }
                        
                        // Limit to 8 characters (AAA-1234)
                        if (value.length > 8) {
                            value = value.slice(0, 8);
                        }
                        
                        e.target.value = value;
                    });
                }
                
            } catch (error) {
                console.error('Erro ao renderizar adição de motorista:', error);
                const appView = document.getElementById('app-view');
                appView.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 text-center">
                        <div class="w-16 h-16 bg-red-100 dark:bg-red-900 mx-auto rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-exclamation-triangle text-red-500 dark:text-red-300 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-medium mb-2">Erro ao carregar formulário</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-4">${error.message || 'Não foi possível carregar o formulário'}</p>
                        <button onclick="goBack()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                            Voltar
                        </button>
                    </div>
                `;
            }
        }
        
        async function renderEditDriverView(driverId) {
            try {
                const driver = await db.drivers.get(parseInt(driverId));
                if (!driver) {
                    showToast('Motorista não encontrado', 'error');
                    showView('drivers');
                    return;
                }
                
                const harvestFronts = await db.harvestFronts.toArray();
                
                const appView = document.getElementById('app-view');
                appView.innerHTML = `
                    <div class="fade-in">
                        <div class="flex items-center mb-6">
                            <button onclick="goBack()" class="mr-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 rounded-full p-1">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <h2 class="text-2xl font-bold">Editar Motorista</h2>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
                            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center">
                                <div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900 text-primary-500 dark:text-primary-300 mr-3 flex items-center justify-center">
                                    <i class="fas fa-user"></i>
                                </div>
                                <h3 class="font-medium">${driver.name}</h3>
                            </div>
                            <form id="editDriverForm" onsubmit="updateDriver(event, ${driver.id})" class="p-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <div class="mb-4">
                                            <label for="driverName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nome Completo *</label>
                                            <input type="text" id="driverName" value="${driver.name}" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base" required>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="driverPhone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Telefone</label>
                                            <input type="tel" id="driverPhone" value="${driver.phone || ''}" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base" placeholder="(00) 00000-0000">
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="driverLicense" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">CNH</label>
                                            <input type="text" id="driverLicense" value="${driver.license || ''}" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base">
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="driverExperience" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Experiência</label>
                                            <input type="text" id="driverExperience" value="${driver.experience || ''}" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base" placeholder="Ex: 5 anos">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <div class="mb-4">
                                            <label for="driverVehicleType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tipo de Veículo</label>
                                            <select id="driverVehicleType" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base">
                                                <option value="" ${!driver.vehicleType ? 'selected' : ''}>Selecione um tipo de veículo</option>
                                                <option value="Caminhão" ${driver.vehicleType === 'Caminhão' ? 'selected' : ''}>Caminhão</option>
                                                <option value="Trator" ${driver.vehicleType === 'Trator' ? 'selected' : ''}>Trator</option>
                                                <option value="Colheitadeira" ${driver.vehicleType === 'Colheitadeira' ? 'selected' : ''}>Colheitadeira</option>
                                                <option value="Caminhonete" ${driver.vehicleType === 'Caminhonete' ? 'selected' : ''}>Caminhonete</option>
                                                <option value="Outro" ${driver.vehicleType === 'Outro' ? 'selected' : ''}>Outro</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="driverVehiclePlate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Placa do Veículo</label>
                                            <input type="text" id="driverVehiclePlate" value="${driver.vehiclePlate || ''}" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base" placeholder="ABC-1234">
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="driverAssignedFront" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Frente Atribuída</label>
                                            <select id="driverAssignedFront" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-base">
                                                <option value="" ${!driver.assignedFront ? 'selected' : ''}>Nenhuma frente atribuída</option>
                                                ${harvestFronts.filter(front => front.status === 'active').map(front => `
                                                    <option value="${front.id}" ${driver.assignedFront === front.id ? 'selected' : ''}>${front.name}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                                            <div class="flex space-x-4">
                                                <label class="inline-flex items-center">
                                                    <input type="radio" name="driverStatus" value="active" class="form-radio text-primary-500" ${driver.status === 'active' ? 'checked' : ''}>
                                                    <span class="ml-2">Ativo</span>
                                                </label>
                                                <label class="inline-flex items-center">
                                                    <input type="radio" name="driverStatus" value="inactive" class="form-radio text-gray-500" ${driver.status === 'inactive' ? 'checked' : ''}>
                                                    <span class="ml-2">Inativo</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-6 flex justify-end space-x-3">
                                    <button type="button" onclick="goBack()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                        Atualizar Motorista
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="mt-4 text-sm text-gray-500 dark:text-gray-400">
                            <p>Criado em: ${new Date(driver.createdAt).toLocaleString()}</p>
                            <p>Última atualização: ${new Date(driver.updatedAt).toLocaleString()}</p>
                        </div>
                    </div>
                `;
                
                // Add phone mask if any masking library is available
                const phoneInput = document.getElementById('driverPhone');
                if (phoneInput) {
                    phoneInput.addEventListener('input', function(e) {
                        const x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/);
                        e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
                    });
                }
                
                // Add vehicle plate mask
                const plateInput = document.getElementById('driverVehiclePlate');
                if (plateInput) {
                    plateInput.addEventListener('input', function(e) {
                        // Basic Brazilian plate format: AAA-1234 or new Mercosul format
                        let value = e.target.value.toUpperCase();
                        
                        // Remove anything that's not letter, number, or hyphen
                        value = value.replace(/[^A-Z0-9-]/g, '');
                        
                        // Insert hyphen if needed
                        if (value.length > 3 && value.charAt(3) !== '-') {
                            value = value.slice(0, 3) + '-' + value.slice(3);
                        }
                        
                        // Limit to 8 characters (AAA-1234)
                        if (value.length > 8) {
                            value = value.slice(0, 8);
                        }
                        
                        e.target.value = value;
                    });
                }
                
            } catch (error) {
                console.error('Erro ao renderizar edição de motorista:', error);
                showToast('Erro ao carregar dados do motorista', 'error');
                showView('drivers');
            }
        }
        
        async function renderReportsView() {
            try {
                // Fetch data
                const routes = await db.routes.toArray();
                const harvestFronts = await db.harvestFronts.toArray();
                const drivers = await db.drivers.toArray();
                
                // Process route paths for any that might be compressed
                routes.forEach(route => {
                    if (route.path && route.path._compressed) {
                        route.path = decompressPathData(route.path);
                    }
                });
                
                // Calculate statistics
                const totalDistance = routes.reduce((sum, route) => sum + (route.distance || 0), 0);
                const totalTime = routes.reduce((sum, route) => sum + (route.duration || 0), 0); // minutes
                const completedRoutes = routes.filter(route => route.status === 'completed').length;
                const activeRoutes = routes.filter(route => route.status === 'active').length;
                
                // Calculate average speed
                const avgSpeed = totalTime > 0 ? (totalDistance / (totalTime / 60)) : 0;
                
                // Get daily activity data for chart
                const dailyActivity = calculateDailyActivity(routes);
                
                // Prepare front distribution data
                const frontDistribution = calculateFrontDistribution(routes, harvestFronts);
                
                const appView = document.getElementById('app-view');
                appView.innerHTML = `
                    <div class="fade-in">
                        <div class="flex flex-wrap items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold">Relatórios</h2>
                            <div class="flex space-x-2">
                                <button onclick="exportReports()" class="flex items-center px-3 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                                    <i class="fas fa-download mr-2"></i>
                                    Exportar
                                </button>
                                <button onclick="printReports()" class="flex items-center px-3 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg text-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500">
                                    <i class="fas fa-print mr-2"></i>
                                    Imprimir
                                </button>
                            </div>
                        </div>
                        
                        <!-- Date Range Filter -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                            <div class="flex flex-wrap items-center gap-4">
                                <div>
                                    <label for="dateRangeSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Período</label>
                                    <select id="dateRangeSelect" onchange="updateReportDateRange()" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                                        <option value="week">Últimos 7 dias</option>
                                        <option value="month">Último mês</option>
                                        <option value="quarter">Últimos 3 meses</option>
                                        <option value="year">Último ano</option>
                                        <option value="all">Todo o período</option>
                                        <option value="custom">Personalizado</option>
                                    </select>
                                </div>
                                
                                <div id="customDateContainer" class="hidden flex-grow flex flex-wrap gap-4">
                                    <div>
                                        <label for="startDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data Inicial</label>
                                        <input type="date" id="startDate" onchange="updateReportDateRange()" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                                    </div>
                                    <div>
                                        <label for="endDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data Final</label>
                                        <input type="date" id="endDate" onchange="updateReportDateRange()" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                                    </div>
                                </div>
                                
                                <div class="ml-auto">
                                    <label for="frontFilter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Frente</label>
                                    <select id="frontFilter" onchange="updateReportFrontFilter()" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                                        <option value="all">Todas as frentes</option>
                                        ${harvestFronts.map(front => `<option value="${front.id}">${front.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Summary Stats -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 print-break">
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Distância Total</p>
                                        <h3 class="text-2xl font-bold">${totalDistance.toFixed(1)}<span class="text-lg font-normal ml-1">km</span></h3>
                                    </div>
                                    <div class="p-2 bg-green-100 dark:bg-green-900 rounded-full">
                                        <i class="fas fa-road text-green-500 dark:text-green-300"></i>
                                    </div>
                                </div>
                                <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                                    ${routes.length > 0 ? `${(totalDistance / routes.length).toFixed(1)} km por rota em média` : 'Nenhuma rota registrada'}
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Tempo Total</p>
                                        <h3 class="text-2xl font-bold">${Math.floor(totalTime / 60)}<span class="text-lg font-normal ml-1">h</span> ${Math.floor(totalTime % 60)}<span class="text-lg font-normal ml-1">min</span></h3>
                                    </div>
                                    <div class="p-2 bg-blue-100 dark:bg-blue-900 rounded-full">
                                        <i class="fas fa-clock text-blue-500 dark:text-blue-300"></i>
                                    </div>
                                </div>
                                <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                                    ${routes.length > 0 ? `${(totalTime / routes.length).toFixed(0)} min por rota em média` : 'Nenhuma rota registrada'}
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Velocidade Média</p>
                                        <h3 class="text-2xl font-bold">${avgSpeed.toFixed(1)}<span class="text-lg font-normal ml-1">km/h</span></h3>
                                    </div>
                                    <div class="p-2 bg-amber-100 dark:bg-amber-900 rounded-full">
                                        <i class="fas fa-tachometer-alt text-amber-500 dark:text-amber-300"></i>
                                    </div>
                                </div>
                                <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                                    Baseado em ${completedRoutes} rotas concluídas
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Total de Rotas</p>
                                        <h3 class="text-2xl font-bold">${routes.length}</h3>
                                    </div>
                                    <div class="p-2 bg-purple-100 dark:bg-purple-900 rounded-full">
                                        <i class="fas fa-route text-purple-500 dark:text-purple-300"></i>
                                    </div>
                                </div>
                                <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                                    ${completedRoutes} concluídas, ${activeRoutes} ativas
                                </div>
                            </div>
                        </div>
                        
                        <!-- Charts Row -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5">
                                <h3 class="font-medium mb-4">Atividade Diária</h3>
                                <canvas id="dailyActivityChart" height="250"></canvas>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5">
                                <h3 class="font-medium mb-4">Distribuição por Frentes</h3>
                                <canvas id="frontDistributionChart" height="250"></canvas>
                            </div>
                        </div>
                        
                        <!-- Routes by Front Table -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mb-6 print-break">
                            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                                <h3 class="font-medium">Resumo por Frentes de Colheita</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                    <thead class="bg-gray-50 dark:bg-gray-700">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                Frente
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                Rotas
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                Distância Total
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                Tempo Total
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                Velocidade Média
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                        ${frontDistribution.map(item => `
                                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex items-center">
                                                        <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${item.color}"></div>
                                                        <span class="font-medium">${item.name}</span>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    ${item.count}
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    ${item.distance.toFixed(1)} km
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    ${Math.floor(item.duration / 60)}h ${Math.floor(item.duration % 60)}min
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    ${item.duration > 0 ? (item.distance / (item.duration / 60)).toFixed(1) : '0'} km/h
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Top Routes -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mb-6">
                            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                                <h3 class="font-medium">Rotas Mais Longas</h3>
                                <span class="text-sm text-gray-500 dark:text-gray-400">Top 5 por distância</span>
                            </div>
                            ${routes.length > 0 ? `
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-700">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    Rota
                                                </th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    Frente
                                                </th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    Data
                                                </th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    Distância
                                                </th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    Duração
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            ${routes
                                                .filter(route => route.distance)
                                                .sort((a, b) => b.distance - a.distance)
                                                .slice(0, 5)
                                                .map(route => {
                                                    const front = harvestFronts.find(f => f.id === route.frontId);
                                                    const startDate = new Date(route.startTime);
                                                    
                                                    return `
                                                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                                            <td class="px-6 py-4 whitespace-nowrap font-medium">
                                                                ${route.name || `Rota #${route.id}`}
                                                            </td>
                                                            <td class="px-6 py-4 whitespace-nowrap">
                                                                ${front ? `
                                                                    <div class="flex items-center">
                                                                        <div class="w-2 h-2 rounded-full mr-2" style="background-color: ${front.color}"></div>
                                                                        <span>${front.name}</span>
                                                                    </div>
                                                                ` : 'N/A'}
                                                            </td>
                                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">
                                                                ${startDate.toLocaleDateString()}
                                                            </td>
                                                            <td class="px-6 py-4 whitespace-nowrap font-medium">
                                                                ${route.distance.toFixed(1)} km
                                                            </td>
                                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">
                                                                ${route.duration ? `${Math.floor(route.duration / 60)}h ${Math.floor(route.duration % 60)}min` : 'N/A'}
                                                            </td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : `
                                <div class="p-8 text-center text-gray-500 dark:text-gray-400">
                                    Nenhuma rota registrada no período selecionado
                                </div>
                            `}
                        </div>
                        
                        <!-- Footer -->
                        <div class="text-sm text-gray-500 dark:text-gray-400 text-center mb-4">
                            <p>Relatório gerado em ${new Date().toLocaleString()}</p>
                            <p>HarvestManager v2.1.0</p>
                        </div>
                    </div>
                `;
                
                // Initialize charts
                setTimeout(() => {
                    initDailyActivityChart(dailyActivity);
                    initFrontDistributionChart(frontDistribution);
                }, 100);
                
                // Set up custom date range toggling
                const dateRangeSelect = document.getElementById('dateRangeSelect');
                const customDateContainer = document.getElementById('customDateContainer');
                
                if (dateRangeSelect && customDateContainer) {
                    dateRangeSelect.addEventListener('change', () => {
                        if (dateRangeSelect.value === 'custom') {
                            customDateContainer.classList.remove('hidden');
                            
                            // Set default date range (last 30 days)
                            const endDate = new Date();
                            const startDate = new Date();
                            startDate.setDate(startDate.getDate() - 30);
                            
                            document.getElementById('startDate').valueAsDate = startDate;
                            document.getElementById('endDate').valueAsDate = endDate;
                        } else {
                            customDateContainer.classList.add('hidden');
                        }
                    });
                }
                
            } catch (error) {
                console.error('Erro ao renderizar relatórios:', error);
                const appView = document.getElementById('app-view');
                appView.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 text-center">
                        <div class="w-16 h-16 bg-red-100 dark:bg-red-900 mx-auto rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-exclamation-triangle text-red-500 dark:text-red-300 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-medium mb-2">Erro ao carregar relatórios</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-4">${error.message || 'Não foi possível gerar os relatórios'}</p>
                        <button onclick="showView('reports')" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                            Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }
        
        function calculateDailyActivity(routes) {
            // Get data for the last 30 days
            const data = [];
            const labels = [];
            const distanceData = [];
            const countData = [];
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);
                
                const nextDay = new Date(date);
                nextDay.setDate(nextDay.getDate() + 1);
                
                const dayRoutes = routes.filter(route => {
                    const routeDate = new Date(route.startTime);
                    return routeDate >= date && routeDate < nextDay;
                });
                
                const dayDistance = dayRoutes.reduce((sum, route) => sum + (route.distance || 0), 0);
                
                distanceData.push(dayDistance.toFixed(1));
                countData.push(dayRoutes.length);
                labels.push(date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
            }
            
            return { labels, distanceData, countData };
        }
        
        function calculateFrontDistribution(routes, harvestFronts) {
            const frontData = harvestFronts.map(front => {
                const frontRoutes = routes.filter(r => r.frontId === front.id);
                const distance = frontRoutes.reduce((sum, route) => sum + (route.distance || 0), 0);
                const duration = frontRoutes.reduce((sum, route) => sum + (route.duration || 0), 0);
                
                return {
                    id: front.id,
                    name: front.name,
                    color: front.color,
                    count: frontRoutes.length,
                    distance: distance,
                    duration: duration
                };
            });
            
            return frontData.sort((a, b) => b.distance - a.distance);
        }
        
        function initDailyActivityChart(dailyActivity) {
            const ctx = document.getElementById('dailyActivityChart');
            if (!ctx) return;
            
            // Detect dark mode for chart colors
            const isDarkMode = document.documentElement.classList.contains('dark');
            
            // Create the chart
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dailyActivity.labels,
                    datasets: [
                        {
                            label: 'Distância (km)',
                            data: dailyActivity.distanceData,
                            backgroundColor: 'rgba(93, 92, 222, 0.5)',
                            borderColor: 'rgba(93, 92, 222, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Número de Rotas',
                            data: dailyActivity.countData,
                            type: 'line',
                            fill: false,
                            borderColor: '#10B981',
                            borderWidth: 2,
                            pointBackgroundColor: '#10B981',
                            pointRadius: 3,
                            tension: 0.2,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: isDarkMode ? '#e5e7eb' : '#374151'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Distância (km)',
                                color: isDarkMode ? '#e5e7eb' : '#374151'
                            },
                            grid: {
                                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDarkMode ? '#e5e7eb' : '#374151'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Número de Rotas',
                                color: isDarkMode ? '#e5e7eb' : '#374151'
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                color: isDarkMode ? '#e5e7eb' : '#374151',
                                precision: 0
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: isDarkMode ? '#e5e7eb' : '#374151',
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
            
            // Store the chart instance for later updates
            window.dailyActivityChart = chart;
            
            // Update chart when dark mode changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                const isDarkMode = document.documentElement.classList.contains('dark');
                
                chart.options.scales.y.grid.color = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                chart.options.scales.y.ticks.color = isDarkMode ? '#e5e7eb' : '#374151';
                chart.options.scales.y.title.color = isDarkMode ? '#e5e7eb' : '#374151';
                chart.options.scales.y1.ticks.color = isDarkMode ? '#e5e7eb' : '#374151';
                chart.options.scales.y1.title.color = isDarkMode ? '#e5e7eb' : '#374151';
                chart.options.scales.x.ticks.color = isDarkMode ? '#e5e7eb' : '#374151';
                chart.options.plugins.legend.labels.color = isDarkMode ? '#e5e7eb' : '#374151';
                
                chart.update();
            });
        }
        
        function initFrontDistributionChart(frontDistribution) {
            const ctx = document.getElementById('frontDistributionChart');
            if (!ctx) return;
            
            // Detect dark mode for chart colors
            const isDarkMode = document.documentElement.classList.contains('dark');
            
            // Prepare data
            const labels = frontDistribution.map(item => item.name);
            const data = frontDistribution.map(item => item.distance);
            const backgroundColors = frontDistribution.map(item => item.color);
            
            // Create the chart
            const chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 1,
                        borderColor: isDarkMode ? '#374151' : '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: isDarkMode ? '#e5e7eb' : '#374151',
                                font: {
                                    size: 12
                                },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value.toFixed(1)} km (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Store the chart instance for later updates
            window.frontDistributionChart = chart;
            
            // Update chart when dark mode changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                const isDarkMode = document.documentElement.classList.contains('dark');
                
                chart.data.datasets[0].borderColor = isDarkMode ? '#374151' : '#ffffff';
                chart.options.plugins.legend.labels.color = isDarkMode ? '#e5e7eb' : '#374151';
                
                chart.update();
            });
        }
        
        function updateReportDateRange() {
            const dateRangeSelect = document.getElementById('dateRangeSelect');
            const customDateContainer = document.getElementById('customDateContainer');
            
            if (dateRangeSelect.value === 'custom') {
                customDateContainer.classList.remove('hidden');
            } else {
                customDateContainer.classList.add('hidden');
            }
            
            // In a real implementation, this would filter the data based on the selected date range
            // and update all the charts and statistics accordingly
            console.log('Date range updated to:', dateRangeSelect.value);
            
            // For demo purposes, show a toast
            showToast('Filtro de data atualizado', 'info');
        }
        
        function updateReportFrontFilter() {
            const frontFilter = document.getElementById('frontFilter');
            
            // In a real implementation, this would filter the data based on the selected front
            // and update all the charts and statistics accordingly
            console.log('Front filter updated to:', frontFilter.value);
            
            // For demo purposes, show a toast
            showToast('Filtro de frente atualizado', 'info');
        }
        
        function printReports() {
            window.print();
        }
        
        function exportReports() {
            // In a real implementation, this would generate a CSV or PDF file
            // with the current report data
            showToast('Exportando relatórios...', 'info');
            
            // For demo purposes, simulate a download after a short delay
            setTimeout(() => {
                showToast('Relatórios exportados com sucesso!', 'success');
            }, 1500);
        }
        
        // ==========================================
        // Helper Functions for Database Operations
        // ==========================================
        
        async function saveHarvestFront(event) {
            event.preventDefault();
            
            try {
                showLoading('Salvando frente de colheita...');
                
                const name = document.getElementById('frontName').value;
                const description = document.getElementById('frontDescription').value;
                const location = document.getElementById('frontLocation').value;
                const colorRadios = document.getElementsByName('frontColor');
                const statusRadios = document.getElementsByName('frontStatus');
                
                // Get selected color
                let color = '#2ecc71'; // Default color
                for (const radio of colorRadios) {
                    if (radio.checked) {
                        color = radio.value;
                        break;
                    }
                }
                
                // Get selected status
                let status = 'active'; // Default status
                for (const radio of statusRadios) {
                    if (radio.checked) {
                        status = radio.value;
                        break;
                    }
                }
                
                const newFront = {
                    name,
                    description,
                    location,
                    color,
                    status,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Add to database
                const id = await db.harvestFronts.add(newFront);
                await addToSyncQueue('add', 'harvestFronts', id, { ...newFront, id });
                
                hideLoading();
                showToast('Frente de colheita adicionada com sucesso!', 'success');
                
                // Navigate to harvest fronts view
                showView('harvest-fronts');
                
            } catch (error) {
                console.error('Erro ao salvar frente de colheita:', error);
                hideLoading();
                showToast('Erro ao salvar frente de colheita: ' + error.message, 'error');
            }
        }
        
        async function updateHarvestFront(event, frontId) {
            event.preventDefault();
            
            try {
                showLoading('Atualizando frente de colheita...');
                
                const name = document.getElementById('frontName').value;
                const description = document.getElementById('frontDescription').value;
                const location = document.getElementById('frontLocation').value;
                const colorRadios = document.getElementsByName('frontColor');
                const statusRadios = document.getElementsByName('frontStatus');
                
                // Get selected color
                let color = '#2ecc71'; // Default color
                for (const radio of colorRadios) {
                    if (radio.checked) {
                        color = radio.value;
                        break;
                    }
                }
                
                // Get selected status
                let status = 'active'; // Default status
                for (const radio of statusRadios) {
                    if (radio.checked) {
                        status = radio.value;
                        break;
                    }
                }
                
                // Check if status is being changed to inactive
                if (status === 'inactive') {
                    // Get original front to check original status
                    const originalFront = await db.harvestFronts.get(frontId);
                    
                    if (originalFront && originalFront.status === 'active') {
                        // Check if there are any active drivers assigned to this front
                        const assignedDrivers = await db.drivers.where({
                            assignedFront: frontId,
                            status: 'active'
                        }).count();
                        
                        if (assignedDrivers > 0) {
                            showConfirmModal(
                                'Motoristas Ativos',
                                `Esta frente possui ${assignedDrivers} motorista(s) ativo(s) atribuído(s). Deseja continuar e inativar a frente mesmo assim?`,
                                async () => {
                                    // Continue with the update
                                    await completeHarvestFrontUpdate(frontId, name, description, location, color, status);
                                }
                            );
                            hideLoading();
                            return;
                        }
                    }
                }
                
                // No confirmation needed, proceed with update
                await completeHarvestFrontUpdate(frontId, name, description, location, color, status);
                
            } catch (error) {
                console.error('Erro ao atualizar frente de colheita:', error);
                hideLoading();
                showToast('Erro ao atualizar frente de colheita: ' + error.message, 'error');
            }
        }
        
        async function completeHarvestFrontUpdate(frontId, name, description, location, color, status) {
            try {
                const updates = {
                    name,
                    description,
                    location,
                    color,
                    status,
                    updatedAt: new Date().toISOString()
                };
                
                // Update in database
                await db.harvestFronts.update(frontId, updates);
                
                const fullFront = await db.harvestFronts.get(frontId);
                await addToSyncQueue('update', 'harvestFronts', frontId, fullFront);
                
                hideLoading();
                showToast('Frente de colheita atualizada com sucesso!', 'success');
                
                // Navigate to harvest fronts view
                showView('harvest-fronts');
                
            } catch (error) {
                console.error('Erro ao concluir atualização da frente:', error);
                hideLoading();
                showToast('Erro ao atualizar frente de colheita: ' + error.message, 'error');
            }
        }
        
        function toggleFrontStatus(frontId, newStatus) {
            showConfirmModal(
                newStatus === 'active' ? 'Ativar Frente' : 'Desativar Frente',
                newStatus === 'active' ? 'Tem certeza que deseja ativar esta frente?' : 'Tem certeza que deseja desativar esta frente?',
                async () => {
                    try {
                        showLoading('Atualizando status...');
                        
                        const updates = {
                            status: newStatus,
                            updatedAt: new Date().toISOString()
                        };
                        
                        // Update in database
                        await db.harvestFronts.update(frontId, updates);
                        
                        const fullFront = await db.harvestFronts.get(frontId);
                        await addToSyncQueue('update', 'harvestFronts', frontId, fullFront);
                        
                        hideLoading();
                        showToast(`Frente ${newStatus === 'active' ? 'ativada' : 'desativada'} com sucesso!`, 'success');
                        
                        // Refresh the current view
                        showView('harvest-fronts', { replace: true });
                        
                    } catch (error) {
                        console.error('Erro ao atualizar status da frente:', error);
                        hideLoading();
                        showToast('Erro ao atualizar status da frente: ' + error.message, 'error');
                    }
                }
            );
        }
        
        function deleteHarvestFront(frontId) {
            showConfirmModal(
                'Excluir Frente',
                'Tem certeza que deseja excluir esta frente de colheita? Esta ação não pode ser desfeita.',
                async () => {
                    try {
                        showLoading('Excluindo frente...');
                        
                        // Check if there are any routes associated with this front
                        const routesCount = await db.routes.where('frontId').equals(frontId).count();
                        
                        if (routesCount > 0) {
                            hideLoading();
                            showConfirmModal(
                                'Rotas Associadas',
                                `Esta frente possui ${routesCount} rota(s) associada(s). Excluir a frente também excluirá todas estas rotas. Deseja continuar?`,
                                async () => {
                                    showLoading('Excluindo frente e rotas associadas...');
                                    
                                    // Delete all associated routes
                                    await db.routes.where('frontId').equals(frontId).delete();
                                    
                                    // Delete the front
                                    await db.harvestFronts.delete(frontId);
                                    
                                    await addToSyncQueue('delete', 'harvestFronts', frontId, { id: frontId });
                                    
                                    hideLoading();
                                    showToast('Frente de colheita e rotas associadas excluídas com sucesso!', 'success');
                                    
                                    // Refresh the current view
                                    showView('harvest-fronts', { replace: true });
                                },
                                'Excluir Tudo',
                                'Cancelar',
                                true
                            );
                            return;
                        }
                        
                        // No routes associated, just delete the front
                        await db.harvestFronts.delete(frontId);
                        
                        await addToSyncQueue('delete', 'harvestFronts', frontId, { id: frontId });
                        
                        hideLoading();
                        showToast('Frente de colheita excluída com sucesso!', 'success');
                        
                        // Refresh the current view
                        showView('harvest-fronts', { replace: true });
                        
                    } catch (error) {
                        console.error('Erro ao excluir frente de colheita:', error);
                        hideLoading();
                        showToast('Erro ao excluir frente de colheita: ' + error.message, 'error');
                    }
                },
                'Excluir',
                'Cancelar',
                true
            );
        }
        
        function recordRoute(frontId) {
            // Navigate to record route view
            showView('record-route', {
                params: { frontId }
            });
        }
        
        function viewRouteDetails(frontId, routeId) {
            // Navigate to route details view
            showView('route-details', {
                params: { frontId, routeId }
            });
        }
        
        function deleteRoute(frontId, routeId) {
            showConfirmModal(
                'Excluir Rota',
                'Tem certeza que deseja excluir esta rota? Esta ação não pode ser desfeita.',
                async () => {
                    try {
                        showLoading('Excluindo rota...');
                        
                        await db.routes.delete(routeId);
                        
                        await addToSyncQueue('delete', 'routes', routeId, { id: routeId });
                        
                        hideLoading();
                        showToast('Rota excluída com sucesso!', 'success');
                        
                        // Go back to routes view
                        showView('routes');
                        
                    } catch (error) {
                        console.error('Erro ao excluir rota:', error);
                        hideLoading();
                        showToast('Erro ao excluir rota: ' + error.message, 'error');
                    }
                },
                'Excluir',
                'Cancelar',
                true
            );
        }
        
        async function saveDriver(event) {
            event.preventDefault();
            
            try {
                showLoading('Salvando motorista...');
                
                const name = document.getElementById('driverName').value;
                const phone = document.getElementById('driverPhone').value;
                const license = document.getElementById('driverLicense').value;
                const experience = document.getElementById('driverExperience').value;
                const vehicleType = document.getElementById('driverVehicleType').value;
                const vehiclePlate = document.getElementById('driverVehiclePlate').value;
                const assignedFront = document.getElementById('driverAssignedFront').value;
                const statusRadios = document.getElementsByName('driverStatus');
                
                // Get selected status
                let status = 'active'; // Default status
                for (const radio of statusRadios) {
                    if (radio.checked) {
                        status = radio.value;
                        break;
                    }
                }
                
                const newDriver = {
                    name,
                    phone,
                    license,
                    experience,
                    vehicleType,
                    vehiclePlate,
                    assignedFront: assignedFront ? parseInt(assignedFront) : null,
                    status,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Add to database
                const id = await db.drivers.add(newDriver);
                
                await addToSyncQueue('add', 'drivers', id, { ...newDriver, id });
                
                hideLoading();
                showToast('Motorista adicionado com sucesso!', 'success');
                
                // Navigate to drivers view
                showView('drivers');
                
            } catch (error) {
                console.error('Erro ao salvar motorista:', error);
                hideLoading();
                showToast('Erro ao salvar motorista: ' + error.message, 'error');
            }
        }
        
        async function updateDriver(event, driverId) {
            event.preventDefault();
            
            try {
                showLoading('Atualizando motorista...');
                
                const name = document.getElementById('driverName').value;
                const phone = document.getElementById('driverPhone').value;
                const license = document.getElementById('driverLicense').value;
                const experience = document.getElementById('driverExperience').value;
                const vehicleType = document.getElementById('driverVehicleType').value;
                const vehiclePlate = document.getElementById('driverVehiclePlate').value;
                const assignedFront = document.getElementById('driverAssignedFront').value;
                const statusRadios = document.getElementsByName('driverStatus');
                
                // Get selected status
                let status = 'active'; // Default status
                for (const radio of statusRadios) {
                    if (radio.checked) {
                        status = radio.value;
                        break;
                    }
                }
                
                const updates = {
                    name,
                    phone,
                    license,
                    experience,
                    vehicleType,
                    vehiclePlate,
                    assignedFront: assignedFront ? parseInt(assignedFront) : null,
                    status,
                    updatedAt: new Date().toISOString()
                };
                
                // Update in database
                await db.drivers.update(driverId, updates);
                
                const fullDriver = await db.drivers.get(driverId);
                await addToSyncQueue('update', 'drivers', driverId, fullDriver);
                
                hideLoading();
                showToast('Motorista atualizado com sucesso!', 'success');
                
                // Navigate to drivers view
                showView('drivers');
                
            } catch (error) {
                console.error('Erro ao atualizar motorista:', error);
                hideLoading();
                showToast('Erro ao atualizar motorista: ' + error.message, 'error');
            }
        }
        
        function editDriver(driverId) {
            // Navigate to edit driver view
            showView('edit-driver', {
                params: { driverId }
            });
        }
        
        function toggleDriverStatus(driverId, newStatus) {
            showConfirmModal(
                newStatus === 'active' ? 'Ativar Motorista' : 'Desativar Motorista',
                newStatus === 'active' ? 'Tem certeza que deseja ativar este motorista?' : 'Tem certeza que deseja desativar este motorista?',
                async () => {
                    try {
                        showLoading('Atualizando status...');
                        
                        const updates = {
                            status: newStatus,
                            updatedAt: new Date().toISOString()
                        };
                        
                        await db.drivers.update(driverId, updates);
                        
                        const fullDriver = await db.drivers.get(driverId);
                        await addToSyncQueue('update', 'drivers', driverId, fullDriver);
                        
                        hideLoading();
                        showToast(`Motorista ${newStatus === 'active' ? 'ativado' : 'desativado'} com sucesso!`, 'success');
                        
                        // Refresh the current view
                        showView('drivers', { replace: true });
                        
                    } catch (error) {
                        console.error('Erro ao atualizar status do motorista:', error);
                        hideLoading();
                        showToast('Erro ao atualizar status do motorista: ' + error.message, 'error');
                    }
                }
            );
        }
        
        function deleteDriver(driverId) {
            showConfirmModal(
                'Excluir Motorista',
                'Tem certeza que deseja excluir este motorista? Esta ação não pode ser desfeita.',
                async () => {
                    try {
                        showLoading('Excluindo motorista...');
                        
                        await db.drivers.delete(driverId);
                        
                        await addToSyncQueue('delete', 'drivers', driverId, { id: driverId });
                        
                        hideLoading();
                        showToast('Motorista excluído com sucesso!', 'success');
                        
                        // Refresh the current view
                        showView('drivers', { replace: true });
                        
                    } catch (error) {
                        console.error('Erro ao excluir motorista:', error);
                        hideLoading();
                        showToast('Erro ao excluir motorista: ' + error.message, 'error');
                    }
                },
                'Excluir',
                'Cancelar',
                true
            );
        }
        
        // ==========================================
        // Farms View Functions
        // ==========================================
        
        async function renderFarmsView() {
            const appView = document.getElementById('app-view');
            
            try {
                // Get farms from database
                const farms = await db.farms.toArray();
                
                appView.innerHTML = `
                    <div class="fade-in">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold">Fazendas Cadastradas</h2>
                            <button onclick="showView('add-farm')" class="flex items-center px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg shadow transition-colors">
                                <i class="fas fa-plus mr-2"></i>
                                Cadastrar Fazenda
                            </button>
                        </div>
                        
                        ${farms.length === 0 ? `
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-8 text-center">
                                <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400">
                                    <i class="fas fa-map-marked-alt text-2xl"></i>
                                </div>
                                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Nenhuma fazenda cadastrada</h3>
                                <p class="text-gray-500 dark:text-gray-400 mb-6">Cadastre sua primeira fazenda importando um arquivo KML.</p>
                                <button onclick="showView('add-farm')" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-primary-700 bg-primary-100 hover:bg-primary-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                    Cadastrar Agora
                                </button>
                            </div>
                        ` : `
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${farms.map(farm => `
                                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden hover:shadow-md transition-shadow">
                                        <div class="h-32 bg-gray-200 dark:bg-gray-700 relative">
                                            <!-- Mini Map Placeholder -->
                                            <div id="farm-map-${farm.id}" class="absolute inset-0 z-0"></div>
                                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-10">
                                                <i class="fas fa-map-marked-alt text-4xl text-gray-400 opacity-50"></i>
                                            </div>
                                        </div>
                                        <div class="p-4">
                                            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1">${farm.name}</h3>
                                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                                                Cadastrada em ${new Date(farm.createdAt).toLocaleDateString()}
                                            </p>
                                            <div class="flex justify-end space-x-2">
                                                <button onclick="deleteFarm(${farm.id})" class="text-red-600 hover:text-red-800 text-sm font-medium">
                                                    Excluir
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                `;
                
                // Initialize mini maps for farms
                if (farms.length > 0) {
                    setTimeout(() => {
                        farms.forEach(farm => {
                            if (farm.geoJson) {
                                try {
                                    const mapId = `farm-map-${farm.id}`;
                                    const mapElement = document.getElementById(mapId);
                                    
                                    if (mapElement) {
                                        const miniMap = L.map(mapId, {
                                            zoomControl: false,
                                            attributionControl: false,
                                            dragging: false,
                                            scrollWheelZoom: false,
                                            doubleClickZoom: false,
                                            boxZoom: false,
                                            keyboard: false
                                        });
                                        
                                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(miniMap);
                                        
                                        const layer = L.geoJSON(farm.geoJson, {
                                            style: {
                                                color: '#10B981', 
                                                weight: 2,
                                                fillOpacity: 0.2
                                            }
                                        }).addTo(miniMap);
                                        
                                        const bounds = layer.getBounds();
                                        if (bounds.isValid()) {
                                            miniMap.fitBounds(bounds, { padding: [10, 10] });
                                        } else {
                                            miniMap.setView([-23.5505, -46.6333], 10);
                                        }
                                        
                                        // Disable interactions
                                        miniMap.touchZoom.disable();
                                    }
                                } catch (e) {
                                    console.error(`Error initializing mini map for farm ${farm.id}:`, e);
                                }
                            }
                        });
                    }, 100);
                }
                
            } catch (error) {
                console.error('Erro ao carregar fazendas:', error);
                showToast('Erro ao carregar lista de fazendas.', 'error');
            }
        }
        
        async function renderAddFarmView() {
            const appView = document.getElementById('app-view');
            
            appView.innerHTML = `
                <div class="fade-in max-w-2xl mx-auto">
                    <div class="mb-6 flex items-center">
                        <button onclick="showView('farms')" class="mr-4 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h2 class="text-2xl font-bold">Cadastrar Nova Fazenda</h2>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                        <form id="addFarmForm" onsubmit="handleSaveFarm(event)">
                            <div class="mb-6">
                                <label for="farmName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nome da Fazenda</label>
                                <input type="text" id="farmName" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white" placeholder="Ex: Fazenda Santa Clara">
                            </div>
                            
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Arquivo KML da Fazenda</label>
                                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 dark:border-gray-600 border-dashed rounded-lg hover:border-primary-500 transition-colors cursor-pointer" onclick="document.getElementById('farmKmlFile').click()">
                                    <div class="space-y-1 text-center">
                                        <i class="fas fa-file-upload text-4xl text-gray-400 mb-3"></i>
                                        <div class="flex text-sm text-gray-600 dark:text-gray-400">
                                            <span class="relative cursor-pointer bg-white dark:bg-gray-800 rounded-md font-medium text-primary-600 hover:text-primary-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary-500">
                                                <span>Upload de arquivo</span>
                                                <input id="farmKmlFile" name="farmKmlFile" type="file" class="sr-only" accept=".kml" onchange="previewFarmKml(event)">
                                            </span>
                                            <p class="pl-1">ou arraste e solte</p>
                                        </div>
                                        <p class="text-xs text-gray-500" id="farmKmlFileName">KML até 10MB</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Map Preview -->
                            <div class="mb-6 hidden" id="farmMapPreviewContainer">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pré-visualização</label>
                                <div id="farm-preview-map" class="h-64 w-full rounded-lg border border-gray-300 dark:border-gray-600"></div>
                            </div>
                            
                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="showView('farms')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700">
                                    Cancelar
                                </button>
                                <button type="submit" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg shadow-md font-medium">
                                    Salvar Fazenda
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
        let currentFarmPreviewMap = null;
        let currentFarmGeoJson = null;

        function previewFarmKml(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('farmKmlFileName').textContent = file.name;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const kmlText = e.target.result;
                    const parser = new DOMParser();
                    const kmlDom = parser.parseFromString(kmlText, 'text/xml');
                    
                    if (kmlDom.getElementsByTagName('parsererror').length > 0) {
                        throw new Error('Arquivo KML inválido');
                    }
                    
                    const geojson = toGeoJSON.kml(kmlDom);
                    currentFarmGeoJson = geojson; // Store for saving
                    
                    // Show map container
                    const container = document.getElementById('farmMapPreviewContainer');
                    container.classList.remove('hidden');
                    
                    // Init map if needed
                    if (!currentFarmPreviewMap) {
                        currentFarmPreviewMap = L.map('farm-preview-map').setView([-23.5505, -46.6333], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; OpenStreetMap contributors'
                        }).addTo(currentFarmPreviewMap);
                    } else {
                        // Clear existing layers
                        currentFarmPreviewMap.eachLayer((layer) => {
                            if (layer instanceof L.GeoJSON) {
                                currentFarmPreviewMap.removeLayer(layer);
                            }
                        });
                    }
                    
                    // Add new layer
                    const layer = L.geoJSON(geojson, {
                        style: {
                            color: '#10B981', // Emerald 500
                            weight: 2,
                            opacity: 0.8,
                            fillOpacity: 0.2
                        }
                    }).addTo(currentFarmPreviewMap);
                    
                    // Fit bounds
                    const bounds = layer.getBounds();
                    if (bounds.isValid()) {
                        currentFarmPreviewMap.fitBounds(bounds);
                        currentFarmPreviewMap.invalidateSize();
                    }
                    
                } catch (error) {
                    console.error('Erro ao ler KML:', error);
                    showToast('Erro ao ler arquivo KML.', 'error');
                }
            };
            reader.readAsText(file);
        }

        async function handleSaveFarm(event) {
            event.preventDefault();
            
            const name = document.getElementById('farmName').value;
            
            if (!name || !currentFarmGeoJson) {
                showToast('Por favor, preencha o nome e importe um KML válido.', 'warning');
                return;
            }
            
            try {
                showLoading('Salvando fazenda...');
                
                const farmData = {
                    name,
                    geoJson: currentFarmGeoJson,
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Save to local DB
                const id = await db.farms.add(farmData);
                
                // Add to sync queue
                await addToSyncQueue('add', 'farms', id, { ...farmData, id });
                
                hideLoading();
                showToast('Fazenda cadastrada com sucesso!', 'success');
                showView('farms');
                
            } catch (error) {
                console.error('Erro ao salvar fazenda:', error);
                hideLoading();
                showToast('Erro ao salvar fazenda.', 'error');
            }
        }

        function deleteFarm(id) {
            confirmModal(
                'Excluir Fazenda',
                'Tem certeza que deseja excluir esta fazenda? Esta ação não pode ser desfeita.',
                async () => {
                    try {
                        showLoading('Excluindo...');
                        
                        await db.farms.delete(id);
                        await addToSyncQueue('delete', 'farms', id, null);
                        
                        hideLoading();
                        showToast('Fazenda excluída com sucesso.', 'success');
                        renderFarmsView(); // Refresh list
                        
                    } catch (error) {
                        console.error('Erro ao excluir fazenda:', error);
                        hideLoading();
                        showToast('Erro ao excluir fazenda.', 'error');
                    }
                }
            );
        }

        // ==========================================
        // Route Recording Functions
        // ==========================================
        
        // KML Import Handler
        function handleKmlImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileNameElement = document.getElementById('kmlFileName');
            if (fileNameElement) fileNameElement.textContent = file.name;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const kmlText = e.target.result;
                    const parser = new DOMParser();
                    const kmlDom = parser.parseFromString(kmlText, 'text/xml');
                    
                    if (kmlDom.getElementsByTagName('parsererror').length > 0) {
                        throw new Error('Arquivo KML inválido');
                    }
                    
                    const geojson = toGeoJSON.kml(kmlDom);
                    
                    if (currentRecording.map) {
                        if (currentRecording.kmlLayer) {
                            currentRecording.map.removeLayer(currentRecording.kmlLayer);
                            currentRecording.kmlLayer = null;
                        }
                        if (currentRecording.suggestedRouteLayer) {
                            currentRecording.map.removeLayer(currentRecording.suggestedRouteLayer);
                            currentRecording.suggestedRouteLayer = null;
                        }
                        
                        currentRecording.kmlLayer = L.geoJSON(geojson, {
                            style: {
                                color: '#ff7800',
                                weight: 5,
                                opacity: 0.65,
                                dashArray: '10, 10'
                            }
                        }).addTo(currentRecording.map);
                        
                        const bounds = currentRecording.kmlLayer.getBounds();
                        if (bounds.isValid()) {
                            currentRecording.map.fitBounds(bounds);
                        }
                        
                        const userLatLng = currentRecording.lastLocation
                            ? L.latLng(currentRecording.lastLocation.lat, currentRecording.lastLocation.lng)
                            : (currentRecording.currentPositionMarker ? currentRecording.currentPositionMarker.getLatLng() : null);
                        
                        function getNearestLatLngFromGeojson(geojsonObj, userLL) {
                            if (!geojsonObj || !geojsonObj.features || !userLL) return null;
                            const points = [];
                            for (const f of geojsonObj.features) {
                                const g = f.geometry;
                                if (!g) continue;
                                if (g.type === 'Point') {
                                    const c = g.coordinates;
                                    points.push(L.latLng(c[1], c[0]));
                                } else if (g.type === 'MultiPoint') {
                                    for (const c of g.coordinates) points.push(L.latLng(c[1], c[0]));
                                } else if (g.type === 'LineString') {
                                    for (const c of g.coordinates) points.push(L.latLng(c[1], c[0]));
                                } else if (g.type === 'MultiLineString') {
                                    for (const line of g.coordinates) for (const c of line) points.push(L.latLng(c[1], c[0]));
                                } else if (g.type === 'Polygon') {
                                    const ring = g.coordinates[0] || [];
                                    for (const c of ring) points.push(L.latLng(c[1], c[0]));
                                } else if (g.type === 'MultiPolygon') {
                                    for (const poly of g.coordinates) {
                                        const ring = poly[0] || [];
                                        for (const c of ring) points.push(L.latLng(c[1], c[0]));
                                    }
                                }
                            }
                            if (points.length === 0) return null;
                            let best = points[0];
                            let bestD = haversineDistance(userLL.lat, userLL.lng, best.lat, best.lng);
                            for (let i = 1; i < points.length; i++) {
                                const p = points[i];
                                const d = haversineDistance(userLL.lat, userLL.lng, p.lat, p.lng);
                                if (d < bestD) {
                                    best = p;
                                    bestD = d;
                                }
                            }
                            return best;
                        }
                        
                        const farmCenter = bounds.isValid() ? bounds.getCenter() : null;
                        const destLatLng = getNearestLatLngFromGeojson(geojson, userLatLng) || farmCenter;
                        
                        if (userLatLng && destLatLng) {
                            const url = `https://router.project-osrm.org/route/v1/driving/${userLatLng.lng},${userLatLng.lat};${farmCenter.lng},${farmCenter.lat}?overview=full&geometries=geojson`;
                            
                            fetch(url)
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Falha ao calcular rota sugerida');
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    if (data && data.routes && data.routes.length > 0) {
                                        const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                                        if (currentRecording.suggestedRouteLayer) {
                                            currentRecording.map.removeLayer(currentRecording.suggestedRouteLayer);
                                            currentRecording.suggestedRouteLayer = null;
                                        }
                                        currentRecording.suggestedRouteLayer = L.polyline(coords, {
                                            color: '#2563EB',
                                            weight: 4,
                                            opacity: 0.9
                                        }).addTo(currentRecording.map);
                                    }
                                })
                                .catch(() => {
                                    if (currentRecording.suggestedRouteLayer) {
                                        currentRecording.map.removeLayer(currentRecording.suggestedRouteLayer);
                                        currentRecording.suggestedRouteLayer = null;
                                    }
                                    currentRecording.suggestedRouteLayer = L.polyline(
                                        [userLatLng, destLatLng],
                                        {
                                            color: '#2563EB',
                                            weight: 4,
                                            opacity: 0.8,
                                            dashArray: '6, 8'
                                        }
                                    ).addTo(currentRecording.map);
                                    showToast('Não foi possível traçar pelas vias. Mostrando linha direta.', 'warning');
                                });
                        }
                        
                        showToast('Rota sugerida importada com sucesso!', 'success');
                    } else {
                        // Queue it for when map initializes
                        currentRecording.pendingKml = geojson;
                        showToast('Mapa será atualizado ao iniciar.', 'info');
                    }
                } catch (error) {
                    console.error('Erro ao importar KML:', error);
                    showToast('Erro ao importar arquivo KML: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function initRecordMap() {
            const mapContainer = document.getElementById('record-map');
            if (!mapContainer) return;
            
            // Initialize map with Leaflet
            // Check if map already exists in container (Leaflet requires this)
            if (currentRecording.map) {
                currentRecording.map.remove();
                currentRecording.map = null;
            }

            const map = L.map(mapContainer).setView([-23.5505, -46.6333], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Create polyline for recording path
            const routePolyline = L.polyline([], {
                color: '#5D5CDE',
                opacity: 1.0,
                weight: 5
            }).addTo(map);
            
            // Store in recording state
            currentRecording.map = map;
            currentRecording.routePolyline = routePolyline;
            
            // Check for pending KML
            if (currentRecording.pendingKml) {
                currentRecording.kmlLayer = L.geoJSON(currentRecording.pendingKml, {
                    style: {
                        color: '#ff7800', // Orange for suggested route
                        weight: 5,
                        opacity: 0.65,
                        dashArray: '10, 10' // Dashed line
                    }
                }).addTo(map);
                
                const bounds = currentRecording.kmlLayer.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds);
                }
                
                currentRecording.pendingKml = null;
            }
            
            // Try to center map on user's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const userLocation = [lat, lng];
                        
                        map.setView(userLocation, 15);
                        
                        // Create marker for current position
                        const marker = L.circleMarker(userLocation, {
                            radius: 10,
                            fillColor: '#5D5CDE',
                            fillOpacity: 0.7,
                            color: '#FFFFFF',
                            weight: 2
                        }).addTo(map);
                        
                        // Create accuracy circle
                        const accuracyCircle = L.circle(userLocation, {
                            radius: position.coords.accuracy,
                            color: '#5D5CDE',
                            weight: 1,
                            opacity: 0.8,
                            fillColor: '#5D5CDE',
                            fillOpacity: 0.1
                        }).addTo(map);
                        
                        currentRecording.currentPositionMarker = marker;
                        currentRecording.accuracyCircle = accuracyCircle;
                        currentRecording.lastLocation = {
                            lat,
                            lng,
                            timestamp: Date.now()
                        };
                        
                        // Update accuracy indicator
                        const accuracyIndicator = document.getElementById('accuracy-indicator');
                        const accuracyValue = document.getElementById('accuracy-value');
                        
                        if (accuracyIndicator && accuracyValue) {
                            accuracyIndicator.classList.remove('hidden');
                            accuracyValue.textContent = Math.round(position.coords.accuracy);
                            
                            // Update GPS quality indicator
                            updateGpsQualityIndicator(position.coords.accuracy);
                        }
                    },
                    error => {
                        console.error('Error getting location:', error);
                        showToast('Erro ao obter localização. Verifique se o GPS está ativado.', 'error');
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                showToast('Geolocalização não disponível neste navegador.', 'error');
            }
        }
        
        function startRecording(frontId) {
            if (currentRecording.recording) {
                showToast('Gravação já em andamento', 'warning');
                return;
            }
            
            if (!navigator.geolocation) {
                showToast('Geolocalização não disponível neste navegador', 'error');
                return;
            }
            
            try {
                // Reset recording state
                currentRecording.frontId = frontId;
                currentRecording.path = [];
                currentRecording.startTime = new Date().toISOString();
                currentRecording.recording = true;
                currentRecording.paused = false;
                currentRecording.elapsedTime = 0;
                currentRecording.name = document.getElementById('routeName').value || '';
                currentRecording.description = document.getElementById('routeDescription').value || '';
                currentRecording.tags = document.getElementById('routeTags').value.split(',')
                    .map(tag => tag.trim())
                    .filter(tag => tag.length > 0);
                
                // Update UI
                document.getElementById('startButton').disabled = true;
                document.getElementById('stopButton').disabled = false;
                document.getElementById('pauseButton').disabled = false;
                document.getElementById('recording-status').classList.remove('hidden');
                
                // Start location tracking
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                };
                
                currentRecording.watchId = navigator.geolocation.watchPosition(
                    updateRecording,
                    handleLocationError,
                    options
                );
                
                // Start timer
                startTimer();
                
                // Setup location error handling
                setupLocationErrorHandling((message) => {
                    showToast(message, 'warning');
                });
                
                // Start battery monitoring
                monitorBatteryStatus();
                
                // Keep screen on if possible
                keepScreenOn(true);
                
                showToast('Gravação iniciada!', 'success');
                
            } catch (error) {
                console.error('Erro ao iniciar gravação:', error);
                showToast('Erro ao iniciar gravação: ' + error.message, 'error');
            }
        }
        
        function updateRecording(position) {
            if (!currentRecording.recording || currentRecording.paused) return;
            
            try {
                // Reset location error counter
                currentRecording.locationErrors = 0;
                clearTimeout(currentRecording.locationErrorTimeout);
                
                // Get position data
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                const speed = position.coords.speed ? position.coords.speed * 3.6 : 0; // Convert m/s to km/h
                
                // Update last location timestamp
                currentRecording.lastLocation = {
                    lat,
                    lng,
                    timestamp: Date.now()
                };
                
                // Create a point object
                const point = {
                    lat,
                    lng,
                    timestamp: new Date().toISOString(),
                    accuracy,
                    speed
                };
                
                // Add point to path
                currentRecording.path.push(point);
                
                // Update polyline on map
                if (currentRecording.routePolyline && currentRecording.map) {
                    const path = currentRecording.path.map(p => [p.lat, p.lng]);
                    currentRecording.routePolyline.setLatLngs(path);
                    
                    // Update current position marker
                    if (currentRecording.currentPositionMarker) {
                        currentRecording.currentPositionMarker.setLatLng([lat, lng]);
                    }
                    
                    // Update accuracy circle
                    if (currentRecording.accuracyCircle) {
                        currentRecording.accuracyCircle.setLatLng([lat, lng]);
                        currentRecording.accuracyCircle.setRadius(accuracy);
                    }
                    
                    // Auto-pan map
                    currentRecording.map.panTo([lat, lng]);
                }
                
                // Calculate distance
                updateRouteDistance();
                
                // Update UI
                const pointsCount = document.getElementById('points-count');
                const currentSpeed = document.getElementById('current-speed');
                const accuracyValue = document.getElementById('accuracy-value');
                
                if (pointsCount) pointsCount.textContent = currentRecording.path.length;
                if (currentSpeed) currentSpeed.textContent = `${speed.toFixed(1)} km/h`;
                if (accuracyValue) accuracyValue.textContent = Math.round(accuracy);
                
                // Update GPS quality indicator
                updateGpsQualityIndicator(accuracy);
                
            } catch (error) {
                console.error('Erro ao atualizar gravação:', error);
            }
        }
        
        function updateRouteDistance() {
            const path = currentRecording.path;
            if (path.length < 2) return;
            
            // Calculate distance between all points
            let totalDistance = 0;
            
            for (let i = 1; i < path.length; i++) {
                const p1 = path[i - 1];
                const p2 = path[i];
                
                const segmentDistance = haversineDistance(p1.lat, p1.lng, p2.lat, p2.lng);
                totalDistance += segmentDistance;
            }
            
            // Update UI
            const distanceCount = document.getElementById('distance-count');
            if (distanceCount) distanceCount.textContent = `${totalDistance.toFixed(1)} km`;
            
            return totalDistance;
        }
        
        function pauseRecording() {
            if (!currentRecording.recording || currentRecording.paused) return;
            
            try {
                // Pause recording
                currentRecording.paused = true;
                
                // Stop timer
                clearInterval(currentRecording.timer);
                
                // Update UI
                document.getElementById('pauseButton').classList.add('hidden');
                document.getElementById('resumeButton').classList.remove('hidden');
                document.getElementById('recording-status').classList.add('hidden');
                
                showToast('Gravação pausada', 'info');
                
            } catch (error) {
                console.error('Erro ao pausar gravação:', error);
                showToast('Erro ao pausar gravação: ' + error.message, 'error');
            }
        }
        
        function resumeRecording() {
            if (!currentRecording.recording || !currentRecording.paused) return;
            
            try {
                // Resume recording
                currentRecording.paused = false;
                
                // Restart timer
                startTimer();
                
                // Update UI
                document.getElementById('pauseButton').classList.remove('hidden');
                document.getElementById('resumeButton').classList.add('hidden');
                document.getElementById('recording-status').classList.remove('hidden');
                
                showToast('Gravação continuada', 'success');
                
            } catch (error) {
                console.error('Erro ao continuar gravação:', error);
                showToast('Erro ao continuar gravação: ' + error.message, 'error');
            }
        }
        
        function stopRecording() {
            if (!currentRecording.recording) return;
            
            showConfirmModal(
                'Parar Gravação',
                'Tem certeza que deseja parar a gravação? Isso salvará a rota atual e finalizará o registro.',
                async () => {
                    try {
                        showLoading('Salvando rota...');
                        
                        // Stop recording
                        currentRecording.recording = false;
                        currentRecording.paused = false;
                        currentRecording.endTime = new Date().toISOString();
                        
                        // Stop location tracking
                        if (currentRecording.watchId) {
                            navigator.geolocation.clearWatch(currentRecording.watchId);
                            currentRecording.watchId = null;
                        }
                        
                        // Stop timer
                        clearInterval(currentRecording.timer);
                        
                        // Clear location error timeout
                        clearTimeout(currentRecording.locationErrorTimeout);
                        
                        // Calculate final distance
                        const distance = updateRouteDistance();
                        
                        // Calculate duration in minutes
                        const startTime = new Date(currentRecording.startTime);
                        const endTime = new Date(currentRecording.endTime);
                        const durationMinutes = (endTime - startTime) / (1000 * 60);
                        
                        // Calculate average speed
                        const averageSpeed = distance > 0 && durationMinutes > 0 ? distance / (durationMinutes / 60) : 0;
                        
                        // Compress path data
                        const compressedPath = compressPathData(currentRecording.path);
                        
                        // Create route object
                        const newRoute = {
                            frontId: currentRecording.frontId,
                            name: currentRecording.name,
                            description: currentRecording.description,
                            path: compressedPath,
                            startTime: currentRecording.startTime,
                            endTime: currentRecording.endTime,
                            status: 'completed',
                            distance: distance,
                            duration: durationMinutes,
                            averageSpeed: averageSpeed,
                            tags: currentRecording.tags,
                            createdAt: currentRecording.startTime,
                            updatedAt: new Date().toISOString()
                        };
                        
                        // Save to database
                        const routeId = await db.routes.add(newRoute);
                        
                        // Add to sync queue for offline support
                        if (!navigator.onLine) {
                            await addToSyncQueue('add', 'routes', routeId, { ...newRoute, id: routeId });
                        }
                        
                        // Allow screen to sleep again
                        keepScreenOn(false);
                        
                        hideLoading();
                        showToast('Rota salva com sucesso!', 'success');
                        
                        // Navigate to route details
                        showView('route-details', {
                            params: {
                                frontId: currentRecording.frontId,
                                routeId: routeId
                            }
                        });
                        
                    } catch (error) {
                        console.error('Erro ao parar gravação:', error);
                        hideLoading();
                        showToast('Erro ao salvar rota: ' + error.message, 'error');
                        
                        // Reset UI
                        document.getElementById('startButton').disabled = false;
                        document.getElementById('stopButton').disabled = true;
                        document.getElementById('pauseButton').disabled = true;
                        document.getElementById('recording-status').classList.add('hidden');
                    }
                }
            );
        }
        
        function handleLocationError(error) {
            // Count consecutive errors
            currentRecording.locationErrors = (currentRecording.locationErrors || 0) + 1;
            
            // Log the error
            console.error('Erro de geolocalização:', error);
            
            // Show error message based on the error code
            let message = 'Erro de geolocalização desconhecido';
            
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Permissão de geolocalização negada';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Informações de localização indisponíveis';
                    break;
                case error.TIMEOUT:
                    message = 'Tempo limite excedido ao obter localização';
                    break;
            }
            
            // Show toast after multiple errors
            if (currentRecording.locationErrors >= 3) {
                showToast(message + '. Verifique se o GPS está ativado.', 'error');
            }
            
            // After 5 consecutive errors, suggest stopping recording
            if (currentRecording.locationErrors >= 5) {
                showConfirmModal(
                    'Problemas com GPS',
                    'Temos enfrentado dificuldades em obter sua localização. Deseja parar a gravação e salvar os dados coletados até agora?',
                    () => stopRecording(),
                    'Parar Gravação',
                    'Continuar Gravação'
                );
            }
        }
        
        function startTimer() {
            // Clear any existing timer
            if (currentRecording.timer) {
                clearInterval(currentRecording.timer);
            }
            
            const timerElement = document.getElementById('recording-time');
            if (!timerElement) return;
            
            // Update every second
            currentRecording.timer = setInterval(() => {
                currentRecording.elapsedTime++;
                
                // Format time
                const hours = Math.floor(currentRecording.elapsedTime / 3600);
                const minutes = Math.floor((currentRecording.elapsedTime % 3600) / 60);
                const seconds = currentRecording.elapsedTime % 60;
                
                const formattedTime = 
                    String(hours).padStart(2, '0') + ':' +
                    String(minutes).padStart(2, '0') + ':' +
                    String(seconds).padStart(2, '0');
                
                timerElement.textContent = formattedTime;
                
            }, 1000);
        }
        
        function centerMapOnCurrentLocation() {
            if (!currentRecording.map || !currentRecording.currentPositionMarker) {
                showToast('Localização atual não disponível', 'warning');
                return;
            }
            
            const position = currentRecording.currentPositionMarker.getPosition();
            if (position) {
                currentRecording.map.setCenter(position);
                currentRecording.map.setZoom(18);
                showToast('Mapa centralizado na posição atual', 'info');
            } else {
                showToast('Localização atual não disponível', 'warning');
            }
        }
        
        // ==========================================
        // Operations Map Functions
        // ==========================================
        
        function initOperationsMap() {
            const mapContainer = document.getElementById('operations-map');
            if (!mapContainer) return;
            
            try {
                // Create map
                if (window.operationsMap) {
                    window.operationsMap.remove();
                    window.operationsMap = null;
                }

                const map = L.map(mapContainer).setView([-15.7801, -47.9292], 5);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // Load active routes and display them on the map
                db.routes.where('status').equals('active').toArray().then(routes => {
                    // Process route paths for any that might be compressed
                    routes.forEach(route => {
                        if (route.path && route.path._compressed) {
                            route.path = decompressPathData(route.path);
                        }
                    });
                    
                    // Load fronts
                    db.harvestFronts.toArray().then(fronts => {
                        // Load farms
                        db.farms.toArray().then(farms => {
                            const bounds = L.latLngBounds([]);
                            let hasVisibleItems = false;
                            
                            // Add farms to map
                            farms.forEach(farm => {
                                if (farm.geoJson) {
                                    try {
                                        const farmLayer = L.geoJSON(farm.geoJson, {
                                            style: {
                                                color: '#10B981', // Emerald 500
                                                weight: 2,
                                                opacity: 0.8,
                                                fillColor: '#34D399', // Emerald 400
                                                fillOpacity: 0.2
                                            },
                                            onEachFeature: (feature, layer) => {
                                                layer.bindTooltip(`Fazenda: ${farm.name}`, { sticky: true });
                                                layer.on('click', () => {
                                                    // Optional: Show farm details
                                                    showToast(`Fazenda: ${farm.name}`, 'info');
                                                });
                                            }
                                        }).addTo(map);
                                        
                                        bounds.extend(farmLayer.getBounds());
                                        hasVisibleItems = true;
                                    } catch (e) {
                                        console.error(`Erro ao adicionar fazenda ${farm.name} ao mapa:`, e);
                                    }
                                }
                            });
                            
                            // Add each route to the map
                            routes.forEach(route => {
                                if (!route.path || route.path.length < 2) return;
                                
                                const front = fronts.find(f => f.id === route.frontId);
                                if (!front) return;
                                
                                // Create polyline for route
                                const routePath = route.path.map(point => [point.lat, point.lng]);
                                
                                // Draw the route
                                const routePolyline = L.polyline(routePath, {
                                    color: front.color,
                                    opacity: 0.8,
                                    weight: 4
                                }).addTo(map);
                                
                                // Add start and end markers
                                const startPoint = routePath[0];
                                const endPoint = routePath[routePath.length - 1];
                                
                                // Start marker
                                L.circleMarker(startPoint, {
                                    radius: 8,
                                    fillColor: front.color,
                                    fillOpacity: 1,
                                    color: '#FFFFFF',
                                    weight: 2
                                }).addTo(map).bindTooltip(`Início: ${route.name || 'Rota sem nome'}`);
                                
                                // End marker
                                L.circleMarker(endPoint, {
                                    radius: 8,
                                    fillColor: '#e74c3c',
                                    fillOpacity: 1,
                                    color: '#FFFFFF',
                                    weight: 2
                                }).addTo(map).bindTooltip(`Fim: ${route.name || 'Rota sem nome'}`);
                                
                                // Extend bounds
                                routePath.forEach(point => bounds.extend(point));
                                hasVisibleItems = true;
                                
                                // Add click listener
                                routePolyline.on('click', () => {
                                    viewRouteDetails(route.frontId, route.id);
                                });
                            });
                            
                            // Fit map to bounds
                            if (hasVisibleItems && bounds.isValid()) {
                                map.fitBounds(bounds, { padding: [30, 30] });
                            } else {
                                // Try to get user's location if nothing visible
                                if (navigator.geolocation) {
                                    navigator.geolocation.getCurrentPosition(
                                        position => {
                                            map.setView([position.coords.latitude, position.coords.longitude], 10);
                                        },
                                        () => { /* Do nothing on error */ }
                                    );
                                }
                            }
                        });
                    });
                });
                
                // Store map in global state
                window.operationsMap = map;
                
            } catch (error) {
                console.error('Erro ao inicializar mapa de operações:', error);
            }
        }
        
        function centerMapOnAllOperations() {
            if (window.operationsMap) {
                // Similar to initOperationsMap but just recenter
                Promise.all([
                    db.routes.where('status').equals('active').toArray(),
                    db.farms.toArray()
                ]).then(([routes, farms]) => {
                    const bounds = L.latLngBounds([]);
                    let hasVisibleItems = false;
                    
                    if (routes.length === 0 && farms.length === 0) {
                        showToast('Nenhuma atividade para mostrar', 'info');
                        return;
                    }
                    
                    // Process route paths for any that might be compressed
                    routes.forEach(route => {
                        if (route.path && route.path._compressed) {
                            route.path = decompressPathData(route.path);
                        }
                    });
                    
                    // Add routes to bounds
                    routes.forEach(route => {
                        if (!route.path || route.path.length < 2) return;
                        
                        const routePath = route.path.map(point => [point.lat, point.lng]);
                        routePath.forEach(point => bounds.extend(point));
                        hasVisibleItems = true;
                    });

                    // Add farms to bounds
                    farms.forEach(farm => {
                        if (farm.geoJson) {
                            try {
                                const layer = L.geoJSON(farm.geoJson);
                                bounds.extend(layer.getBounds());
                                hasVisibleItems = true;
                            } catch (e) {
                                // Ignore errors for bounds calculation
                            }
                        }
                    });
                    
                    if (hasVisibleItems && bounds.isValid()) {
                        window.operationsMap.fitBounds(bounds, { padding: [30, 30] });
                    }
                });
            }
        }
        
        function initRouteDetailsMap(route) {
            const mapContainer = document.getElementById('route-details-map');
            if (!mapContainer || !route.path || route.path.length === 0) return;
            
            try {
                // Check if map already exists
                if (window.routeDetailsMap) {
                    window.routeDetailsMap.remove();
                    window.routeDetailsMap = null;
                }

                // Create map
                const map = L.map(mapContainer).setView([route.path[0].lat, route.path[0].lng], 12);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // Create path for route
                const routePath = route.path.map(point => [point.lat, point.lng]);
                
                // Create polyline for route
                const routePolyline = L.polyline(routePath, {
                    color: '#5D5CDE',
                    opacity: 1.0,
                    weight: 5
                }).addTo(map);
                
                // Add start and end markers
                const startPoint = routePath[0];
                const endPoint = routePath[routePath.length - 1];
                
                const startMarker = L.circleMarker(startPoint, {
                    radius: 10,
                    fillColor: '#4CAF50',
                    fillOpacity: 1,
                    color: '#FFFFFF',
                    weight: 2
                }).addTo(map).bindTooltip('Início');
                
                const endMarker = L.circleMarker(endPoint, {
                    radius: 10,
                    fillColor: '#F44336',
                    fillOpacity: 1,
                    color: '#FFFFFF',
                    weight: 2
                }).addTo(map).bindTooltip('Fim');
                
                // Create bounds and fit map to route
                const bounds = L.latLngBounds(routePath);
                map.fitBounds(bounds, { padding: [50, 50] });
                
                // Add info popups
                const startTime = new Date(route.startTime);
                startMarker.bindPopup(`
                    <div class="p-2">
                        <h3 class="font-medium">Início da Rota</h3>
                        <p>${startTime.toLocaleString()}</p>
                    </div>
                `);
                
                if (route.endTime) {
                    const endTime = new Date(route.endTime);
                    endMarker.bindPopup(`
                        <div class="p-2">
                            <h3 class="font-medium">Fim da Rota</h3>
                            <p>${endTime.toLocaleString()}</p>
                        </div>
                    `);
                }
                
                // Store map in global state
                window.routeDetailsMap = map;
                
            } catch (error) {
                console.error('Erro ao inicializar mapa de detalhes da rota:', error);
            }
        }
        
        // ==========================================
        // Utility Functions
        // ==========================================
        
        function haversineDistance(lat1, lon1, lat2, lon2) {
            // Calculate distance between two points in km using the Haversine formula
            const R = 6371; // Earth radius in km
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        
        function exportRouteData(frontId, routeId) {
            showToast('Preparando exportação...', 'info');
            
            setTimeout(async () => {
                try {
                    const route = await db.routes.get(parseInt(routeId));
                    if (!route) {
                        showToast('Rota não encontrada', 'error');
                        return;
                    }
                    
                    // Decompress path data if needed
                    if (route.path && route.path._compressed) {
                        route.path = decompressPathData(route.path);
                    }
                    
                    // Prepare data for export
                    let exportData;
                    
                    // Choose export format
                    showModal('Exportar Dados da Rota', `
                        <p class="mb-4">Escolha o formato de exportação:</p>
                        <div class="space-y-3">
                            <button id="export-json" class="w-full px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center justify-center">
                                <i class="fas fa-file-code mr-2"></i> JSON
                            </button>
                            <button id="export-csv" class="w-full px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg flex items-center justify-center">
                                <i class="fas fa-file-csv mr-2"></i> CSV
                            </button>
                            <button id="export-gpx" class="w-full px-4 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-lg flex items-center justify-center">
                                <i class="fas fa-file-alt mr-2"></i> GPX
                            </button>
                        </div>
                    `, [
                        { text: 'Cancelar', primary: false }
                    ]);
                    
                    // Add event listeners
                    setTimeout(() => {
                        document.getElementById('export-json').addEventListener('click', () => {
                            // JSON export
                            exportData = JSON.stringify(route, null, 2);
                            downloadFile(exportData, `rota_${routeId}.json`, 'application/json');
                            hideModal();
                        });
                        
                        document.getElementById('export-csv').addEventListener('click', () => {
                            // CSV export
                            const header = 'latitude,longitude,timestamp,accuracy,speed\n';
                            const rows = route.path.map(point => 
                                `${point.lat},${point.lng},${point.timestamp},${point.accuracy || ''},${point.speed || ''}`
                            ).join('\n');
                            
                            exportData = header + rows;
                            downloadFile(exportData, `rota_${routeId}.csv`, 'text/csv');
                            hideModal();
                        });
                        
                        document.getElementById('export-gpx').addEventListener('click', () => {
                            // GPX export
                            const gpxHeader = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="HarvestManager" xmlns="http://www.topografix.com/GPX/1/1">
  <metadata>
    <name>${route.name || `Rota #${routeId}`}</name>
    <desc>${route.description || 'Rota exportada do HarvestManager'}</desc>
    <time>${route.startTime}</time>
  </metadata>
  <trk>
    <name>${route.name || `Rota #${routeId}`}</name>
    <trkseg>`;
                            
                            const gpxPoints = route.path.map(point => 
                                `      <trkpt lat="${point.lat}" lon="${point.lng}">
        <ele>0</ele>
        <time>${point.timestamp}</time>
      </trkpt>`
                            ).join('\n');
                            
                            const gpxFooter = `
    </trkseg>
  </trk>
</gpx>`;
                            
                            exportData = gpxHeader + '\n' + gpxPoints + gpxFooter;
                            downloadFile(exportData, `rota_${routeId}.gpx`, 'application/gpx+xml');
                            hideModal();
                        });
                    }, 100);
                    
                } catch (error) {
                    console.error('Erro ao exportar dados da rota:', error);
                    showToast('Erro ao exportar dados da rota: ' + error.message, 'error');
                }
            }, 500);
        }
        
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast(`Arquivo "${filename}" exportado com sucesso!`, 'success');
            }, 100);
        }
        
        function shareRoute(frontId, routeId) {
            // Since we can't directly share files or data with the Web Share API in this environment,
            // we'll simulate it with a confirmation dialog
            
            showModal('Compartilhar Rota', `
                <p class="mb-4">Escolha como deseja compartilhar a rota:</p>
                <div class="space-y-3">
                    <button id="share-link" class="w-full px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center justify-center">
                        <i class="fas fa-link mr-2"></i> Link para a Rota
                    </button>
                    <button id="share-whatsapp" class="w-full px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg flex items-center justify-center">
                        <i class="fab fa-whatsapp mr-2"></i> WhatsApp
                    </button>
                    <button id="share-email" class="w-full px-4 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg flex items-center justify-center">
                        <i class="fas fa-envelope mr-2"></i> Email
                    </button>
                </div>
            `, [
                { text: 'Cancelar', primary: false }
            ]);
            
            // Add event listeners
            setTimeout(() => {
                document.getElementById('share-link').addEventListener('click', () => {
                    hideModal();
                    showToast('Link da rota copiado para a área de transferência!', 'success');
                });
                
                document.getElementById('share-whatsapp').addEventListener('click', () => {
                    hideModal();
                    showToast('Rota compartilhada via WhatsApp!', 'success');
                });
                
                document.getElementById('share-email').addEventListener('click', () => {
                    hideModal();
                    showToast('Rota compartilhada via Email!', 'success');
                });
            }, 100);
        }
        
        function formatTimeAgo(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            const diffSeconds = Math.floor((now - date) / 1000);
            
            if (diffSeconds < 60) {
                return 'agora';
            } else if (diffSeconds < 3600) {
                const minutes = Math.floor(diffSeconds / 60);
                return `${minutes} min atrás`;
            } else if (diffSeconds < 86400) {
                const hours = Math.floor(diffSeconds / 3600);
                return `${hours} h atrás`;
            } else if (diffSeconds < 604800) {
                const days = Math.floor(diffSeconds / 86400);
                return `${days} dia${days > 1 ? 's' : ''} atrás`;
            } else {
                return date.toLocaleDateString();
            }
        }
        
        function showLoading(message = 'Carregando...') {
            const loadingIndicator = document.getElementById('loading-indicator');
            const loadingText = document.getElementById('loading-text');
            
            if (loadingIndicator && loadingText) {
                loadingText.textContent = message;
                loadingIndicator.classList.remove('hidden');
            }
        }
        
        function hideLoading() {
            const loadingIndicator = document.getElementById('loading-indicator');
            
            if (loadingIndicator) {
                loadingIndicator.classList.add('hidden');
            }
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            if (toast && toastMessage) {
                // Set message
                toastMessage.textContent = message;
                
                // Set icon and color based on type
                const iconElement = toast.querySelector('i.fas');
                
                toast.classList.remove('border-primary-500', 'border-green-500', 'border-yellow-500', 'border-red-500');
                
                if (iconElement) {
                    iconElement.classList.remove('fa-info-circle', 'fa-check-circle', 'fa-exclamation-circle', 'fa-times-circle');
                    
                    switch (type) {
                        case 'success':
                            iconElement.classList.add('fa-check-circle');
                            toast.classList.add('border-green-500');
                            iconElement.className = iconElement.className.replace('text-primary-500', 'text-green-500');
                            break;
                        case 'warning':
                            iconElement.classList.add('fa-exclamation-circle');
                            toast.classList.add('border-yellow-500');
                            iconElement.className = iconElement.className.replace('text-primary-500', 'text-yellow-500');
                            break;
                        case 'error':
                            iconElement.classList.add('fa-times-circle');
                            toast.classList.add('border-red-500');
                            iconElement.className = iconElement.className.replace('text-primary-500', 'text-red-500');
                            break;
                        default: // info
                            iconElement.classList.add('fa-info-circle');
                            toast.classList.add('border-primary-500');
                            iconElement.className = iconElement.className.replace(/text-\w+-500/, 'text-primary-500');
                            break;
                    }
                }
                
                // Show toast
                toast.classList.add('show');
                
                // Hide after 4 seconds
                setTimeout(hideToast, 4000);
            }
        }
        
        function hideToast() {
            const toast = document.getElementById('toast');
            
            if (toast) {
                toast.classList.remove('show');
            }
        }
        
        function startApp() {
            showView('dashboard');
        }
        
        // Dark mode toggle
        function setupDarkModeToggle() {
            // Check for system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
                updateDarkModeIcon(true);
            }
            
            // Set up toggle button
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', () => {
                    document.documentElement.classList.toggle('dark');
                    
                    const isDarkMode = document.documentElement.classList.contains('dark');
                    updateDarkModeIcon(isDarkMode);
                    
                    // Update any charts
                    updateChartsForDarkMode(isDarkMode);
                });
            }
            
            // Listen for system preference changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                const newColorScheme = event.matches ? 'dark' : 'light';
                
                if (newColorScheme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                
                updateDarkModeIcon(newColorScheme === 'dark');
                
                // Update any charts
                updateChartsForDarkMode(newColorScheme === 'dark');
            });
        }
        
        function updateDarkModeIcon(isDarkMode) {
            const icon = document.getElementById('darkModeIcon');
            if (icon) {
                if (isDarkMode) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }
            }
        }
        
        function updateChartsForDarkMode(isDarkMode) {
            // Update all active charts for dark mode
            const charts = [
                window.distanceChart,
                window.dailyActivityChart,
                window.frontDistributionChart
            ];
            
            charts.forEach(chart => {
                if (chart) {
                    // Common updates for charts
                    if (chart.options.scales?.y) {
                        chart.options.scales.y.grid.color = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                        chart.options.scales.y.ticks.color = isDarkMode ? '#e5e7eb' : '#374151';
                    }
                    
                    if (chart.options.scales?.x) {
                        chart.options.scales.x.ticks.color = isDarkMode ? '#e5e7eb' : '#374151';
                    }
                    
                    if (chart.options.plugins?.legend) {
                        chart.options.plugins.legend.labels.color = isDarkMode ? '#e5e7eb' : '#374151';
                    }
                    
                    // Special cases for specific chart types
                    if (chart.data.datasets[0].type === 'doughnut') {
                        chart.data.datasets[0].borderColor = isDarkMode ? '#374151' : '#ffffff';
                    }
                    
                    chart.update();
                }
            });
        }
        
        // User menu
        function setupUserMenu() {
            const userMenuButton = document.getElementById('userMenuButton');
            const userMenu = document.getElementById('userMenu');
            
            if (userMenuButton && userMenu) {
                userMenuButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    userMenu.classList.toggle('hidden');
                    userMenu.classList.toggle('active');
                    
                    // Update aria-expanded
                    const expanded = userMenu.classList.contains('active');
                    userMenuButton.setAttribute('aria-expanded', expanded.toString());
                });
                
                // Close when clicking elsewhere
                document.addEventListener('click', () => {
                    userMenu.classList.add('hidden');
                    userMenu.classList.remove('active');
                    userMenuButton.setAttribute('aria-expanded', 'false');
                });
            }
        }
        
        function updateUserHeader() {
            const name = (AppState.currentUser && AppState.currentUser.name) || (AppState.currentUser && AppState.currentUser.email) || 'Usuário';
            const initial = (name || 'U').trim().charAt(0).toUpperCase();
            const avatarEl = document.getElementById('userAvatarInitial');
            const nameEl = document.getElementById('userDisplayName');
            if (avatarEl) avatarEl.textContent = initial || 'U';
            if (nameEl) nameEl.textContent = name;
        }
    </script>
</body>

</html>
